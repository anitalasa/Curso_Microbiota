<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Analisis comunidades bacterianas – Curso Microbiota</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Curso Microbiota</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Instalacion.html"> 
<span class="menu-text">Introducción a R y RStudio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Estructuras.html"> 
<span class="menu-text">Estructuras de datos</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-análisis-ecológicos" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Análisis ecológicos</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-análisis-ecológicos">    
        <li>
    <a class="dropdown-item" href="./AnalisisBacterias.html">
 <span class="dropdown-text">Bacterias</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./AnalisisHongos.html">
 <span class="dropdown-text">Hongos</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/anitalasa"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://orcid.org/0000-0003-3783-7157"> 
<span class="menu-text"><img src="images/orcid.png" title="ORCID" alt="ORCID" style="height:20px;"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://grupos.eez.csic.es/mae/"> 
<span class="menu-text"><img src="images/internet.png" title="web research group" alt="web research group" style="height:20px;"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#presentación-del-proyecto" id="toc-presentación-del-proyecto" class="nav-link active" data-scroll-target="#presentación-del-proyecto">0. Presentación del proyecto</a></li>
  <li><a href="#instalación-de-paquetes" id="toc-instalación-de-paquetes" class="nav-link" data-scroll-target="#instalación-de-paquetes">1. Instalación de paquetes</a></li>
  <li><a href="#preparación-de-los-datos" id="toc-preparación-de-los-datos" class="nav-link" data-scroll-target="#preparación-de-los-datos">2. Preparación de los datos</a></li>
  <li><a href="#creación-de-objeto-tipo-phyloseq" id="toc-creación-de-objeto-tipo-phyloseq" class="nav-link" data-scroll-target="#creación-de-objeto-tipo-phyloseq">3. Creación de objeto tipo phyloseq</a>
  <ul class="collapse">
  <li><a href="#cargar-un-rda" id="toc-cargar-un-rda" class="nav-link" data-scroll-target="#cargar-un-rda">3.1 Cargar un RDA</a></li>
  </ul></li>
  <li><a href="#curvas-de-rarefacción" id="toc-curvas-de-rarefacción" class="nav-link" data-scroll-target="#curvas-de-rarefacción">4. Curvas de rarefacción</a></li>
  <li><a href="#depuración-de-muestras" id="toc-depuración-de-muestras" class="nav-link" data-scroll-target="#depuración-de-muestras">5. Depuración de muestras</a></li>
  <li><a href="#índices-de-diversidad-alpha" id="toc-índices-de-diversidad-alpha" class="nav-link" data-scroll-target="#índices-de-diversidad-alpha">6. Índices de diversidad alpha</a>
  <ul class="collapse">
  <li><a href="#anális-estadístico" id="toc-anális-estadístico" class="nav-link" data-scroll-target="#anális-estadístico">6.1 Anális estadístico</a>
  <ul class="collapse">
  <li><a href="#comprobación-de-premisas" id="toc-comprobación-de-premisas" class="nav-link" data-scroll-target="#comprobación-de-premisas">6.1.1 Comprobación de premisas</a></li>
  <li><a href="#aplicación-de-test-estadísticos" id="toc-aplicación-de-test-estadísticos" class="nav-link" data-scroll-target="#aplicación-de-test-estadísticos">6.1.2 Aplicación de test estadísticos</a></li>
  <li><a href="#representación-gráfica" id="toc-representación-gráfica" class="nav-link" data-scroll-target="#representación-gráfica">6.1.3 Representación gráfica</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#diversidad-beta" id="toc-diversidad-beta" class="nav-link" data-scroll-target="#diversidad-beta">7. Diversidad beta</a>
  <ul class="collapse">
  <li><a href="#normalización-de-los-datos" id="toc-normalización-de-los-datos" class="nav-link" data-scroll-target="#normalización-de-los-datos">7.1 Normalización de los datos</a></li>
  <li><a href="#comparación-de-diversidad-beta-entre-grupos-de-muestras" id="toc-comparación-de-diversidad-beta-entre-grupos-de-muestras" class="nav-link" data-scroll-target="#comparación-de-diversidad-beta-entre-grupos-de-muestras">7.2 Comparación de diversidad beta entre grupos de muestras</a></li>
  <li><a href="#graficos" id="toc-graficos" class="nav-link" data-scroll-target="#graficos">7.3 Graficos</a></li>
  </ul></li>
  <li><a href="#perfiles-taxonómicos" id="toc-perfiles-taxonómicos" class="nav-link" data-scroll-target="#perfiles-taxonómicos">8. Perfiles taxonómicos</a>
  <ul class="collapse">
  <li><a href="#obtención-de-abundancia-relativa" id="toc-obtención-de-abundancia-relativa" class="nav-link" data-scroll-target="#obtención-de-abundancia-relativa">8.1 Obtención de abundancia relativa</a></li>
  <li><a href="#aglomeración-al-rango-taxonómico-de-estudio" id="toc-aglomeración-al-rango-taxonómico-de-estudio" class="nav-link" data-scroll-target="#aglomeración-al-rango-taxonómico-de-estudio">8.2 Aglomeración al rango taxonómico de estudio</a></li>
  <li><a href="#obtención-de-tablas-exploratorias" id="toc-obtención-de-tablas-exploratorias" class="nav-link" data-scroll-target="#obtención-de-tablas-exploratorias">8.3 Obtención de tablas exploratorias</a></li>
  <li><a href="#preparacion-de-datos-para-realizar-los-gráficos" id="toc-preparacion-de-datos-para-realizar-los-gráficos" class="nav-link" data-scroll-target="#preparacion-de-datos-para-realizar-los-gráficos">8.4 Preparacion de datos para realizar los gráficos</a></li>
  <li><a href="#elaboración-del-gráfico" id="toc-elaboración-del-gráfico" class="nav-link" data-scroll-target="#elaboración-del-gráfico">8.5. Elaboración del gráfico</a></li>
  </ul></li>
  <li><a href="#análisis-de-abundancia-diferencial" id="toc-análisis-de-abundancia-diferencial" class="nav-link" data-scroll-target="#análisis-de-abundancia-diferencial">9. Análisis de abundancia diferencial</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Analisis comunidades bacterianas</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="presentación-del-proyecto" class="level1">
<h1>0. Presentación del proyecto</h1>
<p>En este manual encontrareis todas las directrices para el análisis de las comunidades bacterianas de la endosfera de dos tipos de pinos: pinos con síntomas de decaimiento forestal (NSD) y pinos asintomáticos (ASH). Cada grupo de muestras está formado por 12 réplicas.</p>
</section>
<section id="instalación-de-paquetes" class="level1">
<h1>1. Instalación de paquetes</h1>
<p>Instalaremos varios tipos de paquetes para poder hacer todos nuestros análisis:</p>
<p>-<strong>Rtools</strong>: se trata de una herramienta de Windows necesaria para compilar paquetes en R que están en C/C++, por lo que hay que descargarlo de <a href="https://cran.r-project.org/bin/windows/Rtools/" title="Link para descargar Rtools">este link</a> e instalarlo como un programa de Windows. Por habernos descargado la versión 4.5 de R, tenemos que descargar RTools 4.5</p>
<p>-<strong>BiocManager</strong>: es un paquete de R que permite manejar paquetes del proyecto BioConductor (proyecto colaborativo para el desarrollo de paquetes a usar en análisis bioinformáticos, haz click <a href="https://bioconductor.org/" title="Info sobre el proyecto BioConductor">aquí</a> para conocer más al respecto).</p>
<p>-<strong>Paquetes disponibles en GitHub</strong>: algunos paquetes no se encuentran en el repositorio CRAN ni en BioConductor, sino en GitHub (desarrollados por otros usuarios y puestos allí a disposición de toda la comunidad de R).</p>
<p>-<strong>Paquetes disponibles en CRAN</strong>: paquetes clásicos que se encuentran en el repositorio CRAN.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"devtools"</span>)<span class="co">#es necesario instalarlo para instalar algunos paquetes alojados en GitHub en vez de en CRAN</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(devtools)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="fu">c</span>(<span class="st">"BiocGenerics"</span>, <span class="st">"ANCOMBC"</span>, <span class="st">"phyloseq"</span>,<span class="st">"edgeR"</span>,<span class="st">"microbiome"</span>))<span class="co">#necesarios para que micro4all funcione correctamente</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BiocGenerics)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ANCOMBC)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(phyloseq)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(edgeR)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbiome)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">install_github</span>(<span class="st">"pmartinezarbizu/pairwiseAdonis/pairwiseAdonis"</span>)<span class="co">#descarga desde GitHub</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pairwiseAdonis)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">install_github</span>(<span class="st">"nuriamw/micro4all"</span>)<span class="co">#descarga desde GitHub</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(micro4all)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"ggpubr"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"rstatix"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstatix)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"gdata"</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preparación-de-los-datos" class="level1">
<h1>2. Preparación de los datos</h1>
<p>Ya tenemos las secuencias obtenidas por Illumina MiSeq limpias y filtradas, por lo que se trata de secuencias de calidad. Sin embargo, todavía debemos preparar los datos para su análisis.</p>
<p>En primer lugar, debemos crear una <strong>tabla de metadatos</strong> (se conocen como <em>datos sobre los datos</em>). En ella debemos incluir información sobre nuestras muestras, por ejemplo: la réplica correspondiente, compartimento de la planta, condición del arbol (son/sin síntomas). En proyectos más complejos debemos introducir el máximo de información posible que nos permita agrupar las muestras en diferentes tipos de grupos o categorías, e incluso detectar patrones de asociación desconocidos.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Es importante que en la tabla de metadatos, las muestras estén en el mismo orden que están en la tabla de ASV, y que el nombre de las muestras sea <strong>idéntico</strong> en ambas tablas.</p>
</div>
</div>
<p>En este caso, partiremos de una tabla ya hecha, por lo que solo tendremos que cargarla.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recuerda que antes de empezar a trabajar, debes indicarle cuál es tu directorio de trabajo. Recuerda también introducir la tabla en tu directorio de trabajo, de lo contrario, tendrás que indicarle con código la ruta completa y es más probable cometer errores.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>metadatos <span class="ot">=</span> <span class="fu">read.table</span>(<span class="st">"metadata.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">header=</span><span class="cn">TRUE</span>) </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(metadatos) <span class="ot">=</span> metadatos<span class="sc">$</span>samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creación-de-objeto-tipo-phyloseq" class="level1">
<h1>3. Creación de objeto tipo phyloseq</h1>
<p>Se recomienda crear objetos phyloseq para analizar comunidades microbianas, ya que es el tipo de objeto con el que trabaja el paquete <em>phyloseq</em>.</p>
<p>Los objetos phyloseq se encuentran formados por una tabla de ocurrencias de los ASVs (tabla de ASVs), tabla de taxonomía, metadatos y un árbol filogenético.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recordatorio: el ITS2 fúngico es muy variable en longitud, por lo que no es conveniente calcular árboles filogenéticos basados en esta región. El objeto phyloseq correspondiente, no incluirá el árbol filogenético.</p>
</div>
</div>
<p>Comencemos a crear el objeto phyloseq:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ASV_final<span class="ot">=</span><span class="fu">read.table</span>(<span class="st">"ASV_final_bact.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">header=</span><span class="cn">TRUE</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(ASV_final)<span class="co">#visualizamos la tabla de ASVs para saber en que posiciones (columnas) se encuentra la taxonomia</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>tax <span class="ot">=</span> ASV_final[,<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>] <span class="co">#indicamos las posiciones que ocupa la taxonomia (de Kingdom a ASV)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>ASV <span class="ot">=</span>  ASV_final[,<span class="dv">9</span><span class="sc">:</span><span class="fu">ncol</span>(ASV_final)] <span class="co">#indicamos las posiciones que ocupa la ocurrencia de los ASVs</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>dna <span class="ot">=</span> Biostrings<span class="sc">::</span><span class="fu">DNAStringSet</span>(ASV_final<span class="sc">$</span>ASV_seqs)<span class="co">#guardamos la seq de cada ASV llamando a la funcion DNAStringSet del paquete Biostrings</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">#si tecleamos el 'dna' en la consola veremos el aspecto que tiene. Si nos fijamos bien, veremos que las secuencias las numera de de forma ascendente, pero no sabemos a que ASV corresponde</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dna) <span class="ot">=</span> ASV_final<span class="sc">$</span>ASV_names <span class="co">#asignamos a cada secuencia el nombre del ASV correspondiente</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(tax) <span class="ot">=</span> ASV_final<span class="sc">$</span>ASV_names <span class="co">#hacemos que el nombre de cada linea sea justamente el nombre de los ASV</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(ASV) <span class="ot">=</span> ASV_final<span class="sc">$</span>ASV_names</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">rownames</span>(ASV), <span class="fu">rownames</span>(tax)) <span class="co">#comprobamos que los nombres de las filas son identicos y que corresponden con el nombre de los ASV.</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>phy_tree <span class="ot">=</span>  phyloseq<span class="sc">::</span><span class="fu">read_tree</span>(<span class="st">"phy_tree"</span>) <span class="co">#lectura del árbol</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>unrooted_tree <span class="ot">=</span> phy_tree <span class="co">#cambio de nombre de variable</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">is.rooted</span>(unrooted_tree) <span class="co">#le preguntamos si el arbol está enraizado o no</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>tree_root <span class="ot">=</span> ape<span class="sc">::</span><span class="fu">root</span>(unrooted_tree, <span class="dv">1</span>, <span class="at">resolve.root =</span> T) <span class="co">#enraizamos el arbol y establecemos el outgroup</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">is.rooted</span>(tree_root) <span class="co">#comprobamos que esté enraizado</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>De momento, solamente hemos formateado los objetos, ahora introduciremos los objetos en formato phyloseq</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>phy_OTUtable <span class="ot">=</span> <span class="fu">otu_table</span>(ASV, <span class="at">taxa_are_rows =</span> T)<span class="co">#transforma el objeto 'ASV' en la tabla de ASVs en formato phyloseq</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>phy_taxonomy <span class="ot">=</span> <span class="fu">tax_table</span>(<span class="fu">as.matrix</span>(tax)) <span class="co">#idem con la taxonomia</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>phy_metadata <span class="ot">=</span> <span class="fu">sample_data</span>(metadatos)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#fusionamos todos los objetos para crear el objeto phyloseq definitivo</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>phy <span class="ot">=</span> <span class="fu">phyloseq</span>(phy_OTUtable,phy_taxonomy,phy_metadata,dna,tree_root)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>phy <span class="co">#chequeamos el aspecto que tiene el objeto phyloseq. Es buen momento para comprobar si el número de muestras es el correcto</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="cargar-un-rda" class="level2">
<h2 class="anchored" data-anchor-id="cargar-un-rda">3.1 Cargar un RDA</h2>
<p>Si trabajamos en un servidor y ya hemos creado el objeto phyloseq, y ahora queremos trabajar en nuestro PC, deberíamos cargar el RDA creado previamente. Recordad que el objeto RDA debe estar localizado en nuestro directorio de trabajo (o indicamos la ruta completa donde esté alojado).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"phy.Rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="curvas-de-rarefacción" class="level1">
<h1>4. Curvas de rarefacción</h1>
<p>Las curvas de rarefacción son aquellas en las que se representa el número de ASVs en función del número de secuencias. Nos permiten, pues, tener una idea visual del esfuerzo de muestreo y secuenciación. Es decir, si el muestreo y la subsecuente secuenciación son representativos. Lo serán cuando nuestras curvas se aproximen a un <em>plateau</em> o asíntota (es decir, cuando aumentamos el número de secuencias pero no el de ASV, puesto que estamos cerca al máximo de ASV posible, esto es, el total).</p>
<p>Además, podemos tener una idea de la diferencia en la riqueza de las muestras.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recordatorio: <strong>Riqueza</strong>: número total de ASVs en una muestra</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mt<span class="ot">=</span><span class="fu">as.data.frame</span>(<span class="fu">sample_data</span>(phy))[<span class="fu">order</span>(<span class="fu">as.character</span>(<span class="fu">rownames</span>(<span class="fu">as.data.frame</span>(<span class="fu">sample_data</span>(phy)))),<span class="at">decreasing=</span>F),]<span class="co">#extraemos los metadatos del objeto phyloseq. En realidad, ya los teniamos ('metadatos'), pero puede darse que queramos hacer la rarefaccion de un subgrupo de muestras (por ejemplo, solo de los arboles enfermos)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ASV_phy <span class="ot">=</span> <span class="fu">otu_table</span>(phy)<span class="co">#extraer tabla de ASV</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>ASV_phy_t <span class="ot">=</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(ASV_phy))<span class="co">#hacemos la transpuesta</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>ASV_phy_t<span class="ot">=</span>ASV_phy_t[<span class="fu">order</span>(<span class="fu">as.character</span>(<span class="fu">rownames</span>(ASV_phy_t)),<span class="at">decreasing=</span><span class="cn">FALSE</span>),]<span class="co">#ordenamos la tabla</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ASV_phy_t)<span class="sc">==</span><span class="fu">rownames</span>(mt) <span class="co">#debe ser TRUE, de lo contrario algo hemos hecho mal</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ASV_phy_t)<span class="ot">=</span><span class="fu">paste0</span>(<span class="fu">rownames</span>(ASV_phy_t),<span class="st">"/"</span>,mt<span class="sc">$</span>status)<span class="co">#cambiamos el nombre de cada linea (muestra) tal que tengamos fusionada la condicion de cada arbol</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>sample_names <span class="ot">=</span> <span class="fu">rownames</span>(ASV_phy_t)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">rarecurve</span>(ASV_phy_t , <span class="at">step =</span> <span class="dv">100</span>, <span class="at">label =</span> F) <span class="co">#rarefaccion. La calculamos cogiendo bunchs de secuencias de 100 en 100</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#en este punto debemos mirar qué clase de objeto ha generado y qué contiene</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">#transformamos el objeto out</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>rare <span class="ot">=</span> <span class="fu">lapply</span>(out, <span class="cf">function</span>(x){  <span class="co">#lapply aplica la función que indiquemos a todos los elementos de la lista</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">=</span> <span class="fu">as.data.frame</span>(x)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">ASV =</span> b[,<span class="dv">1</span>], <span class="at">raw.read =</span> <span class="fu">rownames</span>(b))<span class="co">#me crea un dataframe con dos columnas, 'ASV' y 'raw.read' </span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  b<span class="sc">$</span>raw.read <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"N"</span>, <span class="st">""</span>,  b<span class="sc">$</span>raw.read))<span class="co">#raw.read contiene el numero de secuencias</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(b)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(rare) <span class="ot">=</span> sample_names</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>rare <span class="ot">=</span> <span class="fu">map_dfr</span>(rare, <span class="cf">function</span>(x){<span class="co">#añadimos a cada elemento de la lista una columna llamada 'Sample'</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  z<span class="ot">=</span> <span class="fu">data.frame</span>(x)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(z)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>}, <span class="at">.id =</span> <span class="st">"Sample"</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co">#modificamos el objeto para adecuar la representacion grafica</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>rare<span class="sc">$</span>status<span class="ot">=</span>rare<span class="sc">$</span>Sample <span class="co">#creamos una nueva variable que contiene el nombre de las muestras</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>rare<span class="sc">$</span>status<span class="ot">=</span><span class="fu">gsub</span>(<span class="st">".*/"</span>, <span class="st">""</span>, rare<span class="sc">$</span>status)<span class="co">#eliminamos todo aquello que precede a '/'</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>rare<span class="sc">$</span>raw.read<span class="ot">=</span><span class="fu">as.numeric</span>(rare<span class="sc">$</span>raw.read)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ahora, por fin, podemos hacer el gráfico correspondiente</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plot_rarefac<span class="ot">=</span><span class="fu">ggplot</span>(rare, <span class="fu">aes</span>(<span class="at">x=</span>raw.read, <span class="at">y=</span>ASV, <span class="at">colour=</span>status, <span class="at">group=</span>Sample)) <span class="sc">+</span><span class="co">#coloreamos por status de los árboles</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour=</span>status), <span class="at">size=</span><span class="fl">0.85</span>)<span class="sc">+</span><span class="co">#una linea es trazada por una sucesion de muchos puntos, por lo que los puntos los pintamos por status de los arboles</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">colour=</span>status),<span class="at">linewidth=</span><span class="fl">1.2</span>)<span class="sc">+</span><span class="co">#la linea que une los puntos también</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">min</span>(<span class="fu">sample_sums</span>(phy_pruned))), <span class="at">lty=</span><span class="dv">1</span>, <span class="at">colour=</span><span class="st">"black"</span>)<span class="sc">+</span>  <span class="co">#representamos una line vertical en x=minimo numero de secuencias</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"healthy"</span><span class="ot">=</span><span class="st">"green"</span>,<span class="st">"diseased"</span><span class="ot">=</span><span class="st">"black"</span>))<span class="sc">+</span> <span class="co">#ponemos los colores concretos que queramos, por condicion de los arboles</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"healthy"</span><span class="ot">=</span><span class="st">"green"</span>, <span class="st">"diseased"</span><span class="ot">=</span><span class="st">"black"</span>),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">name=</span><span class="st">"Tree status"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks=</span><span class="fu">c</span>(<span class="st">"healthy"</span>, <span class="st">"diseased"</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>, <span class="st">"Symptomatic"</span>))<span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span> <span class="st">"Rarefaction curves"</span>, <span class="at">x=</span><span class="st">"Number of sequences"</span>, <span class="at">y=</span><span class="st">"Number of ASV"</span>)<span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">alpha=</span>none)<span class="sc">+</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key=</span><span class="fu">element_blank</span>(),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>,<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>, <span class="at">size=</span><span class="dv">16</span>),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para poder visualizar el gráfico, podemos abrir una nueva pantalla de la siguiente forma:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">x11</span>()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>plot_rarefac<span class="co"># ¡OJO! Debemos seleccionar estas dos líneas y correrlas juntas. Si se sucesivamente (de una en una), no visualizaremos el gráfico</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Si queremos guardar el gráfico con alta calidad en nuestro directorio de trabajo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename =</span> <span class="st">"Rarefaccion_curve.jpg"</span>, <span class="at">plot =</span> plot_rarefac,<span class="at">device =</span> <span class="fu">tiff</span>(),<span class="at">width =</span> <span class="dv">18</span>, <span class="at">height =</span> <span class="dv">16</span>, <span class="at">units =</span> <span class="st">"cm"</span>, <span class="at">dpi =</span> <span class="dv">800</span>)<span class="co">#aqui podemos indicarle el tamaño y resolucion que queramos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La figura obtenida es exactamente la Figura 1.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Rarefaccion_curve.jpg" class="img-fluid figure-img"></p>
<figcaption>Figura 1. Curvas de rarefacción de las muestras correspondientes a los árboles sanos y enfermos.</figcaption>
</figure>
</div>
<p>¿Qué podemos deducir de estas curvas de esfuerzo? ¿La profundidad de la secuenciación es suficiente? ¿Tienen todas las muestras la misma riqueza?</p>
</section>
<section id="depuración-de-muestras" class="level1">
<h1>5. Depuración de muestras</h1>
<p>Como hemos visto en la Figura 1, hay muestras con un bajo número de secuencias, especialmente en el caso de los árboles asintomáticos. Podemos realizar un filtrado y eliminar dichas muestras</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Lo primero será revisar el número de secuencias de cada muestra</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>numsec<span class="ot">=</span><span class="fu">as.data.frame</span>(<span class="fu">colSums</span>(<span class="fu">otu_table</span>(phy)))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(numsec)<span class="co">#podemos ordenar la tabla de menor a mayor para ver qué muestras son aquellas con baja profundidad de secuenciación</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>numsec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tal y como vemos, la muestra ‘prASH10E’ tan solo tiene 576 muestras de calidad. Es un número muy bajo, por lo que procedemos a eliminarla.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>phy_pruned<span class="ot">=</span><span class="fu">subset_samples</span>(phy, samples <span class="sc">!=</span> <span class="st">"prASH10E"</span>)<span class="co">#eliminamos la muestra y creamos un nuevo objeto phyloseq</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>numsec_pruned<span class="ot">=</span><span class="fu">as.data.frame</span>(<span class="fu">colSums</span>(<span class="fu">otu_table</span>(phy_pruned)))<span class="co">#revisamos de nuevo el numero de secuencias</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(numsec_pruned)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">" "</span><span class="ot">=</span><span class="fu">rownames</span>(numsec_pruned),numsec_pruned),<span class="at">file=</span><span class="st">"NumerofWorkingSequences_Bacteria.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)<span class="co">#guardamos con el formato adecuado</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En este punto, debemos volver a calcular las curvas de rarefacción para ver cómo han quedado</p>
<p>Ejercicio: calcularlas de nuevo</p>
<p>En la Figura 2 se puede observar el resultado</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Rarefaccion_curve_pruned.jpg" class="img-fluid figure-img"></p>
<figcaption>Figura 2. Curvas de rarefacción de las muestras correspondientes a los árboles sanos y enfermos, tras eliminar una muestra.</figcaption>
</figure>
</div>
</section>
<section id="índices-de-diversidad-alpha" class="level1">
<h1>6. Índices de diversidad alpha</h1>
<p>La <strong>diversidad alpha</strong> es la diversidad existente en cada muestra (o grupo de muestras), es decir, a escala local. Para medirla, se emplean diferentes índices de diversidad, riqueza y equidad:</p>
<p>-<strong>Riqueza observada</strong>: se trata del número de especies diferentes presentes en una muestra. No tiene en cuenta la abundancia de cada una. Se suele emplear directamente el conteo de ASVs totales.</p>
<p>-<strong>Índice de Shannon (H’)</strong>: Se calcula tal y como se especifica en la Ecuación 1.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Shannon.jpg" class="img-fluid figure-img"></p>
<figcaption>Ecuación 1. Índice de Shannon (H’), donde S es el número de especies diferentes, pi es la frecuencia de la especie i respecto al total de individuos (abundancia relativa).</figcaption>
</figure>
</div>
<p>El índice de Shannon tiene pues en cuenta tanto la riqueza como la abundancia relativa de cada una de las especies, y por lo tanto, se ve influido por la profundidad de secuenciación, y es sensible a las especies raras o poco abundantes.</p>
<p>-<strong>Inversa de Simpson</strong>: Se calcula tal y como se indica en la Ecuación 2. Es también sensible a la profundidad de muestreo, pero no se ve tan influenciado por la presencia de especies raras.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/InvSimpson.jpg" class="img-fluid figure-img"></p>
<figcaption>Ecuación 2. Índice Inverson de Simpson (D), donde lambda es el índice de Simpson, y R la riqueza total.</figcaption>
</figure>
</div>
<p>-<strong>Equidad</strong> o <strong>Índice de Pielou (J’)</strong>: Se calcula diviendo el valor del índice de Shannon entre el logaritmo de la riqueza (J’= Shannon/ln R). Sus valores se encuentran comprendidos en el rango [0,1]. Nos indica cómo se encuentran distribuidas las especies: valores cercanos a 0 nos indican que en la muestra existe <strong>dominancia</strong>, es decir, la abundancia de unas especies es muy elevada (y por lo tanto, no todas las especies están igualmente distribuidas). Valores próximos a 1 nos dicen que en la muestra todas las especies tienen una abundancia relativa similar, por lo que están igualmente distribuidas y la muestra es equitativa.</p>
<p>Existen muchos otros índices alpha, pero estos son los más empleados e informativos.</p>
<p>Puesto que el valor de algunos índices varía en función de la profundidad de muestreo, debemos hacer una <strong>rarefacción</strong> de los datos. Es decir, debemos hacer un sub-muestreo y obtener subconjuntos de muestras que tengan el mismo número de secuencias. Haremos una rarefacción a la baja.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)<span class="co">#establecemos un valor de semilla para que los resultados sean reproducibles</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>rarefaction <span class="ot">=</span> <span class="fu">rarefy_even_depth</span>(phy_pruned, <span class="at">sample.size =</span> <span class="fu">min</span>(<span class="fu">sample_sums</span>(phy_pruned)), <span class="at">rngseed =</span> <span class="cn">FALSE</span>) <span class="co">#nos devuelve un objeto phyloseq</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Calculamos los índices alpha a partir de objeto phyloseq rarificado:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>indices<span class="ot">=</span><span class="fu">estimate_richness</span>(rarefaction, <span class="at">measures=</span><span class="fu">c</span>(<span class="st">"Observed"</span>, <span class="st">"InvSimpson"</span>, <span class="st">"Shannon"</span>))<span class="co">#funcion de phyloseq que calcula los indices que le indiquemos, replica a replica</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>indices<span class="sc">$</span>Pielou<span class="ot">=</span>indices<span class="sc">$</span>Shannon<span class="sc">/</span><span class="fu">log</span>(indices<span class="sc">$</span>Observed)<span class="co">#calculamos manualmente el valor de Pielou</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>mt_indices<span class="ot">=</span><span class="fu">data.frame</span>(<span class="fu">sample_data</span>(rarefaction))<span class="co">#extraemos la tabla de metadatos del objeto rarificado</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>indices<span class="ot">=</span><span class="fu">add_column</span>(indices, mt_indices[<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(mt_indices)], <span class="at">.after =</span>  <span class="st">"Pielou"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Asi le estoy pegando a la tabla de indices todos los metadatos. Indicamos que queremos que los añada antes de la columna 'Observed'</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">#write.table(data.frame(" "=rownames(indices),indices),file="Indices_porReplicas.txt", sep="\t",row.names =F) Por si queremos guardar la tabla.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Hemos calculado los índices de cada réplica, pero nos interesa más calcular la media de cada grupo de muestras y la desviación estándar para poder compararlos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#¡¡OJO!! En la línea siguiente debemos indicar la posición de las columnas en las que están los valores de los indices. Recordatorio: es un dataframe que contiene caaracteres y numericos.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Para identificar esas posiciones, basta con hacer View(indices)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>media<span class="ot">=</span> <span class="fu">aggregate</span>(indices[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="fu">list</span>(<span class="at">grouping=</span>indices<span class="sc">$</span>status), mean) <span class="sc">%&gt;%</span> <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits=</span><span class="dv">2</span>)<span class="co">#calcula la media en base al status de los árboles, y el resultado lo redondea con dos digitos</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>sd<span class="ot">=</span> <span class="fu">aggregate</span>(indices[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="fu">list</span>(<span class="at">grouping=</span>indices<span class="sc">$</span>status), sd) <span class="sc">%&gt;%</span> <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Si nos interesa generar una tabla con formato de publicación (es decir, donde los valores de la media vienen seguidos del simbolo +- y la desviación estándar), podemos ejecutar estas líneas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mean_sd <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>){ <span class="co">#OJO aqui con el numero de las columnas numericas de los objetos 'mean' y 'sd'.Para comprobarlo, View(mean)</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  mean_sd <span class="ot">=</span> <span class="fu">cbind</span>(mean_sd,<span class="fu">paste0</span>(media[,i], <span class="st">" +/- "</span>, sd[,i]))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>tabla_publicaciones <span class="ot">=</span> <span class="fu">cbind</span>(media<span class="sc">$</span>grouping, mean_sd)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tabla_publicaciones) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Group"</span>,<span class="st">"Observed"</span>, <span class="st">"Shannon"</span>, <span class="st">"InvSimpson"</span>, <span class="st">"Pielou"</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(tabla_publicaciones)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(tabla_publicaciones,<span class="at">file=</span><span class="st">"Indices_Media_sd.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="anális-estadístico" class="level2">
<h2 class="anchored" data-anchor-id="anális-estadístico">6.1 Anális estadístico</h2>
<p>Aplicaremos tests de estadística univariante para cada uno de los índices. Compararemos si los índices de los dos grupos de muestras son iguales o no. Para este análisis, utilizaremos un nivel de confianza de = 95%, por lo tomaremos un alpha = 0.05.</p>
<p>Para ello, primero debemos conocer el tipo de distribución de los datos, y elegir el mejor test a aplicar.</p>
<section id="comprobación-de-premisas" class="level3">
<h3 class="anchored" data-anchor-id="comprobación-de-premisas">6.1.1 Comprobación de premisas</h3>
<p>Comenzamos aplicando el <em>test de Levene</em> con el que evaluamos si la varianza de los dos grupos a comparar es la misma o no (<em>homocedasticidad</em>). H0: los dos grupos de muestran son homocedásticos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>levene <span class="ot">=</span> <span class="fu">levene.test.alpha</span>(indices, <span class="dv">4</span>, <span class="st">"status"</span>) </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#argumentos: </span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">#tabla de indices calculados replica a replica (NO confundir con la tabla de publicaciones)</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#número de indices a testar</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">#nombre de la variable de agrupacion (tiene que coincidir exactamente con el nombre incluido en la tabla de indices)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Observamos que para ningún índice obtenemos un pvalor superior al umbral alpha seleccionado, luego nos encontramos ante datos homocedásticos</p>
<p>Comprobamos si los datos se distribuyen de forma normal [Gaussiana], mediante el <strong>test de Shapiro-Wilks</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>shapiro <span class="ot">=</span> <span class="fu">Shapiro</span>(indices, <span class="dv">4</span>, <span class="st">"status"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>shapiro</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Vemos que tan solo el índice de riqueza se distribuye de forma normal. Nos encontramos pues ante variables homocedásticas de distribución no-normal (excepto la riqueza observada).</p>
<p>Los test estadísticos univariantes son muy sensibles a la heterocedasticidad, pero no tanto a la distribución no-normal de los datos. Puesto que todas nuestras variables son homocedásticas, comprobemos si los datos se alejan mucho de una distribución normal. Para ello, construiremos <strong>gráficos de tipo Q-Q</strong> (<em>quantile-quantile plot</em>), que nos comparan la distribución de nuestros datos vs una normal teórica:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>qq_invsimpson<span class="ot">=</span><span class="fu">ggqqplot</span>(indices, <span class="st">"InvSimpson"</span>, <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>())</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>qq_sha<span class="ot">=</span><span class="fu">ggqqplot</span>(indices, <span class="st">"Shannon"</span>, <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>())</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>qq_pielou<span class="ot">=</span><span class="fu">ggqqplot</span>(indices, <span class="st">"Pielou"</span>, <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En las Figuras 3-5 podemos ver la distribución de las variables. Apreciamos que no se separan mucho de la normalidad teórica, por lo que aplicaremos test univariantes paramétricos.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/qq_inv.jpg" class="img-fluid figure-img"></p>
<figcaption>Figura 3. Gráfico Q-Q del Inverso de Simpson.</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/qq_shannon.jpg" class="img-fluid figure-img"></p>
<figcaption>Figura 4. Gráfico Q-Q del índice de Shannon</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/qq_pielou.jpg" class="img-fluid figure-img"></p>
<figcaption>Figura 5. Gráfico Q-Q del índice de Pielou.</figcaption>
</figure>
</div>
</section>
<section id="aplicación-de-test-estadísticos" class="level3">
<h3 class="anchored" data-anchor-id="aplicación-de-test-estadísticos">6.1.2 Aplicación de test estadísticos</h3>
<p>Puesto que queremos comparar dos grupos de muestras, y teniendo en cuenta los comentarios realizados sobre la distribución de las muestras, aplicaremos el <strong>test t-Student</strong> a todos los índices. H0: no hay diferencias en la media de los dos grupos</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tstudent <span class="ot">=</span><span class="fu">Tukey.test</span>(indices, <span class="dv">4</span>, <span class="st">"status"</span>, <span class="at">balanced=</span>F)<span class="co"># Incorpora un argumento más, 'balanced', de tipo booleriano. En este caso, puesto que tenemos un ligero desbalance en los datos, le decimos que FALSE</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>tstudent</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En la tabla de salida apreciamos que el pvalor en todos los casos es &lt; 0.05, por lo que rechazamos la hipótesis nula, determinando que la diversidad, riqueza y equidad de los árboles sanos y enfermos es significativamente diferente.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>MUY IMPORTANTE</strong>: cada variable debe inspeccionarse y tratarse de forma independiente. En este caso, hemos detectado que casi todas las variables se distribuyen de la misma manera, por lo que hemos usado la función <em>Tukey.test</em> del paquete micro4all, que aplica el mismo test a todas las variables incluidas en nuestra table. Si cada una de nuestras variables tiene una distribución o características concretas (paramétrica, heterocedástica, no-paramétrica), debemos aplicar el test más adecuado para cada variable. En ese caso, no es recomendable emplear las funciones incluidas en el paquete micro4all, sino las incluidas en el paquete <strong>rstatix</strong>, tratando cada una de forma independiente.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Es <strong>importante</strong> tener en cuenta que el hecho de que tengamos un pvalor muy bajo <strong>NO</strong> significa que las diferencias observadas sean grandes. Para obtener información sobre la magnitud de las diferencias, calculamos el <strong>tamaño del efecto</strong>, que, al tratarse de comparaciones de dos grupos, debemos calcular la <strong>d de Cohen</strong> (<em>Cohen’s d</em>).</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#hacemos un bucle for sobre la funcion cohens_d </span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>cohen <span class="ot">=</span><span class="fu">data.frame</span>()</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>columnas <span class="ot">=</span><span class="fu">names</span>(indices)[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]  <span class="co">#que coja los nombres de las 1as 4 columnas donde estan los indices</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> columnas) {</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">=</span> <span class="fu">cohens_d</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(i, <span class="st">"~ status"</span>)), <span class="at">data =</span> indices)<span class="sc">$</span>effsize</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  mag <span class="ot">=</span> <span class="fu">cohens_d</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(i, <span class="st">"~ status"</span>)), <span class="at">data =</span> indices)<span class="sc">$</span>magnitude</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  cohen <span class="ot">=</span> <span class="fu">rbind</span>(cohen, <span class="fu">data.frame</span>(<span class="at">variable =</span> i, <span class="at">cohen_d =</span> d, <span class="at">magnitude=</span>mag))</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>cohen<span class="co">#nos devuelve la variable y el tamaño del efecto. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El tamaño del efecto se clasifica en categorías en función del valor de la d de Cohen:</p>
<p>si d &lt; 0.2 –&gt; no efecto si 0.21 &lt; d &lt; 0.49 –&gt; efecto pequeño si 0.5 &lt; d &lt; 0.8 –&gt; efecto moderado si d &gt; 0.8 –&gt; efecto grande</p>
<p>Por lo tanto, para todos nuestros indices, las diferencias observadas podemos clasificarlas como ‘Grandes’</p>
</section>
<section id="representación-gráfica" class="level3">
<h3 class="anchored" data-anchor-id="representación-gráfica">6.1.3 Representación gráfica</h3>
<p>Los valores de los índices en tablas son muy útiles pero, una imagen vale más que mil palabras. Se pueden hacer distintos tipos de gráficos, pero haremos boxplots ya que nos dan una idea de la dispersión de cada uno de los índices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>alpha_plot_table<span class="ot">=</span>tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">data =</span> indices, <span class="at">names_to =</span> <span class="st">"Measure"</span>, <span class="at">values_to =</span> <span class="st">"Value"</span>, <span class="at">cols=</span><span class="fu">c</span>(Observed, Shannon, InvSimpson, Pielou))<span class="co">#esta funcion sirve para que tranforme la tabla y todos los valores de todos los índices estén en una sola columna, apilados.</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>alpha_graphic<span class="ot">=</span><span class="fu">ggplot</span>(<span class="at">data =</span> alpha_plot_table, <span class="fu">aes</span>(<span class="at">x =</span> status, <span class="at">y =</span> Value)) <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">factor</span>(Measure, <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"Observed"</span>, <span class="st">"InvSimpson"</span>,<span class="st">"Shannon"</span>, <span class="st">"Pielou"</span>)), <span class="at">scale =</span> <span class="st">"free"</span>) <span class="sc">+</span> <span class="co">#generamos una grafica por índice</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="st">"healthy"</span>,<span class="st">"diseased"</span>), </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>,<span class="st">"Symptomatic"</span>)) <span class="sc">+</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">fill=</span>status)<span class="sc">+</span> </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"healthy"</span><span class="ot">=</span><span class="st">"green"</span>,<span class="st">"diseased"</span><span class="ot">=</span><span class="st">"black"</span>),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks=</span><span class="fu">c</span>(<span class="st">"healthy"</span>,<span class="st">"diseased"</span>), </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>,<span class="st">"Symptomatic"</span>),<span class="at">na.translate=</span><span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">'cm'</span>)) <span class="sc">+</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(<span class="st">"Endosphere ("</span> <span class="sc">*</span><span class="fu">italic</span>(<span class="st">"P. sylvestris"</span>)<span class="sc">*</span> <span class="st">")"</span>))<span class="sc">+</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">13</span>),</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>), </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position=</span><span class="st">"bottom"</span>,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co">#x11() #comentando x11() logramos que el grafico se vea en el visualizador de graficos, en el panel derecho --&gt;</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>alpha_graphic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="diversidad-beta" class="level1">
<h1>7. Diversidad beta</h1>
<p>Para conocer la diversidad de cada grupo de muestras y de forma relativa al resto de grupo de muestras, calcularemos la <strong>diversidad beta</strong>. Es un tipo de diversidad <em>regional</em>.</p>
<p>En este apartado, calcularemos la diversidad, la representaremos gráficamente y la compararemos mediante métodos de estadística multivariante.</p>
<section id="normalización-de-los-datos" class="level2">
<h2 class="anchored" data-anchor-id="normalización-de-los-datos">7.1 Normalización de los datos</h2>
<p>Nuestra tabla de ASVs original está constituida por el número de ocurrencias de cada ASV en cada muestra (número de secuencias de cada ASV). Podemos tener ASVs para los que se han detectado 5 secuencias, y otros representados por 5000 secuencias. Es necesario <strong>escalar</strong> los valores y transformarlos todos al mismo rango. Existen diferentes tipos de normalizaciones para evitar estos posibles sesgos, como la transformación logarítmica, o la normalización que aplica EdgeR. Emplearemos esta por su popularidad:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Lo primero es obtener nuevos objetos phyloseq normalizados</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>ASV_pruned<span class="ot">=</span><span class="fu">data.frame</span>(<span class="fu">otu_table</span>(phy_pruned,<span class="at">taxa_are_rows =</span> T))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>mt_pruned<span class="ot">=</span><span class="fu">data.frame</span>(<span class="fu">sample_data</span>(phy_pruned))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>tax_pruned<span class="ot">=</span><span class="fu">data.frame</span>(<span class="fu">tax_table</span>(phy_pruned))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>tree_pruned<span class="ot">=</span><span class="fu">phy_tree</span>(phy_pruned)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Creamos un objeto DGE necesario para hacer la normalizacion</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>edgeR <span class="ot">=</span> <span class="fu">DGEList</span>(<span class="at">counts =</span> ASV_pruned, <span class="at">samples =</span> mt_pruned, <span class="at">genes =</span> tax_pruned)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculamos los factores de normalizacion para corregir la diferencia de profundidad de muestreo y los datos relativos</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>edgeR <span class="ot">=</span> <span class="fu">calcNormFactors</span>(edgeR)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Extraemos la abundancia normalizada</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>ASV_pruned_norm <span class="ot">=</span> <span class="fu">cpm</span>(edgeR, <span class="at">normalized.lib.sizes=</span>T, <span class="at">log=</span>F)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Volvemos a crear un objeto phyloseq con los datos normalizados</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>phy_ASV_norm<span class="ot">=</span><span class="fu">otu_table</span>(<span class="fu">as.data.frame</span>(ASV_pruned_norm,<span class="at">row.names=</span>F), <span class="at">taxa_are_rows =</span> T)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>phy_taxonomy_norm<span class="ot">=</span><span class="fu">tax_table</span>(<span class="fu">as.matrix</span>(tax_pruned))</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>phy_metadata_norm<span class="ot">=</span><span class="fu">sample_data</span>(mt_pruned)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co">#Añadimos el nombre de los taxones</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="fu">taxa_names</span>(phy_ASV_norm)<span class="ot">=</span> <span class="fu">taxa_names</span>(phy_taxonomy_norm)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co">#Comprobamos que sean identicos</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">rownames</span>(phy_ASV_norm), <span class="fu">rownames</span>(phy_taxonomy_norm))</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co">#Fusionamos todos los componentes del phyloseq</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>normalized_phyloseq <span class="ot">=</span> <span class="fu">phyloseq</span>(phy_ASV_norm,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>                               phy_taxonomy_norm,</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>                               phy_metadata_norm,</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>                               tree_pruned)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="comparación-de-diversidad-beta-entre-grupos-de-muestras" class="level2">
<h2 class="anchored" data-anchor-id="comparación-de-diversidad-beta-entre-grupos-de-muestras">7.2 Comparación de diversidad beta entre grupos de muestras</h2>
<p>Aplicaremos técnicas de estadística multivariante tanto para comparar los grupos de muestras entre sí como para visualizar las diferencias entre ellos.</p>
<p>La versión multivariante del test de Levene (homocedasticidad) es el <strong>test PERMDISP2</strong>. El concepto es el mismo: probar la dispersión de todos los grupos de muestras (llamada <em>betadispersión</em>) es la misma. En este caso, tendremos muchas variables (la abundancia de cada ASV en cada una de las muestras).</p>
<p>Por otro lado, para comparar si el centroide (concepto similar al de <em>media</em> en el espacio multivariante) de ambos grupos de muestras es el mismo, se emplea el <strong>test PERMANOVA</strong>, el cual no asume ningún tipo de distribución de los datos y es el equivalente multivariante al test univariante de ANOVA.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>En el caso multivariante, el test PERMANOVA <strong>NO</strong> es sensible a la heterocedasticidad si tenemos un diseño <strong>balanceado</strong>, por lo que en casos balanceados no se suele aplicar. Sin embargo, si tenemos un número diferente de réplicas en cada grupo de muestras (como en este ejercicio), y estas son heterocedásticas, el test PERMANOVA no es capaz de distinguir si las diferencias detectadas son debidas a diferencias reales en el centroide o en la dispersión de las muestras. Por consiguiente, en casos de diseño desbalanceado es <strong>esencial</strong> aplicar el test PERMDISP2</p>
</div>
</div>
<p>Para poder comparar entre sí los grupos de muestras, ha de hacerse en base a una medida de distancia o disimilitud. Existen diferentes tipos de <strong>medidas de distancia o disimilitud</strong> (1-similitud), entre las cuales queremos destacar estas tres:</p>
<p>-<strong>Disimilitud Bray-Curstis</strong>: tiene en cuenta la abundancia de las especies -<strong>Distancia Unweighted UniFrac</strong>: tiene en cuenta la distancia filogenética de las especies, pero <strong>NO</strong> su abundancia. -<strong>Distancia Weighted-UniFrac</strong>: tiene en cuenta tanto la distancia filogenética de las especies que componen los pares de muestas, como la abundancia de cada una de ellas.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Podemos seleccionar cualquiera de las tres, pero solo en el caso de bacterias. En el caso de los hongos <strong>NO</strong> podremos seleccionar las distancias UniFrac puesto que al ser ITS2 variable en longitud, no disponemos de un árbol filogenético.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Aplicaremos varias funciones del paquete micro4all para poder implementar el test PERMDISP2 y PERMANOVA basándonos en las tres distancias</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># BETADISPERSION</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">#¡¡OJO!! Debemos trabajar con los datos normalizados</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>betadisper <span class="ot">=</span> <span class="fu">Betadispersion</span>(normalized_phyloseq,<span class="at">distances =</span> <span class="fu">c</span>(<span class="st">"bray"</span>, <span class="st">"unifrac"</span>, <span class="st">"wunifrac"</span>), <span class="at">formula =</span> <span class="st">"status"</span>) </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">#argumentos:</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#-objeto phyloseq normalizado</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#-distancias a calcular</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#formula: introducir el nombre de la variable de agrupación</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>betadisper[<span class="dv">1</span>]<span class="co"># en el elemento 1 de la lista, podemos ver los resultados del test para las tres medidas de disimilitud</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>No podemos rechazar la H0 para ninguna de las medidas de disimilitud seleccionadas (p &gt; 0.05), por lo que estamos ante datos homocedásticos. Es genial, puesto que podremos confiar en los resultados del PERMANOVA aunque nuestros datos estén ligeramente desbalanceados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>permanova <span class="ot">=</span> <span class="fu">Permanova</span>(normalized_phyloseq,<span class="at">distances =</span> <span class="fu">c</span>(<span class="st">"bray"</span>, <span class="st">"unifrac"</span>, <span class="st">"wunifrac"</span>), <span class="at">formula =</span> <span class="st">"status"</span>) <span class="co">#misma lógica que para la funcion anterior.</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>permanova[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Interpretación</strong>: en este caso, tendremos en cuenta varios parámetros del test PERMANOVA, para cada medida de disimilitud:</p>
<p>-<strong>Valor de R2</strong>: nos indica el porcentaje de la varianza total que explica nuestra variable de agrupación (estado de los árboles). El resto (residuales) es explicado por factores no medidos en el experimento. En nuestro caso, gracias a la medida Weighted-UniFrac, la condición de los árboles llega a explicar hasta un 64.6% de todas las diferencias reales existentes entre los dos grupos de muestras.</p>
<p>-<strong>p-valor</strong>: rechazmos la H0 de igualdad de centroides: vemos que las muestras son significativamente diferentes entre sí en base a cualquiera de las distancias seleccionadas.</p>
<p>Ya hemos detectado diferencias, pero ¿de qué magnitud son estas?</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Es <strong>importante</strong> tener en cuenta que el hecho de que tengamos un pvalor muy bajo y/o un R2 muy alto <strong>NO</strong> tiene porqué indicar que las diferencias observadas son grandes. El valor de R2 simplemente nos indica cuán responsable es nuestro factor de agrupación de las diferencias que observamos, sean estas pequeñas o grandes. Para obtener información sobre la magnitud de las diferencias, calculamos el <strong>tamaño del efecto</strong>.</p>
</div>
</div>
<p>Para calcular el tamaño del efecto (en estadística multivariante conocido también como <em>partial omega square</em>), debemos seleccionar primero con qué medida de disimilitud vamos a trabajar (no es operativo trabajar con tres medidas si ya tenemos una que explica gran porcentaje de la varianza).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#tenemos que guardar el resultado de nuestro test en una variable.</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Para ello, guardaremos también el valor de las distancias en una variable:</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>wuni<span class="ot">=</span><span class="fu">UniFrac</span>(normalized_phyloseq, <span class="at">weighted=</span>T) <span class="co">#calculo de distancias</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>adonis_wuni<span class="ot">=</span><span class="fu">adonis2</span>(wuni<span class="sc">~</span>status, <span class="at">data=</span>mt_pruned, <span class="at">permutations =</span> <span class="dv">9999</span>)<span class="co">#test PERMANOVA con distancia Weighted UniFrac. Permutaciones = iteraciones, cuantas más pongamos, más afinaremos el pvalor real. Por tradición: 9999</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>adonis_OmegaSq <span class="ot">=</span> <span class="cf">function</span>(adonisOutput, <span class="at">partial =</span> <span class="cn">TRUE</span>){</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">is</span>(adonisOutput, <span class="st">"adonis"</span>) <span class="sc">||</span> <span class="fu">is</span>(adonisOutput, <span class="st">"anova.cca"</span>)))</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Input should be an adonis object"</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is</span>(adonisOutput, <span class="st">"anova.cca"</span>)) {</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    aov_tab <span class="ot">&lt;-</span> adonisOutput</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    aov_tab<span class="sc">$</span>MeanSqs <span class="ot">&lt;-</span> aov_tab<span class="sc">$</span>SumOfSqs <span class="sc">/</span> aov_tab<span class="sc">$</span>Df</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    aov_tab<span class="sc">$</span>MeanSqs[<span class="fu">length</span>(aov_tab<span class="sc">$</span>Df)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    aov_tab <span class="ot">&lt;-</span> adonisOutput<span class="sc">$</span>aov.tab</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  heading <span class="ot">&lt;-</span> <span class="fu">attr</span>(aov_tab, <span class="st">"heading"</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  MS_res <span class="ot">&lt;-</span> aov_tab[<span class="fu">pmatch</span>(<span class="st">"Residual"</span>, <span class="fu">rownames</span>(aov_tab)), <span class="st">"MeanSqs"</span>]</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  SS_tot <span class="ot">&lt;-</span> aov_tab[<span class="fu">rownames</span>(aov_tab) <span class="sc">==</span> <span class="st">"Total"</span>, <span class="st">"SumsOfSqs"</span>]</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> aov_tab[<span class="fu">rownames</span>(aov_tab) <span class="sc">==</span> <span class="st">"Total"</span>, <span class="st">"Df"</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(partial){</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    omega <span class="ot">&lt;-</span> <span class="fu">apply</span>(aov_tab, <span class="dv">1</span>, <span class="cf">function</span>(x) (x[<span class="st">"Df"</span>]<span class="sc">*</span>(x[<span class="st">"MeanSqs"</span>]<span class="sc">-</span>MS_res))<span class="sc">/</span>(x[<span class="st">"Df"</span>]<span class="sc">*</span>x[<span class="st">"MeanSqs"</span>]<span class="sc">+</span>(N<span class="sc">-</span>x[<span class="st">"Df"</span>])<span class="sc">*</span>MS_res))</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    aov_tab<span class="sc">$</span>parOmegaSq <span class="ot">&lt;-</span> <span class="fu">c</span>(omega[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(omega)<span class="sc">-</span><span class="dv">2</span>)], <span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    omega <span class="ot">&lt;-</span> <span class="fu">apply</span>(aov_tab, <span class="dv">1</span>, <span class="cf">function</span>(x) (x[<span class="st">"SumsOfSqs"</span>]<span class="sc">-</span>x[<span class="st">"Df"</span>]<span class="sc">*</span>MS_res)<span class="sc">/</span>(SS_tot<span class="sc">+</span>MS_res))</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    aov_tab<span class="sc">$</span>OmegaSq <span class="ot">&lt;-</span> <span class="fu">c</span>(omega[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(omega)<span class="sc">-</span><span class="dv">2</span>)], <span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is</span>(adonisOutput, <span class="st">"adonis"</span>))</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    cn_order <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Df"</span>, <span class="st">"SumsOfSqs"</span>, <span class="st">"MeanSqs"</span>, <span class="st">"F.Model"</span>, <span class="st">"R2"</span>,</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> (partial) <span class="st">"parOmegaSq"</span> <span class="cf">else</span> <span class="st">"OmegaSq"</span>, <span class="st">"Pr(&gt;F)"</span>)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    cn_order <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Df"</span>, <span class="st">"SumOfSqs"</span>, <span class="st">"F"</span>, <span class="cf">if</span> (partial) <span class="st">"parOmegaSq"</span> <span class="cf">else</span> <span class="st">"OmegaSq"</span>,</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Pr(&gt;F)"</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  aov_tab <span class="ot">&lt;-</span> aov_tab[, cn_order]</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(aov_tab, <span class="st">"names"</span>) <span class="ot">&lt;-</span> cn_order</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(aov_tab, <span class="st">"heading"</span>) <span class="ot">&lt;-</span> heading</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is</span>(adonisOutput, <span class="st">"adonis"</span>))</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    adonisOutput<span class="sc">$</span>aov.tab <span class="ot">&lt;-</span> aov_tab</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    adonisOutput <span class="ot">&lt;-</span> aov_tab</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(adonisOutput)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>}<span class="co">#cargamos esta función, desarrollada por otros usuarios de R</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>adonis_wuni_eff<span class="ot">=</span><span class="fu">adonis_OmegaSq</span>(adonis_wuni)<span class="co">#apliquemos la funcion sobre el PERMANOVA basado exclusivamente en Weighted UniFrac</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>adonis_wuni_eff<span class="co">#vemos que es exactamente igual que el objeto 'adonis_wuni', pero incluyendo una columna 'parOmegaSq', que es el término Partial Omega Square, es decir, el tamaño del efecto.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El valor de omega es &gt; 0.6, por lo podríamos considerar moderado-grande.</p>
</section>
<section id="graficos" class="level2">
<h2 class="anchored" data-anchor-id="graficos">7.3 Graficos</h2>
<p>Podemos representar las diferencias detectadas en el PERMANOVA, en el espacio multivariante. Para ello, necesitamos calcular gráficos de ordenación, entre ellos:</p>
<p>-<strong>PCoA</strong>: <em>Principal Coordinates Analysis</em> o <em>Análisis de coordenadas principales</em>. Similar al PCA pero no está basado en distancias euclídeas. En síntesis, es una forma de distribuir las muestras en N dimensiones, y casi siempre N &gt; 2. La posición de las muestras en el especio estará determinada por vectores y escalares (pesos que tiene cada variable). Obtendremos, entre otros factores, el porcentaje de la varianza que representa cada eje.</p>
<p>-<strong>NMDS</strong>: <em>Non-Metric MultiDiomensional Scale</em> o <em>Escalamiento multidimensional no-métrico</em>: en este caso forzamos a que la distribución de las muestras en el espacio sea solamente en dos dimensiones. Puesto que trabajamos con datos multidimensionales, al forzar la distribución solo en dos coordenadas, el algoritmo estará generando un estrés. Se considera que cuando el estrés es &gt; 0.2, el gráfico ya no es representativo de la realidad.</p>
<p>Para decidir cuál es más adecuado, una buena estrategia es analizar el valor de la varianza explicada por la suma de las dos dimensiones que nos interese considerar, y el valor del estrés del NMDS. Además, es interesante visualizar ambos gráficos, y quedarnos con aquel que resulte en mejores parámetros, y que mejor represente las diferencias observadas.</p>
<p>Calculemos los parámetros mencionados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculo del estrés del NMDS:</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>NMDS <span class="ot">=</span> <span class="fu">ordinate</span>(normalized_phyloseq, <span class="st">"NMDS"</span>, <span class="st">"wuni"</span>)<span class="co">#calcula la ordenacion. Argumentos: objeto phyloseq normalizado, tipo de ordenacion (PCoA o NMDS, distancia)</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"The stress of the NMDS based on Weighted UniFrac is:"</span>, NMDS<span class="sc">$</span>stress))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Varianza y multidimensionalidad del PCoA:</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>PCOA <span class="ot">=</span> <span class="fu">ordinate</span>(normalized_phyloseq, <span class="st">"PCoA"</span>, <span class="st">"wuni"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>pesos<span class="ot">=</span>PCOA<span class="sc">$</span>values<span class="sc">$</span>Relative_eig[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="co">#varianza explicada por los dos primeros ejes. Podemos indicarle todos los ejes que queramos, teniendo en cuenta que el peso de los ejes estará ordenado de forma descendiente</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>pesos </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(PCOA<span class="sc">$</span>values<span class="sc">$</span>Relative_eig[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])<span class="co">#Con esto vemos lo que explican los 10 primeros ejes</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(PCOA<span class="sc">$</span>values<span class="sc">$</span>Relative_eig) <span class="co">#nos dice el número total de dimensiones que necesitaríamos para explicar el 100% de la varianza.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ahora haremos los dos gráficos. Se representa solo uno de ellos, por ejemplo, el PCoA:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pcoa <span class="ot">=</span> <span class="fu">plot_ordination</span>(normalized_phyloseq, PCOA,<span class="at">type=</span> <span class="st">"samples"</span>, <span class="at">color=</span> <span class="st">"status"</span>)<span class="sc">+</span><span class="co">#podriamos incluso representar cada grupo de muestras con una forma</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">4</span>, <span class="at">size =</span> <span class="fl">4.5</span>)<span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="fu">paste0</span>(<span class="st">"Axis 1 ("</span>,<span class="fu">round</span>(pesos[<span class="dv">1</span>]<span class="sc">*</span><span class="dv">100</span>,<span class="at">digits =</span> <span class="dv">2</span>),<span class="st">"%)"</span>), </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">y=</span><span class="fu">paste0</span>(<span class="st">"Axis 2 ("</span>,<span class="fu">round</span>(pesos[<span class="dv">2</span>]<span class="sc">*</span><span class="dv">100</span>,<span class="at">digits =</span> <span class="dv">2</span>),<span class="st">"%)"</span>),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">color=</span><span class="st">"status"</span>)<span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"healthy"</span><span class="ot">=</span><span class="st">"green"</span>,<span class="st">"diseased"</span><span class="ot">=</span><span class="st">"black"</span>),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks=</span><span class="fu">c</span>(<span class="st">"healthy"</span>, <span class="st">"diseased"</span>),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>, <span class="st">"Symptomatic"</span>))<span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key=</span><span class="fu">element_blank</span>(),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title.align =</span> <span class="dv">0</span>,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>,<span class="at">size=</span><span class="dv">18</span>),</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text.align =</span> <span class="dv">0</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">18</span>),</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>,<span class="at">size=</span><span class="dv">18</span>),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>))<span class="sc">+</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="fl">0.00</span>)), <span class="at">lty=</span><span class="dv">2</span>, <span class="at">colour=</span><span class="st">"grey"</span>)<span class="sc">+</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="fl">0.00</span>)), <span class="at">lty=</span><span class="dv">2</span>, <span class="at">colour=</span><span class="st">"grey"</span>)<span class="sc">+</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Endosphere</span><span class="sc">\n</span><span class="st">PCoA on Weighted-UniFrac distance"</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="fu">x11</span>()  </span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>pcoa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En la Figura 6 podemos observar el resultado. Vemos que, tal y como nos demostró el PERMANOVA, la comunidad bacteriana de árboles sanos y enfermos difiere entre sí</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/pcoa.jpeg" class="img-fluid figure-img"></p>
<figcaption>Figura 6. PCoA basado en distancias Wighted-UniFrac.</figcaption>
</figure>
</div>
<p>Ejercicio: obtener el gráfico NMDS. Debe tenerse en cuenta que se debe indicar el estrés del mismo.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Si se desean obtener todos los gráficos (PCoA, NMDS) basados en todas las distancias, se puede usar el código de micro4all descrito aquí: https://nuriamw.github.io/micro4all/tutorial/package_workflow.html#beta-diversity-analysis</p>
</div>
</div>
</section>
</section>
<section id="perfiles-taxonómicos" class="level1">
<h1>8. Perfiles taxonómicos</h1>
<p>Además de la diversidad, es necesario conocer qué microorganismos componen las muestras y cuál es su abundancia relativa. Para ello, utilizaremos los <strong>datos NO normalizados</strong>. Se pueden emplear los normalizados, pero entonces, deben interpretarse los datos normalizados.</p>
<section id="obtención-de-abundancia-relativa" class="level2">
<h2 class="anchored" data-anchor-id="obtención-de-abundancia-relativa">8.1 Obtención de abundancia relativa</h2>
<p>Calculemos la abundancia relativa de todos los ASVs de todas las muestras:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>phy_relabun<span class="ot">=</span><span class="fu">transform_sample_counts</span>(phy_pruned, <span class="cf">function</span>(x){x<span class="sc">/</span><span class="fu">sum</span>(x)}<span class="sc">*</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="aglomeración-al-rango-taxonómico-de-estudio" class="level2">
<h2 class="anchored" data-anchor-id="aglomeración-al-rango-taxonómico-de-estudio">8.2 Aglomeración al rango taxonómico de estudio</h2>
<p>Pero, ¿con qué nivel taxonómico queremos trabajar? La respuesta a esta pregunta depende del diseño experimental y la pregunta científica. Si queremos simplemente hacer un análisis exploratorio, podríamos obtener una visión una visión general analizando los <em>phyla</em>, y una visión detallada analizando los géneros. Por tanto, debemos primero aglomerar los datos al rango taxonómico deseado.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Phylum</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>phylum_relabun<span class="ot">=</span><span class="fu">tax_glom</span>(phy_relabun, <span class="at">taxrank =</span> <span class="st">"Phylum"</span>)<span class="co">#colapsamos el objeto phyloseq al rango indicago</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">otu_table</span>(phylum_relabun)) <span class="co">#comprobamos que la suma de la abundancia relativa de cada phylum equivale a 100%</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Género</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>genus_relabun<span class="ot">=</span><span class="fu">tax_glom</span>(phy_relabun, <span class="at">taxrank =</span> <span class="st">"Genus"</span>); <span class="fu">colSums</span>(<span class="fu">otu_table</span>(genus_relabun)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="obtención-de-tablas-exploratorias" class="level2">
<h2 class="anchored" data-anchor-id="obtención-de-tablas-exploratorias">8.3 Obtención de tablas exploratorias</h2>
<p>Obtengamos una tabla de abundancias relativas, donde tengamos la abundancia de cada taxón en cada grupo de muestras.</p>
<p>Para los <em>phyla</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Phylum:</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>phylum_rel_df<span class="ot">=</span><span class="fu">as.data.frame</span>(<span class="fu">otu_table</span>(phylum_relabun))<span class="co">#extraemos la tabla de ocurrencias</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>phylum_rel_complete<span class="ot">=</span><span class="fu">cbind</span>(<span class="fu">tax_table</span>(phylum_relabun),phylum_rel_df)<span class="co">#unimos la tabla de taxonomia y la de ocurrencias</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">rownames</span>(phylum_rel_complete),<span class="fu">rownames</span>(phylum_rel_df))<span class="co">#comprobamos que sean identicos (tiene uqe salir por consola "TRUE")</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">"TAXA"</span><span class="ot">=</span><span class="fu">rownames</span>(phylum_rel_complete),phylum_rel_complete),<span class="at">file=</span><span class="st">"abundrel_phylum_porReplicas.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>table_phylum <span class="ot">=</span> <span class="fu">t</span>(phylum_rel_df)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>tax_phylum<span class="ot">=</span><span class="fu">tax_table</span>(phylum_relabun)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>phylum_media<span class="ot">=</span><span class="fu">aggregate</span>(table_phylum, </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by=</span><span class="fu">list</span>(<span class="fu">as.data.frame</span>(<span class="fu">sample_data</span>(phylum_relabun))<span class="sc">$</span>status), <span class="at">FUN=</span>mean)<span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="st">"Group.1"</span>) <span class="sc">%&gt;%</span> <span class="fu">t</span>()</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#la funcion 'aggregate' dividide el conjunto de datos tal y como se le indique (aqui, en base al factor de agrupacion 'status'), y computa el estadistico que le indiquemos (aqui, la media primero y luego la desviacion estandar)</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>phylum_sd <span class="ot">=</span> <span class="fu">aggregate</span>(table_phylum, </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">by=</span><span class="fu">list</span>(<span class="fu">as.data.frame</span>(<span class="fu">sample_data</span>(phylum_relabun))<span class="sc">$</span>status), <span class="at">FUN=</span>sd)<span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="st">"Group.1"</span>)  <span class="sc">%&gt;%</span> <span class="fu">t</span>()  <span class="sc">%&gt;%</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="at">.fn=</span> <span class="sc">~</span><span class="fu">paste0</span>(<span class="fu">colnames</span>(phylum_media), <span class="st">"_SD"</span>))</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>phylum_media_sd<span class="ot">=</span><span class="fu">merge</span>(tax_phylum, phylum_media, <span class="at">by=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span><span class="fu">column_to_rownames</span>(<span class="st">"Row.names"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(phylum_sd, <span class="at">by=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="st">"Row.names"</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">"TAXA"</span><span class="ot">=</span><span class="fu">rownames</span>(phylum_media_sd),phylum_media_sd), <span class="at">file=</span><span class="st">"abundrel_media_sd_phylum.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ejercicio: calcular las mismas tablas a nivel de género.</p>
</section>
<section id="preparacion-de-datos-para-realizar-los-gráficos" class="level2">
<h2 class="anchored" data-anchor-id="preparacion-de-datos-para-realizar-los-gráficos">8.4 Preparacion de datos para realizar los gráficos</h2>
<p>Se pueden hacer muchos tipos de gráficos, pero nosotros haremos gráficos de barras apiladas. Como en el caso de los géneros podemos tener un número muy grande de categorías, representaremos los mayoritarios (aquellos cuya abundancia se encuentre por encima de un umbral). Este umbral será definido por el usuario. Probemos con un 1%</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#para poder utilizar ggplo2, necesitamos que los datos estén 'melted', es decir, organizados en varias columnas: una que incluya el nombre de los phyla, otra que indique el grupo de muestras, y otra que incluya los valores de abundancia</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>phylum_data <span class="ot">=</span> phylum_media_sd</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>phylum_data<span class="ot">=</span> phylum_data[,<span class="dv">2</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>phylum_data<span class="ot">=</span>phylum_data[,<span class="sc">-</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>)]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="ot">=</span> phylum_data  <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="sc">!</span>Phylum, <span class="at">names_to=</span><span class="st">"status"</span>, <span class="at">values_to=</span><span class="st">"Abundance"</span>)                         </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>unclassified_phylum<span class="ot">=</span>phylum_media_melt[phylum_media_melt[,<span class="st">"Phylum"</span>] <span class="sc">==</span> <span class="st">"unclassified"</span>,] <span class="co">#retengo los unclassified para no eliminarlos aunque sean &lt;1%</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="ot">=</span>phylum_media_melt[phylum_media_melt[,<span class="st">"Phylum"</span>] <span class="sc">!=</span> <span class="st">"unclassified"</span>,] <span class="co">#eliminamos los unclass de la tabla madre para poder meter en el grupo &lt;1% a los minoritarios clasificados</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="sc">$</span>Phylum[phylum_media_melt<span class="sc">$</span>Abundance <span class="sc">&lt;=</span> <span class="fl">1.0</span>] <span class="ot">=</span> <span class="st">"Other phyla (&lt;1%)"</span> <span class="co">#agrupar como "Other phyla" todos aquellos que tengan menos de un 1% de abund rel</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="sc">$</span>Phylum<span class="ot">=</span><span class="fu">as.factor</span>(phylum_media_melt<span class="sc">$</span>Phylum)<span class="co">#necesitamos que la variable 'Phylum' sea un factor, no de tipo caracter</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">#en este dataset y para el nivel de Phylum, no tenemos unclassified, por lo que a partir de ahora, no los incluiremos para evitar distorsiones. Se deja el código a disposición, puesto que será útil para el caso de los géneros</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">#guardamos los "Other phyla" en una nueva variable, para poder quitarlos de la tabla original.</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>others_phylum<span class="ot">=</span>phylum_media_melt[phylum_media_melt[,<span class="st">"Phylum"</span>] <span class="sc">==</span> <span class="st">"Other phyla (&lt;1%)"</span>,]</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="ot">=</span>phylum_media_melt[phylum_media_melt[,<span class="st">"Phylum"</span>] <span class="sc">!=</span> <span class="st">"Other phyla (&lt;1%)"</span>,]<span class="co">#los quitamos de la tabla original</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>ordenado_phylum<span class="ot">=</span><span class="fu">as.data.frame</span>(phylum_media_melt[<span class="fu">order</span>(phylum_media_melt<span class="sc">$</span>Abundance, <span class="at">decreasing=</span>T),]) <span class="co">#ordenamos por abundancia relativa</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>plot_phylum_input<span class="ot">=</span><span class="fu">rbind</span>(ordenado_phylum,others_phylum)<span class="co">#a la tabla ordenada le metemos los "Other phyla" (y los "unclassified" cuando proceda)</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co">#es recomendable visualizar cómo ha quedado la tabla, y comporbar la posición de los unclassified (si es que tenemos alguno) y del grupo artificial 'Other phyla'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Preparemos ahora las cuestiones estéticas del gráfico</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>group_label<span class="ot">=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>,<span class="st">"Symptomatic"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>breaks<span class="ot">=</span><span class="fu">c</span>(<span class="st">"healthy"</span>,<span class="st">"diseased"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>phyl_name_ordered<span class="ot">=</span><span class="fu">as.vector</span>(plot_phylum_input<span class="sc">$</span>Phylum)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>nombres_unicos_phylum<span class="ot">=</span><span class="fu">unique</span>(phyl_name_ordered)<span class="co">#nos quedamos con los nombres UNICOS, porque hay algunos phyla repetidos ("Other phyla")</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>plot_phylum_input<span class="sc">$</span>Phylum<span class="ot">=</span><span class="fu">reorder.factor</span>(plot_phylum_input<span class="sc">$</span>Phylum,<span class="at">new.order=</span><span class="fu">rev</span>(nombres_unicos_phylum))<span class="co">#ordenamos los phyla como nosotros queremos.</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>lab_unicos_phylum<span class="ot">=</span>nombres_unicos_phylum <span class="co">#esto es para hacer la leyenda del grafico</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>sorted_labels_ggplot <span class="ot">=</span><span class="fu">sapply</span>(lab_unicos_phylum,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">function</span>(x) <span class="cf">if</span> (x <span class="sc">==</span> <span class="st">"Other phyla (&lt;1%)"</span><span class="sc">|</span>x <span class="sc">==</span> <span class="st">"unclassified"</span><span class="sc">|</span>x <span class="sc">==</span> <span class="st">"Other genera (&lt;1%)"</span>)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>                                    {<span class="fu">parse</span>(<span class="at">text=</span><span class="fu">paste0</span>(<span class="st">"'"</span>, <span class="fu">as.character</span>(x), <span class="st">"'"</span>))} <span class="cf">else</span> {<span class="fu">parse</span>(<span class="at">text =</span> <span class="fu">paste0</span>(<span class="st">"italic('"</span>,<span class="fu">as.character</span>(x),<span class="st">"')"</span>))}) <span class="co">#esta funcion es para que me ponga en cursiva los nombre de los Phyla pero me deje en redonda los "Unclassified" y los "Other phyla"</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Poner los colores en orden, segun el orden de nombres_unicos. Ej: Proteobacteria (la mas abun) = #0099FF</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co">#OJO! Tener cuidado  de que hay tantos colores como phyla:</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(lab_unicos_phylum)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>colores_phylum <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"#0099FF"</span>,<span class="st">"#00CC00"</span>,<span class="st">"magenta"</span>,<span class="st">"yellow"</span>,<span class="st">"purple"</span>,<span class="st">"grey"</span>, <span class="st">"black"</span>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(lab_unicos_phylum)<span class="sc">==</span><span class="fu">length</span>(colores_phylum) <span class="co">#si FALSE, añadir/quitar colores</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(lab_unicos_phylum)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(colores_phylum)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>titulo_plot_phylum<span class="ot">=</span><span class="st">"Endosphere, main phyla"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="elaboración-del-gráfico" class="level2">
<h2 class="anchored" data-anchor-id="elaboración-del-gráfico">8.5. Elaboración del gráfico</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>phylum_bar<span class="ot">=</span><span class="fu">ggplot</span>(plot_phylum_input, <span class="fu">aes</span>(<span class="at">x=</span>status, <span class="at">y=</span>Abundance, <span class="at">fill=</span>Phylum, <span class="at">order=</span>Phylum)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"stack"</span>)<span class="sc">+</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span>colores_phylum,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">labels=</span>sorted_labels_ggplot,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">breaks=</span>nombres_unicos_phylum)<span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Mean relative abundance (%)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">fill=</span><span class="st">"Phylum"</span>,<span class="at">title=</span>titulo_plot_phylum)<span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))<span class="sc">+</span><span class="co">#sirve para cambiar el orden de la leyenda</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">limits=</span>breaks,<span class="at">labels=</span>group_label,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">breaks=</span>breaks)<span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#scale_y_continuous(expand=c(0.01,0.01),</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                   breaks=c(0,10,20,30,40,50,60,70,80,90,100),</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                   labels=c("0","10", "20","30","40","50","60","70","80","90","100"),#podemos modificar la escala </span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>   <span class="co">#                  limits = c(NA, 100))+</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour=</span><span class="st">"black"</span>))<span class="sc">+</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x=</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">7</span>))<span class="sc">+</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))<span class="sc">+</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>, <span class="at">size=</span><span class="dv">5</span>))<span class="sc">+</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>))<span class="sc">+</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>))<span class="sc">+</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))<span class="sc">+</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>, <span class="at">face=</span><span class="st">"bold"</span>))<span class="sc">+</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title.align=</span><span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.text.align =</span> <span class="dv">0</span>)<span class="sc">+</span><span class="co">#al poner "expresion" para poner la cursiva parcial en leyenda, te cambia la alineacion, esto es para que quede alineada a la izda</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="fu">x11</span>()</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>phylum_bar</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Phylum_barrasapiladas.jpg"</span>, phylum_bar,<span class="at">width =</span> <span class="dv">80</span>, <span class="at">height =</span> <span class="dv">60</span>, <span class="at">units =</span> <span class="st">"mm"</span>, <span class="at">dpi =</span> <span class="dv">800</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La Figura 7 nos revela la altísima abundancia relativa del Phylum Mycoplasmatota en el grupo de muestras relativas a los árboles enfermos</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Phylum_barrasapiladas.jpg" class="img-fluid figure-img"></p>
<figcaption>Figura 7. Distribución de los principales <em>phyla</em>. El grupo artificial ‘Other phyla (&lt;1 %)’ comprende aquellos <em>phyla</em> cuya abundancia promedio es inferior al 1% del total de secuencias</figcaption>
</figure>
</div>
<p>¿Os atreveríais a hacer el mismo tipo de gráfico, pero a nivel de género? Nota: tened en cuenta que hay muchos más géneros que <em>phyla</em>, y que cada uno de ellos podría suponer un menor porcentaje de secuencias al ser un rango taxonómico más fino, más detallado. Así pues, es posible que el corte de abundancia de los géneros mayoritarios haya que subirlo, de lo contrario, tendremos muchas categorías (géneros) a colorear y puede ser difícil encontrar muchos colores diferentes y distinguiblees.</p>
</section>
</section>
<section id="análisis-de-abundancia-diferencial" class="level1">
<h1>9. Análisis de abundancia diferencial</h1>
<p>La beta diversidad ha demostrado que las comunidades bacterianas de ambos tipos de árboles son diferentes, pero, ¿qué taxones bacterianos son diferenteS?</p>
<p>Para estimar aquellos microorganismos que presentan diferencias en su abundancia cuando se quieren comparar dos grupos de muestras, necesitamos aplicar un test estadístico.</p>
<p>Puesto que se trata de <strong>datos composicionales</strong> (aquellos que representan la composición relativa de un conjunto; en total suman el 100%), no es apropiado aplicar test estadísticos univariantes a la abundancia de todos los taxones. En este curso, emplearemos la herramienta <strong>ANCOM-BC</strong> o <em>ANalysis of Compositions of Microbiomes with Bias Correction</em>. Podéis encontrar toda la información y matemática subyactente de este test <a href="https://doi.org/10.1038/s41467-020-17041-7" title="Link al artículo">aquí</a>.</p>
<p>En síntesis, ANCOM-BC emplea los datos de abundancia <strong>absoluta</strong> y realiza una transformación logarítmica. Posteriormente realiza una corrección de los posibles sesgos cometidos a la hora de realizar el muestreo. Así pues, debemos emplear nuestros objetos phylose <strong>sin normalizar</strong>, y que las ocurrencias se encuentren expresadas en <strong>número total de secuencias</strong> (abundancia absoluta, sin relativizar).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#A nivel de PHYLUM</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>ancom_phylum<span class="ot">=</span><span class="fu">ancombc2</span>(phy_pruned, <span class="at">tax_level=</span> <span class="st">"Phylum"</span>, <span class="at">p_adj_method=</span><span class="st">"holm"</span>,<span class="at">struc_zero=</span>T, <span class="at">fix_formula=</span><span class="st">"status"</span>, <span class="at">group=</span><span class="st">"status"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>ancom_phylum_filt<span class="ot">=</span> ancom_phylum<span class="sc">$</span>res <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">"Intercept"</span>))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">" "</span><span class="ot">=</span><span class="fu">rownames</span>(ancom_phylum_filt),ancom_phylum_filt),<span class="at">file=</span><span class="st">"ANCOMBC_Phylum.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">#A nivel de GÉNERO</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>ancom_genero<span class="ot">=</span><span class="fu">ancombc2</span>(phy_pruned, <span class="at">tax_level=</span> <span class="st">"Genus"</span>, <span class="at">p_adj_method=</span><span class="st">"holm"</span>,<span class="at">struc_zero=</span>T, <span class="at">fix_formula=</span><span class="st">"status"</span>, <span class="at">group=</span><span class="st">"status"</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>ancom_genero_filt<span class="ot">=</span> ancom_genero<span class="sc">$</span>res <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">"Intercept"</span>))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">" "</span><span class="ot">=</span><span class="fu">rownames</span>(ancom_genero_filt),ancom_genero_filt),<span class="at">file=</span><span class="st">"ANCOMBC_Genero.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ANCOM-BC devuelve una lista de resultados muy completa, si bien todos ellos no nos será útiles/interesantes. Analicemos sucintamente el output:</p>
<p>-<strong>bias_correct_log_table</strong>: dataframe con la abundancia transformada y corregida de los taxones.</p>
<p>-<strong>res</strong>: es la tabla que contiene los resultados del test estadístico. A su vez, dentro de esta, se incluyen algunos parámetros tanto para nuestra comparación de interés (healthy vs.&nbsp;diseased) como para el valor de referencia (<em>Intercept</em>, valor estimado cuando todas las variables explicativas están en su valor de referencia). Nos centraremos solamente en los parámetros de nuestra comparación de interés:</p>
<p>-<strong>taxon</strong> -<strong>lfc</strong>: valor de log fold change (debemos primero tener en cuenta la dirección de la comparación: healthy vs.&nbsp;diseased o diseased vs.&nbsp;healthy, puesto que de ello dependerá el signo). -<strong>se</strong>: error estándar de la comparación. -<strong>W</strong>: (<em>omega</em>) tamaño del efecto. -<strong>p</strong>: pvalor sin corrección de comparaciones múltiples. -<strong>q</strong>: pvalor corregido con el método de corrección que hemos indicado. -<strong>diff</strong>: si el taxón en estudio es estadísticamente significativo o no. Valor booleriano. -<strong>passed_ss</strong>: si el taxón en estudio pasa o no el test de sensibilidad. ¡¡OJO!! Podemos tener taxones que resultan diferencialmente abundantes pero que <strong>no</strong> pasen este test. Debemos tratatarlos con cautela porque podría tratarse de falsos positivos.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb36" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Analisis comunidades bacterianas"</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(collapse = FALSE)</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="fu"># 0. Presentación del proyecto</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>En este manual encontrareis todas las directrices para el análisis de las comunidades bacterianas de la endosfera de dos tipos de pinos: pinos con síntomas de decaimiento forestal (NSD) y pinos asintomáticos (ASH). Cada grupo de muestras está formado por 12 réplicas.</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="fu"># 1. Instalación de paquetes</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>Instalaremos varios tipos de paquetes para poder hacer todos nuestros análisis:</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>-**Rtools**: se trata de una herramienta de Windows necesaria para compilar paquetes en R que están en C/C++, por lo que hay que descargarlo de <span class="co">[</span><span class="ot">este link</span><span class="co">](https://cran.r-project.org/bin/windows/Rtools/ "Link para descargar Rtools")</span> e instalarlo como un programa de Windows. Por habernos descargado la versión 4.5 de R, tenemos que descargar RTools 4.5</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>-**BiocManager**: es un paquete de R que permite manejar paquetes del proyecto BioConductor (proyecto colaborativo para el desarrollo de paquetes a usar en análisis bioinformáticos, haz click <span class="co">[</span><span class="ot">aquí</span><span class="co">](https://bioconductor.org/ "Info sobre el proyecto BioConductor")</span> para conocer más al respecto).</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>-**Paquetes disponibles en GitHub**: algunos paquetes no se encuentran en el repositorio CRAN ni en BioConductor, sino en GitHub (desarrollados por otros usuarios y puestos allí a disposición de toda la comunidad de R).</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>-**Paquetes disponibles en CRAN**: paquetes clásicos que se encuentran en el repositorio CRAN.</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{r libraries, message=FALSE, warning=FALSE}</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a><span class="in">install.packages("devtools")#es necesario instalarlo para instalar algunos paquetes alojados en GitHub en vez de en CRAN</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a><span class="in">library(devtools)</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="in">if (!requireNamespace("BiocManager", quietly = TRUE))</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="in">  install.packages("BiocManager")</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="in">BiocManager::install(c("BiocGenerics", "ANCOMBC", "phyloseq","edgeR","microbiome"))#necesarios para que micro4all funcione correctamente</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a><span class="in">library(BiocGenerics)</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a><span class="in">library(ANCOMBC)</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="in">library(phyloseq)</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a><span class="in">library(edgeR)</span></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a><span class="in">library(microbiome)</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a><span class="in">install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")#descarga desde GitHub</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a><span class="in">library(pairwiseAdonis)</span></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a><span class="in">install_github("nuriamw/micro4all")#descarga desde GitHub</span></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a><span class="in">library(micro4all)</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a><span class="in">install.packages("tidyverse")</span></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a><span class="in">install.packages("ggpubr")</span></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggpubr)</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a><span class="in">install.packages("rstatix")</span></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a><span class="in">library(rstatix)</span></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a><span class="in">install.packages("gdata")</span></span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a><span class="in">library(gdata)</span></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. Preparación de los datos</span></span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a>Ya tenemos las secuencias obtenidas por Illumina MiSeq limpias y filtradas, por lo que se trata de secuencias de calidad. Sin embargo, todavía debemos preparar los datos para su análisis.</span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a>En primer lugar, debemos crear una **tabla de metadatos** (se conocen como *datos sobre los datos*). En ella debemos incluir información sobre nuestras muestras, por ejemplo: la réplica correspondiente, compartimento de la planta, condición del arbol (son/sin síntomas). En proyectos más complejos debemos introducir el máximo de información posible que nos permita agrupar las muestras en diferentes tipos de grupos o categorías, e incluso detectar patrones de asociación desconocidos.</span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>Es importante que en la tabla de metadatos, las muestras estén en el mismo orden que están en la tabla de ASV, y que el nombre de las muestras sea **idéntico** en ambas tablas.</span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>En este caso, partiremos de una tabla ya hecha, por lo que solo tendremos que cargarla.</span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>Recuerda que antes de empezar a trabajar, debes indicarle cuál es tu directorio de trabajo. Recuerda también introducir la tabla en tu directorio de trabajo, de lo contrario, tendrás que indicarle con código la ruta completa y es más probable cometer errores.</span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a>metadatos <span class="ot">=</span> <span class="fu">read.table</span>(<span class="st">"metadata.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">header=</span><span class="cn">TRUE</span>) </span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(metadatos) <span class="ot">=</span> metadatos<span class="sc">$</span>samples</span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. Creación de objeto tipo phyloseq</span></span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a>Se recomienda crear objetos phyloseq para analizar comunidades microbianas, ya que es el tipo de objeto con el que trabaja el paquete *phyloseq*.</span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a>Los objetos phyloseq se encuentran formados por una tabla de ocurrencias de los ASVs (tabla de ASVs), tabla de taxonomía, metadatos y un árbol filogenético.</span>
<span id="cb36-85"><a href="#cb36-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-86"><a href="#cb36-86" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb36-87"><a href="#cb36-87" aria-hidden="true" tabindex="-1"></a>Recordatorio: el ITS2 fúngico es muy variable en longitud, por lo que no es conveniente calcular árboles filogenéticos basados en esta región. El objeto phyloseq correspondiente, no incluirá el árbol filogenético.</span>
<span id="cb36-88"><a href="#cb36-88" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-89"><a href="#cb36-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-90"><a href="#cb36-90" aria-hidden="true" tabindex="-1"></a>Comencemos a crear el objeto phyloseq:</span>
<span id="cb36-91"><a href="#cb36-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-92"><a href="#cb36-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb36-93"><a href="#cb36-93" aria-hidden="true" tabindex="-1"></a><span class="in">ASV_final=read.table("ASV_final_bact.txt", sep="\t", header=TRUE)</span></span>
<span id="cb36-94"><a href="#cb36-94" aria-hidden="true" tabindex="-1"></a><span class="in">View(ASV_final)#visualizamos la tabla de ASVs para saber en que posiciones (columnas) se encuentra la taxonomia</span></span>
<span id="cb36-95"><a href="#cb36-95" aria-hidden="true" tabindex="-1"></a><span class="in">tax = ASV_final[,2:8] #indicamos las posiciones que ocupa la taxonomia (de Kingdom a ASV)</span></span>
<span id="cb36-96"><a href="#cb36-96" aria-hidden="true" tabindex="-1"></a><span class="in">ASV =  ASV_final[,9:ncol(ASV_final)] #indicamos las posiciones que ocupa la ocurrencia de los ASVs</span></span>
<span id="cb36-97"><a href="#cb36-97" aria-hidden="true" tabindex="-1"></a><span class="in">dna = Biostrings::DNAStringSet(ASV_final$ASV_seqs)#guardamos la seq de cada ASV llamando a la funcion DNAStringSet del paquete Biostrings</span></span>
<span id="cb36-98"><a href="#cb36-98" aria-hidden="true" tabindex="-1"></a><span class="in">#si tecleamos el 'dna' en la consola veremos el aspecto que tiene. Si nos fijamos bien, veremos que las secuencias las numera de de forma ascendente, pero no sabemos a que ASV corresponde</span></span>
<span id="cb36-99"><a href="#cb36-99" aria-hidden="true" tabindex="-1"></a><span class="in">names(dna) = ASV_final$ASV_names #asignamos a cada secuencia el nombre del ASV correspondiente</span></span>
<span id="cb36-100"><a href="#cb36-100" aria-hidden="true" tabindex="-1"></a><span class="in">row.names(tax) = ASV_final$ASV_names #hacemos que el nombre de cada linea sea justamente el nombre de los ASV</span></span>
<span id="cb36-101"><a href="#cb36-101" aria-hidden="true" tabindex="-1"></a><span class="in">row.names(ASV) = ASV_final$ASV_names</span></span>
<span id="cb36-102"><a href="#cb36-102" aria-hidden="true" tabindex="-1"></a><span class="in">identical(rownames(ASV), rownames(tax)) #comprobamos que los nombres de las filas son identicos y que corresponden con el nombre de los ASV.</span></span>
<span id="cb36-103"><a href="#cb36-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-104"><a href="#cb36-104" aria-hidden="true" tabindex="-1"></a><span class="in">phy_tree =  phyloseq::read_tree("phy_tree") #lectura del árbol</span></span>
<span id="cb36-105"><a href="#cb36-105" aria-hidden="true" tabindex="-1"></a><span class="in">unrooted_tree = phy_tree #cambio de nombre de variable</span></span>
<span id="cb36-106"><a href="#cb36-106" aria-hidden="true" tabindex="-1"></a><span class="in">ape::is.rooted(unrooted_tree) #le preguntamos si el arbol está enraizado o no</span></span>
<span id="cb36-107"><a href="#cb36-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-108"><a href="#cb36-108" aria-hidden="true" tabindex="-1"></a><span class="in">tree_root = ape::root(unrooted_tree, 1, resolve.root = T) #enraizamos el arbol y establecemos el outgroup</span></span>
<span id="cb36-109"><a href="#cb36-109" aria-hidden="true" tabindex="-1"></a><span class="in">ape::is.rooted(tree_root) #comprobamos que esté enraizado</span></span>
<span id="cb36-110"><a href="#cb36-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-111"><a href="#cb36-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-112"><a href="#cb36-112" aria-hidden="true" tabindex="-1"></a>De momento, solamente hemos formateado los objetos, ahora introduciremos los objetos en formato phyloseq</span>
<span id="cb36-113"><a href="#cb36-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-114"><a href="#cb36-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=F}</span></span>
<span id="cb36-115"><a href="#cb36-115" aria-hidden="true" tabindex="-1"></a><span class="in">phy_OTUtable = otu_table(ASV, taxa_are_rows = T)#transforma el objeto 'ASV' en la tabla de ASVs en formato phyloseq</span></span>
<span id="cb36-116"><a href="#cb36-116" aria-hidden="true" tabindex="-1"></a><span class="in">phy_taxonomy = tax_table(as.matrix(tax)) #idem con la taxonomia</span></span>
<span id="cb36-117"><a href="#cb36-117" aria-hidden="true" tabindex="-1"></a><span class="in">phy_metadata = sample_data(metadatos)</span></span>
<span id="cb36-118"><a href="#cb36-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-119"><a href="#cb36-119" aria-hidden="true" tabindex="-1"></a><span class="in">#fusionamos todos los objetos para crear el objeto phyloseq definitivo</span></span>
<span id="cb36-120"><a href="#cb36-120" aria-hidden="true" tabindex="-1"></a><span class="in">phy = phyloseq(phy_OTUtable,phy_taxonomy,phy_metadata,dna,tree_root)</span></span>
<span id="cb36-121"><a href="#cb36-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-122"><a href="#cb36-122" aria-hidden="true" tabindex="-1"></a><span class="in">phy #chequeamos el aspecto que tiene el objeto phyloseq. Es buen momento para comprobar si el número de muestras es el correcto</span></span>
<span id="cb36-123"><a href="#cb36-123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-124"><a href="#cb36-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-125"><a href="#cb36-125" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.1 Cargar un RDA</span></span>
<span id="cb36-126"><a href="#cb36-126" aria-hidden="true" tabindex="-1"></a>Si trabajamos en un servidor y ya hemos creado el objeto phyloseq, y ahora queremos trabajar en nuestro PC, deberíamos cargar el RDA creado previamente. Recordad que el objeto RDA debe estar localizado en nuestro directorio de trabajo (o indicamos la ruta completa donde esté alojado).</span>
<span id="cb36-127"><a href="#cb36-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-130"><a href="#cb36-130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-131"><a href="#cb36-131" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"phy.Rda"</span>)</span>
<span id="cb36-132"><a href="#cb36-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-133"><a href="#cb36-133" aria-hidden="true" tabindex="-1"></a><span class="fu"># 4. Curvas de rarefacción</span></span>
<span id="cb36-134"><a href="#cb36-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-135"><a href="#cb36-135" aria-hidden="true" tabindex="-1"></a>Las curvas de rarefacción son aquellas en las que se representa el número de ASVs en función del número de secuencias. Nos permiten, pues, tener una idea visual del esfuerzo de muestreo y secuenciación. Es decir, si el muestreo y la subsecuente secuenciación son representativos. Lo serán cuando nuestras curvas se aproximen a un *plateau* o asíntota (es decir, cuando aumentamos el número de secuencias pero no el de ASV, puesto que estamos cerca al máximo de ASV posible, esto es, el total).</span>
<span id="cb36-136"><a href="#cb36-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-137"><a href="#cb36-137" aria-hidden="true" tabindex="-1"></a>Además, podemos tener una idea de la diferencia en la riqueza de las muestras.</span>
<span id="cb36-138"><a href="#cb36-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-139"><a href="#cb36-139" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb36-140"><a href="#cb36-140" aria-hidden="true" tabindex="-1"></a>Recordatorio: **Riqueza**: número total de ASVs en una muestra</span>
<span id="cb36-141"><a href="#cb36-141" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-142"><a href="#cb36-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-145"><a href="#cb36-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-146"><a href="#cb36-146" aria-hidden="true" tabindex="-1"></a>mt<span class="ot">=</span><span class="fu">as.data.frame</span>(<span class="fu">sample_data</span>(phy))[<span class="fu">order</span>(<span class="fu">as.character</span>(<span class="fu">rownames</span>(<span class="fu">as.data.frame</span>(<span class="fu">sample_data</span>(phy)))),<span class="at">decreasing=</span>F),]<span class="co">#extraemos los metadatos del objeto phyloseq. En realidad, ya los teniamos ('metadatos'), pero puede darse que queramos hacer la rarefaccion de un subgrupo de muestras (por ejemplo, solo de los arboles enfermos)</span></span>
<span id="cb36-147"><a href="#cb36-147" aria-hidden="true" tabindex="-1"></a>ASV_phy <span class="ot">=</span> <span class="fu">otu_table</span>(phy)<span class="co">#extraer tabla de ASV</span></span>
<span id="cb36-148"><a href="#cb36-148" aria-hidden="true" tabindex="-1"></a>ASV_phy_t <span class="ot">=</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(ASV_phy))<span class="co">#hacemos la transpuesta</span></span>
<span id="cb36-149"><a href="#cb36-149" aria-hidden="true" tabindex="-1"></a>ASV_phy_t<span class="ot">=</span>ASV_phy_t[<span class="fu">order</span>(<span class="fu">as.character</span>(<span class="fu">rownames</span>(ASV_phy_t)),<span class="at">decreasing=</span><span class="cn">FALSE</span>),]<span class="co">#ordenamos la tabla</span></span>
<span id="cb36-150"><a href="#cb36-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-151"><a href="#cb36-151" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ASV_phy_t)<span class="sc">==</span><span class="fu">rownames</span>(mt) <span class="co">#debe ser TRUE, de lo contrario algo hemos hecho mal</span></span>
<span id="cb36-152"><a href="#cb36-152" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ASV_phy_t)<span class="ot">=</span><span class="fu">paste0</span>(<span class="fu">rownames</span>(ASV_phy_t),<span class="st">"/"</span>,mt<span class="sc">$</span>status)<span class="co">#cambiamos el nombre de cada linea (muestra) tal que tengamos fusionada la condicion de cada arbol</span></span>
<span id="cb36-153"><a href="#cb36-153" aria-hidden="true" tabindex="-1"></a>sample_names <span class="ot">=</span> <span class="fu">rownames</span>(ASV_phy_t)</span>
<span id="cb36-154"><a href="#cb36-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-155"><a href="#cb36-155" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">rarecurve</span>(ASV_phy_t , <span class="at">step =</span> <span class="dv">100</span>, <span class="at">label =</span> F) <span class="co">#rarefaccion. La calculamos cogiendo bunchs de secuencias de 100 en 100</span></span>
<span id="cb36-156"><a href="#cb36-156" aria-hidden="true" tabindex="-1"></a><span class="co">#en este punto debemos mirar qué clase de objeto ha generado y qué contiene</span></span>
<span id="cb36-157"><a href="#cb36-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-158"><a href="#cb36-158" aria-hidden="true" tabindex="-1"></a><span class="co">#transformamos el objeto out</span></span>
<span id="cb36-159"><a href="#cb36-159" aria-hidden="true" tabindex="-1"></a>rare <span class="ot">=</span> <span class="fu">lapply</span>(out, <span class="cf">function</span>(x){  <span class="co">#lapply aplica la función que indiquemos a todos los elementos de la lista</span></span>
<span id="cb36-160"><a href="#cb36-160" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">=</span> <span class="fu">as.data.frame</span>(x)</span>
<span id="cb36-161"><a href="#cb36-161" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">ASV =</span> b[,<span class="dv">1</span>], <span class="at">raw.read =</span> <span class="fu">rownames</span>(b))<span class="co">#me crea un dataframe con dos columnas, 'ASV' y 'raw.read' </span></span>
<span id="cb36-162"><a href="#cb36-162" aria-hidden="true" tabindex="-1"></a>  b<span class="sc">$</span>raw.read <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"N"</span>, <span class="st">""</span>,  b<span class="sc">$</span>raw.read))<span class="co">#raw.read contiene el numero de secuencias</span></span>
<span id="cb36-163"><a href="#cb36-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(b)</span>
<span id="cb36-164"><a href="#cb36-164" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb36-165"><a href="#cb36-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-166"><a href="#cb36-166" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(rare) <span class="ot">=</span> sample_names</span>
<span id="cb36-167"><a href="#cb36-167" aria-hidden="true" tabindex="-1"></a>rare <span class="ot">=</span> <span class="fu">map_dfr</span>(rare, <span class="cf">function</span>(x){<span class="co">#añadimos a cada elemento de la lista una columna llamada 'Sample'</span></span>
<span id="cb36-168"><a href="#cb36-168" aria-hidden="true" tabindex="-1"></a>  z<span class="ot">=</span> <span class="fu">data.frame</span>(x)</span>
<span id="cb36-169"><a href="#cb36-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(z)</span>
<span id="cb36-170"><a href="#cb36-170" aria-hidden="true" tabindex="-1"></a>}, <span class="at">.id =</span> <span class="st">"Sample"</span>)</span>
<span id="cb36-171"><a href="#cb36-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-172"><a href="#cb36-172" aria-hidden="true" tabindex="-1"></a><span class="co">#modificamos el objeto para adecuar la representacion grafica</span></span>
<span id="cb36-173"><a href="#cb36-173" aria-hidden="true" tabindex="-1"></a>rare<span class="sc">$</span>status<span class="ot">=</span>rare<span class="sc">$</span>Sample <span class="co">#creamos una nueva variable que contiene el nombre de las muestras</span></span>
<span id="cb36-174"><a href="#cb36-174" aria-hidden="true" tabindex="-1"></a>rare<span class="sc">$</span>status<span class="ot">=</span><span class="fu">gsub</span>(<span class="st">".*/"</span>, <span class="st">""</span>, rare<span class="sc">$</span>status)<span class="co">#eliminamos todo aquello que precede a '/'</span></span>
<span id="cb36-175"><a href="#cb36-175" aria-hidden="true" tabindex="-1"></a>rare<span class="sc">$</span>raw.read<span class="ot">=</span><span class="fu">as.numeric</span>(rare<span class="sc">$</span>raw.read)</span>
<span id="cb36-176"><a href="#cb36-176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-177"><a href="#cb36-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-178"><a href="#cb36-178" aria-hidden="true" tabindex="-1"></a>Ahora, por fin, podemos hacer el gráfico correspondiente</span>
<span id="cb36-179"><a href="#cb36-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-182"><a href="#cb36-182" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-183"><a href="#cb36-183" aria-hidden="true" tabindex="-1"></a>plot_rarefac<span class="ot">=</span><span class="fu">ggplot</span>(rare, <span class="fu">aes</span>(<span class="at">x=</span>raw.read, <span class="at">y=</span>ASV, <span class="at">colour=</span>status, <span class="at">group=</span>Sample)) <span class="sc">+</span><span class="co">#coloreamos por status de los árboles</span></span>
<span id="cb36-184"><a href="#cb36-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb36-185"><a href="#cb36-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour=</span>status), <span class="at">size=</span><span class="fl">0.85</span>)<span class="sc">+</span><span class="co">#una linea es trazada por una sucesion de muchos puntos, por lo que los puntos los pintamos por status de los arboles</span></span>
<span id="cb36-186"><a href="#cb36-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">colour=</span>status),<span class="at">linewidth=</span><span class="fl">1.2</span>)<span class="sc">+</span><span class="co">#la linea que une los puntos también</span></span>
<span id="cb36-187"><a href="#cb36-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">min</span>(<span class="fu">sample_sums</span>(phy_pruned))), <span class="at">lty=</span><span class="dv">1</span>, <span class="at">colour=</span><span class="st">"black"</span>)<span class="sc">+</span>  <span class="co">#representamos una line vertical en x=minimo numero de secuencias</span></span>
<span id="cb36-188"><a href="#cb36-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"healthy"</span><span class="ot">=</span><span class="st">"green"</span>,<span class="st">"diseased"</span><span class="ot">=</span><span class="st">"black"</span>))<span class="sc">+</span> <span class="co">#ponemos los colores concretos que queramos, por condicion de los arboles</span></span>
<span id="cb36-189"><a href="#cb36-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"healthy"</span><span class="ot">=</span><span class="st">"green"</span>, <span class="st">"diseased"</span><span class="ot">=</span><span class="st">"black"</span>),</span>
<span id="cb36-190"><a href="#cb36-190" aria-hidden="true" tabindex="-1"></a>                     <span class="at">name=</span><span class="st">"Tree status"</span>,</span>
<span id="cb36-191"><a href="#cb36-191" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks=</span><span class="fu">c</span>(<span class="st">"healthy"</span>, <span class="st">"diseased"</span>),</span>
<span id="cb36-192"><a href="#cb36-192" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>, <span class="st">"Symptomatic"</span>))<span class="sc">+</span></span>
<span id="cb36-193"><a href="#cb36-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span> <span class="st">"Rarefaction curves"</span>, <span class="at">x=</span><span class="st">"Number of sequences"</span>, <span class="at">y=</span><span class="st">"Number of ASV"</span>)<span class="sc">+</span></span>
<span id="cb36-194"><a href="#cb36-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">alpha=</span>none)<span class="sc">+</span></span>
<span id="cb36-195"><a href="#cb36-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key=</span><span class="fu">element_blank</span>(),</span>
<span id="cb36-196"><a href="#cb36-196" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>,<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb36-197"><a href="#cb36-197" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb36-198"><a href="#cb36-198" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb36-199"><a href="#cb36-199" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>, <span class="at">size=</span><span class="dv">16</span>),</span>
<span id="cb36-200"><a href="#cb36-200" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>))</span>
<span id="cb36-201"><a href="#cb36-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-202"><a href="#cb36-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-203"><a href="#cb36-203" aria-hidden="true" tabindex="-1"></a>Para poder visualizar el gráfico, podemos abrir una nueva pantalla de la siguiente forma:</span>
<span id="cb36-204"><a href="#cb36-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-205"><a href="#cb36-205" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb36-206"><a href="#cb36-206" aria-hidden="true" tabindex="-1"></a><span class="in">x11()</span></span>
<span id="cb36-207"><a href="#cb36-207" aria-hidden="true" tabindex="-1"></a><span class="in">plot_rarefac# ¡OJO! Debemos seleccionar estas dos líneas y correrlas juntas. Si se sucesivamente (de una en una), no visualizaremos el gráfico</span></span>
<span id="cb36-208"><a href="#cb36-208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-209"><a href="#cb36-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-210"><a href="#cb36-210" aria-hidden="true" tabindex="-1"></a>Si queremos guardar el gráfico con alta calidad en nuestro directorio de trabajo:</span>
<span id="cb36-211"><a href="#cb36-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-212"><a href="#cb36-212" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb36-213"><a href="#cb36-213" aria-hidden="true" tabindex="-1"></a><span class="in">ggsave(filename = "Rarefaccion_curve.jpg", plot = plot_rarefac,device = tiff(),width = 18, height = 16, units = "cm", dpi = 800)#aqui podemos indicarle el tamaño y resolucion que queramos</span></span>
<span id="cb36-214"><a href="#cb36-214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-215"><a href="#cb36-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-216"><a href="#cb36-216" aria-hidden="true" tabindex="-1"></a>La figura obtenida es exactamente la Figura 1.</span>
<span id="cb36-217"><a href="#cb36-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-218"><a href="#cb36-218" aria-hidden="true" tabindex="-1"></a><span class="al">![Figura 1. Curvas de rarefacción de las muestras correspondientes a los árboles sanos y enfermos.](images/Rarefaccion_curve.jpg)</span></span>
<span id="cb36-219"><a href="#cb36-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-220"><a href="#cb36-220" aria-hidden="true" tabindex="-1"></a>¿Qué podemos deducir de estas curvas de esfuerzo? ¿La profundidad de la secuenciación es suficiente? ¿Tienen todas las muestras la misma riqueza?</span>
<span id="cb36-221"><a href="#cb36-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-222"><a href="#cb36-222" aria-hidden="true" tabindex="-1"></a><span class="fu"># 5. Depuración de muestras</span></span>
<span id="cb36-223"><a href="#cb36-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-224"><a href="#cb36-224" aria-hidden="true" tabindex="-1"></a>Como hemos visto en la Figura 1, hay muestras con un bajo número de secuencias, especialmente en el caso de los árboles asintomáticos. Podemos realizar un filtrado y eliminar dichas muestras</span>
<span id="cb36-225"><a href="#cb36-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-226"><a href="#cb36-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb36-227"><a href="#cb36-227" aria-hidden="true" tabindex="-1"></a><span class="in">#Lo primero será revisar el número de secuencias de cada muestra</span></span>
<span id="cb36-228"><a href="#cb36-228" aria-hidden="true" tabindex="-1"></a><span class="in">numsec=as.data.frame(colSums(otu_table(phy)))</span></span>
<span id="cb36-229"><a href="#cb36-229" aria-hidden="true" tabindex="-1"></a><span class="in">View(numsec)#podemos ordenar la tabla de menor a mayor para ver qué muestras son aquellas con baja profundidad de secuenciación</span></span>
<span id="cb36-230"><a href="#cb36-230" aria-hidden="true" tabindex="-1"></a><span class="in">numsec</span></span>
<span id="cb36-231"><a href="#cb36-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-232"><a href="#cb36-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-233"><a href="#cb36-233" aria-hidden="true" tabindex="-1"></a>Tal y como vemos, la muestra 'prASH10E' tan solo tiene 576 muestras de calidad. Es un número muy bajo, por lo que procedemos a eliminarla.</span>
<span id="cb36-234"><a href="#cb36-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-237"><a href="#cb36-237" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-238"><a href="#cb36-238" aria-hidden="true" tabindex="-1"></a>phy_pruned<span class="ot">=</span><span class="fu">subset_samples</span>(phy, samples <span class="sc">!=</span> <span class="st">"prASH10E"</span>)<span class="co">#eliminamos la muestra y creamos un nuevo objeto phyloseq</span></span>
<span id="cb36-239"><a href="#cb36-239" aria-hidden="true" tabindex="-1"></a>numsec_pruned<span class="ot">=</span><span class="fu">as.data.frame</span>(<span class="fu">colSums</span>(<span class="fu">otu_table</span>(phy_pruned)))<span class="co">#revisamos de nuevo el numero de secuencias</span></span>
<span id="cb36-240"><a href="#cb36-240" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(numsec_pruned)</span>
<span id="cb36-241"><a href="#cb36-241" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">" "</span><span class="ot">=</span><span class="fu">rownames</span>(numsec_pruned),numsec_pruned),<span class="at">file=</span><span class="st">"NumerofWorkingSequences_Bacteria.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)<span class="co">#guardamos con el formato adecuado</span></span>
<span id="cb36-242"><a href="#cb36-242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-243"><a href="#cb36-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-244"><a href="#cb36-244" aria-hidden="true" tabindex="-1"></a>En este punto, debemos volver a calcular las curvas de rarefacción para ver cómo han quedado</span>
<span id="cb36-245"><a href="#cb36-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-246"><a href="#cb36-246" aria-hidden="true" tabindex="-1"></a>Ejercicio: calcularlas de nuevo</span>
<span id="cb36-247"><a href="#cb36-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-248"><a href="#cb36-248" aria-hidden="true" tabindex="-1"></a>En la Figura 2 se puede observar el resultado</span>
<span id="cb36-249"><a href="#cb36-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-250"><a href="#cb36-250" aria-hidden="true" tabindex="-1"></a><span class="al">![Figura 2. Curvas de rarefacción de las muestras correspondientes a los árboles sanos y enfermos, tras eliminar una muestra.](images/Rarefaccion_curve_pruned.jpg)</span></span>
<span id="cb36-251"><a href="#cb36-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-252"><a href="#cb36-252" aria-hidden="true" tabindex="-1"></a><span class="fu"># 6. Índices de diversidad alpha</span></span>
<span id="cb36-253"><a href="#cb36-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-254"><a href="#cb36-254" aria-hidden="true" tabindex="-1"></a>La **diversidad alpha** es la diversidad existente en cada muestra (o grupo de muestras), es decir, a escala local. Para medirla, se emplean diferentes índices de diversidad, riqueza y equidad:</span>
<span id="cb36-255"><a href="#cb36-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-256"><a href="#cb36-256" aria-hidden="true" tabindex="-1"></a>-**Riqueza observada**: se trata del número de especies diferentes presentes en una muestra. No tiene en cuenta la abundancia de cada una. Se suele emplear directamente el conteo de ASVs totales.</span>
<span id="cb36-257"><a href="#cb36-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-258"><a href="#cb36-258" aria-hidden="true" tabindex="-1"></a>-**Índice de Shannon (H')**: Se calcula tal y como se especifica en la Ecuación 1.</span>
<span id="cb36-259"><a href="#cb36-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-260"><a href="#cb36-260" aria-hidden="true" tabindex="-1"></a><span class="al">![Ecuación 1. Índice de Shannon (H'), donde S es el número de especies diferentes, pi es la frecuencia de la especie i respecto al total de individuos (abundancia relativa).](images/Shannon.jpg)</span></span>
<span id="cb36-261"><a href="#cb36-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-262"><a href="#cb36-262" aria-hidden="true" tabindex="-1"></a>El índice de Shannon tiene pues en cuenta tanto la riqueza como la abundancia relativa de cada una de las especies, y por lo tanto, se ve influido por la profundidad de secuenciación, y es sensible a las especies raras o poco abundantes.</span>
<span id="cb36-263"><a href="#cb36-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-264"><a href="#cb36-264" aria-hidden="true" tabindex="-1"></a>-**Inversa de Simpson**: Se calcula tal y como se indica en la Ecuación 2. Es también sensible a la profundidad de muestreo, pero no se ve tan influenciado por la presencia de especies raras.</span>
<span id="cb36-265"><a href="#cb36-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-266"><a href="#cb36-266" aria-hidden="true" tabindex="-1"></a><span class="al">![Ecuación 2. Índice Inverson de Simpson (D), donde lambda es el índice de Simpson, y R la riqueza total.](images/InvSimpson.jpg)</span></span>
<span id="cb36-267"><a href="#cb36-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-268"><a href="#cb36-268" aria-hidden="true" tabindex="-1"></a>-**Equidad** o **Índice de Pielou (J')**: Se calcula diviendo el valor del índice de Shannon entre el logaritmo de la riqueza (J'= Shannon/ln R). Sus valores se encuentran comprendidos en el rango \[0,1\]. Nos indica cómo se encuentran distribuidas las especies: valores cercanos a 0 nos indican que en la muestra existe **dominancia**, es decir, la abundancia de unas especies es muy elevada (y por lo tanto, no todas las especies están igualmente distribuidas). Valores próximos a 1 nos dicen que en la muestra todas las especies tienen una abundancia relativa similar, por lo que están igualmente distribuidas y la muestra es equitativa.</span>
<span id="cb36-269"><a href="#cb36-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-270"><a href="#cb36-270" aria-hidden="true" tabindex="-1"></a>Existen muchos otros índices alpha, pero estos son los más empleados e informativos.</span>
<span id="cb36-271"><a href="#cb36-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-272"><a href="#cb36-272" aria-hidden="true" tabindex="-1"></a>Puesto que el valor de algunos índices varía en función de la profundidad de muestreo, debemos hacer una **rarefacción** de los datos. Es decir, debemos hacer un sub-muestreo y obtener subconjuntos de muestras que tengan el mismo número de secuencias. Haremos una rarefacción a la baja.</span>
<span id="cb36-273"><a href="#cb36-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-276"><a href="#cb36-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-277"><a href="#cb36-277" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)<span class="co">#establecemos un valor de semilla para que los resultados sean reproducibles</span></span>
<span id="cb36-278"><a href="#cb36-278" aria-hidden="true" tabindex="-1"></a>rarefaction <span class="ot">=</span> <span class="fu">rarefy_even_depth</span>(phy_pruned, <span class="at">sample.size =</span> <span class="fu">min</span>(<span class="fu">sample_sums</span>(phy_pruned)), <span class="at">rngseed =</span> <span class="cn">FALSE</span>) <span class="co">#nos devuelve un objeto phyloseq</span></span>
<span id="cb36-279"><a href="#cb36-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-280"><a href="#cb36-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-281"><a href="#cb36-281" aria-hidden="true" tabindex="-1"></a>Calculamos los índices alpha a partir de objeto phyloseq rarificado:</span>
<span id="cb36-282"><a href="#cb36-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-285"><a href="#cb36-285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-286"><a href="#cb36-286" aria-hidden="true" tabindex="-1"></a>indices<span class="ot">=</span><span class="fu">estimate_richness</span>(rarefaction, <span class="at">measures=</span><span class="fu">c</span>(<span class="st">"Observed"</span>, <span class="st">"InvSimpson"</span>, <span class="st">"Shannon"</span>))<span class="co">#funcion de phyloseq que calcula los indices que le indiquemos, replica a replica</span></span>
<span id="cb36-287"><a href="#cb36-287" aria-hidden="true" tabindex="-1"></a>indices<span class="sc">$</span>Pielou<span class="ot">=</span>indices<span class="sc">$</span>Shannon<span class="sc">/</span><span class="fu">log</span>(indices<span class="sc">$</span>Observed)<span class="co">#calculamos manualmente el valor de Pielou</span></span>
<span id="cb36-288"><a href="#cb36-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-289"><a href="#cb36-289" aria-hidden="true" tabindex="-1"></a>mt_indices<span class="ot">=</span><span class="fu">data.frame</span>(<span class="fu">sample_data</span>(rarefaction))<span class="co">#extraemos la tabla de metadatos del objeto rarificado</span></span>
<span id="cb36-290"><a href="#cb36-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-291"><a href="#cb36-291" aria-hidden="true" tabindex="-1"></a>indices<span class="ot">=</span><span class="fu">add_column</span>(indices, mt_indices[<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(mt_indices)], <span class="at">.after =</span>  <span class="st">"Pielou"</span>)</span>
<span id="cb36-292"><a href="#cb36-292" aria-hidden="true" tabindex="-1"></a><span class="co">#Asi le estoy pegando a la tabla de indices todos los metadatos. Indicamos que queremos que los añada antes de la columna 'Observed'</span></span>
<span id="cb36-293"><a href="#cb36-293" aria-hidden="true" tabindex="-1"></a><span class="co">#write.table(data.frame(" "=rownames(indices),indices),file="Indices_porReplicas.txt", sep="\t",row.names =F) Por si queremos guardar la tabla.</span></span>
<span id="cb36-294"><a href="#cb36-294" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-295"><a href="#cb36-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-296"><a href="#cb36-296" aria-hidden="true" tabindex="-1"></a>Hemos calculado los índices de cada réplica, pero nos interesa más calcular la media de cada grupo de muestras y la desviación estándar para poder compararlos.</span>
<span id="cb36-297"><a href="#cb36-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-300"><a href="#cb36-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-301"><a href="#cb36-301" aria-hidden="true" tabindex="-1"></a><span class="co">#¡¡OJO!! En la línea siguiente debemos indicar la posición de las columnas en las que están los valores de los indices. Recordatorio: es un dataframe que contiene caaracteres y numericos.</span></span>
<span id="cb36-302"><a href="#cb36-302" aria-hidden="true" tabindex="-1"></a><span class="co">#Para identificar esas posiciones, basta con hacer View(indices)</span></span>
<span id="cb36-303"><a href="#cb36-303" aria-hidden="true" tabindex="-1"></a>media<span class="ot">=</span> <span class="fu">aggregate</span>(indices[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="fu">list</span>(<span class="at">grouping=</span>indices<span class="sc">$</span>status), mean) <span class="sc">%&gt;%</span> <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits=</span><span class="dv">2</span>)<span class="co">#calcula la media en base al status de los árboles, y el resultado lo redondea con dos digitos</span></span>
<span id="cb36-304"><a href="#cb36-304" aria-hidden="true" tabindex="-1"></a>sd<span class="ot">=</span> <span class="fu">aggregate</span>(indices[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="fu">list</span>(<span class="at">grouping=</span>indices<span class="sc">$</span>status), sd) <span class="sc">%&gt;%</span> <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits=</span><span class="dv">2</span>)</span>
<span id="cb36-305"><a href="#cb36-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-306"><a href="#cb36-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-307"><a href="#cb36-307" aria-hidden="true" tabindex="-1"></a>Si nos interesa generar una tabla con formato de publicación (es decir, donde los valores de la media vienen seguidos del simbolo +- y la desviación estándar), podemos ejecutar estas líneas:</span>
<span id="cb36-308"><a href="#cb36-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-311"><a href="#cb36-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-312"><a href="#cb36-312" aria-hidden="true" tabindex="-1"></a>mean_sd <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb36-313"><a href="#cb36-313" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>){ <span class="co">#OJO aqui con el numero de las columnas numericas de los objetos 'mean' y 'sd'.Para comprobarlo, View(mean)</span></span>
<span id="cb36-314"><a href="#cb36-314" aria-hidden="true" tabindex="-1"></a>  mean_sd <span class="ot">=</span> <span class="fu">cbind</span>(mean_sd,<span class="fu">paste0</span>(media[,i], <span class="st">" +/- "</span>, sd[,i]))</span>
<span id="cb36-315"><a href="#cb36-315" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-316"><a href="#cb36-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-317"><a href="#cb36-317" aria-hidden="true" tabindex="-1"></a>tabla_publicaciones <span class="ot">=</span> <span class="fu">cbind</span>(media<span class="sc">$</span>grouping, mean_sd)</span>
<span id="cb36-318"><a href="#cb36-318" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tabla_publicaciones) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Group"</span>,<span class="st">"Observed"</span>, <span class="st">"Shannon"</span>, <span class="st">"InvSimpson"</span>, <span class="st">"Pielou"</span>)</span>
<span id="cb36-319"><a href="#cb36-319" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(tabla_publicaciones)</span>
<span id="cb36-320"><a href="#cb36-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-321"><a href="#cb36-321" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(tabla_publicaciones,<span class="at">file=</span><span class="st">"Indices_Media_sd.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span>
<span id="cb36-322"><a href="#cb36-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-323"><a href="#cb36-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-324"><a href="#cb36-324" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6.1 Anális estadístico</span></span>
<span id="cb36-325"><a href="#cb36-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-326"><a href="#cb36-326" aria-hidden="true" tabindex="-1"></a>Aplicaremos tests de estadística univariante para cada uno de los índices. Compararemos si los índices de los dos grupos de muestras son iguales o no. Para este análisis, utilizaremos un nivel de confianza de = 95%, por lo tomaremos un alpha = 0.05.</span>
<span id="cb36-327"><a href="#cb36-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-328"><a href="#cb36-328" aria-hidden="true" tabindex="-1"></a>Para ello, primero debemos conocer el tipo de distribución de los datos, y elegir el mejor test a aplicar.</span>
<span id="cb36-329"><a href="#cb36-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-330"><a href="#cb36-330" aria-hidden="true" tabindex="-1"></a><span class="fu">### 6.1.1 Comprobación de premisas</span></span>
<span id="cb36-331"><a href="#cb36-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-332"><a href="#cb36-332" aria-hidden="true" tabindex="-1"></a>Comenzamos aplicando el *test de Levene* con el que evaluamos si la varianza de los dos grupos a comparar es la misma o no (*homocedasticidad*). H0: los dos grupos de muestran son homocedásticos.</span>
<span id="cb36-333"><a href="#cb36-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-336"><a href="#cb36-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-337"><a href="#cb36-337" aria-hidden="true" tabindex="-1"></a>levene <span class="ot">=</span> <span class="fu">levene.test.alpha</span>(indices, <span class="dv">4</span>, <span class="st">"status"</span>) </span>
<span id="cb36-338"><a href="#cb36-338" aria-hidden="true" tabindex="-1"></a><span class="co">#argumentos: </span></span>
<span id="cb36-339"><a href="#cb36-339" aria-hidden="true" tabindex="-1"></a><span class="co">#tabla de indices calculados replica a replica (NO confundir con la tabla de publicaciones)</span></span>
<span id="cb36-340"><a href="#cb36-340" aria-hidden="true" tabindex="-1"></a><span class="co">#número de indices a testar</span></span>
<span id="cb36-341"><a href="#cb36-341" aria-hidden="true" tabindex="-1"></a><span class="co">#nombre de la variable de agrupacion (tiene que coincidir exactamente con el nombre incluido en la tabla de indices)</span></span>
<span id="cb36-342"><a href="#cb36-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-343"><a href="#cb36-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-344"><a href="#cb36-344" aria-hidden="true" tabindex="-1"></a>Observamos que para ningún índice obtenemos un pvalor superior al umbral alpha seleccionado, luego nos encontramos ante datos homocedásticos</span>
<span id="cb36-345"><a href="#cb36-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-346"><a href="#cb36-346" aria-hidden="true" tabindex="-1"></a>Comprobamos si los datos se distribuyen de forma normal <span class="sc">\[</span>Gaussiana<span class="sc">\]</span>, mediante el **test de Shapiro-Wilks**.</span>
<span id="cb36-347"><a href="#cb36-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-350"><a href="#cb36-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-351"><a href="#cb36-351" aria-hidden="true" tabindex="-1"></a>shapiro <span class="ot">=</span> <span class="fu">Shapiro</span>(indices, <span class="dv">4</span>, <span class="st">"status"</span>)</span>
<span id="cb36-352"><a href="#cb36-352" aria-hidden="true" tabindex="-1"></a>shapiro</span>
<span id="cb36-353"><a href="#cb36-353" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-354"><a href="#cb36-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-355"><a href="#cb36-355" aria-hidden="true" tabindex="-1"></a>Vemos que tan solo el índice de riqueza se distribuye de forma normal. Nos encontramos pues ante variables homocedásticas de distribución no-normal (excepto la riqueza observada).</span>
<span id="cb36-356"><a href="#cb36-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-357"><a href="#cb36-357" aria-hidden="true" tabindex="-1"></a>Los test estadísticos univariantes son muy sensibles a la heterocedasticidad, pero no tanto a la distribución no-normal de los datos. Puesto que todas nuestras variables son homocedásticas, comprobemos si los datos se alejan mucho de una distribución normal. Para ello, construiremos **gráficos de tipo Q-Q** (*quantile-quantile plot*), que nos comparan la distribución de nuestros datos vs una normal teórica:</span>
<span id="cb36-358"><a href="#cb36-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-361"><a href="#cb36-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-362"><a href="#cb36-362" aria-hidden="true" tabindex="-1"></a>qq_invsimpson<span class="ot">=</span><span class="fu">ggqqplot</span>(indices, <span class="st">"InvSimpson"</span>, <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>())</span>
<span id="cb36-363"><a href="#cb36-363" aria-hidden="true" tabindex="-1"></a>qq_sha<span class="ot">=</span><span class="fu">ggqqplot</span>(indices, <span class="st">"Shannon"</span>, <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>())</span>
<span id="cb36-364"><a href="#cb36-364" aria-hidden="true" tabindex="-1"></a>qq_pielou<span class="ot">=</span><span class="fu">ggqqplot</span>(indices, <span class="st">"Pielou"</span>, <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>())</span>
<span id="cb36-365"><a href="#cb36-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-366"><a href="#cb36-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-367"><a href="#cb36-367" aria-hidden="true" tabindex="-1"></a>En las Figuras 3-5 podemos ver la distribución de las variables. Apreciamos que no se separan mucho de la normalidad teórica, por lo que aplicaremos test univariantes paramétricos.</span>
<span id="cb36-368"><a href="#cb36-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-369"><a href="#cb36-369" aria-hidden="true" tabindex="-1"></a><span class="al">![Figura 3. Gráfico Q-Q del Inverso de Simpson.](images/qq_inv.jpg)</span> </span>
<span id="cb36-370"><a href="#cb36-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-371"><a href="#cb36-371" aria-hidden="true" tabindex="-1"></a><span class="al">![Figura 4. Gráfico Q-Q del índice de Shannon](images/qq_shannon.jpg)</span></span>
<span id="cb36-372"><a href="#cb36-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-373"><a href="#cb36-373" aria-hidden="true" tabindex="-1"></a><span class="al">![Figura 5. Gráfico Q-Q del índice de Pielou.](images/qq_pielou.jpg)</span></span>
<span id="cb36-374"><a href="#cb36-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-375"><a href="#cb36-375" aria-hidden="true" tabindex="-1"></a><span class="fu">### 6.1.2 Aplicación de test estadísticos</span></span>
<span id="cb36-376"><a href="#cb36-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-377"><a href="#cb36-377" aria-hidden="true" tabindex="-1"></a>Puesto que queremos comparar dos grupos de muestras, y teniendo en cuenta los comentarios realizados sobre la distribución de las muestras, aplicaremos el **test t-Student** a todos los índices. H0: no hay diferencias en la media de los dos grupos</span>
<span id="cb36-378"><a href="#cb36-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-381"><a href="#cb36-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-382"><a href="#cb36-382" aria-hidden="true" tabindex="-1"></a>tstudent <span class="ot">=</span><span class="fu">Tukey.test</span>(indices, <span class="dv">4</span>, <span class="st">"status"</span>, <span class="at">balanced=</span>F)<span class="co"># Incorpora un argumento más, 'balanced', de tipo booleriano. En este caso, puesto que tenemos un ligero desbalance en los datos, le decimos que FALSE</span></span>
<span id="cb36-383"><a href="#cb36-383" aria-hidden="true" tabindex="-1"></a>tstudent</span>
<span id="cb36-384"><a href="#cb36-384" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-385"><a href="#cb36-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-386"><a href="#cb36-386" aria-hidden="true" tabindex="-1"></a>En la tabla de salida apreciamos que el pvalor en todos los casos es <span class="sc">\&lt;</span> 0.05, por lo que rechazamos la hipótesis nula, determinando que la diversidad, riqueza y equidad de los árboles sanos y enfermos es significativamente diferente.</span>
<span id="cb36-387"><a href="#cb36-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-388"><a href="#cb36-388" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb36-389"><a href="#cb36-389" aria-hidden="true" tabindex="-1"></a>**MUY IMPORTANTE**: cada variable debe inspeccionarse y tratarse de forma independiente. En este caso, hemos detectado que casi todas las variables se distribuyen de la misma manera, por lo que hemos usado la función *Tukey.test* del paquete micro4all, que aplica el mismo test a todas las variables incluidas en nuestra table. Si cada una de nuestras variables tiene una distribución o características concretas (paramétrica, heterocedástica, no-paramétrica), debemos aplicar el test más adecuado para cada variable. En ese caso, no es recomendable emplear las funciones incluidas en el paquete micro4all, sino las incluidas en el paquete **rstatix**, tratando cada una de forma independiente.</span>
<span id="cb36-390"><a href="#cb36-390" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-391"><a href="#cb36-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-392"><a href="#cb36-392" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb36-393"><a href="#cb36-393" aria-hidden="true" tabindex="-1"></a>Es **importante** tener en cuenta que el hecho de que tengamos un pvalor muy bajo **NO** significa que las diferencias observadas sean grandes. Para obtener información sobre la magnitud de las diferencias, calculamos el **tamaño del efecto**, que, al tratarse de comparaciones de dos grupos, debemos calcular la **d de Cohen** (*Cohen's d*).</span>
<span id="cb36-394"><a href="#cb36-394" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-395"><a href="#cb36-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-398"><a href="#cb36-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-399"><a href="#cb36-399" aria-hidden="true" tabindex="-1"></a><span class="co">#hacemos un bucle for sobre la funcion cohens_d </span></span>
<span id="cb36-400"><a href="#cb36-400" aria-hidden="true" tabindex="-1"></a>cohen <span class="ot">=</span><span class="fu">data.frame</span>()</span>
<span id="cb36-401"><a href="#cb36-401" aria-hidden="true" tabindex="-1"></a>columnas <span class="ot">=</span><span class="fu">names</span>(indices)[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]  <span class="co">#que coja los nombres de las 1as 4 columnas donde estan los indices</span></span>
<span id="cb36-402"><a href="#cb36-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-403"><a href="#cb36-403" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> columnas) {</span>
<span id="cb36-404"><a href="#cb36-404" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">=</span> <span class="fu">cohens_d</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(i, <span class="st">"~ status"</span>)), <span class="at">data =</span> indices)<span class="sc">$</span>effsize</span>
<span id="cb36-405"><a href="#cb36-405" aria-hidden="true" tabindex="-1"></a>  mag <span class="ot">=</span> <span class="fu">cohens_d</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(i, <span class="st">"~ status"</span>)), <span class="at">data =</span> indices)<span class="sc">$</span>magnitude</span>
<span id="cb36-406"><a href="#cb36-406" aria-hidden="true" tabindex="-1"></a>  cohen <span class="ot">=</span> <span class="fu">rbind</span>(cohen, <span class="fu">data.frame</span>(<span class="at">variable =</span> i, <span class="at">cohen_d =</span> d, <span class="at">magnitude=</span>mag))</span>
<span id="cb36-407"><a href="#cb36-407" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-408"><a href="#cb36-408" aria-hidden="true" tabindex="-1"></a>cohen<span class="co">#nos devuelve la variable y el tamaño del efecto. </span></span>
<span id="cb36-409"><a href="#cb36-409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-410"><a href="#cb36-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-411"><a href="#cb36-411" aria-hidden="true" tabindex="-1"></a>El tamaño del efecto se clasifica en categorías en función del valor de la d de Cohen:</span>
<span id="cb36-412"><a href="#cb36-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-413"><a href="#cb36-413" aria-hidden="true" tabindex="-1"></a>si d <span class="sc">\&lt;</span> 0.2 --<span class="sc">\&gt;</span> no efecto si 0.21 <span class="sc">\&lt;</span> d <span class="sc">\&lt;</span> 0.49 --<span class="sc">\&gt;</span> efecto pequeño si 0.5 <span class="sc">\&lt;</span> d <span class="sc">\&lt;</span> 0.8 --<span class="sc">\&gt;</span> efecto moderado si d <span class="sc">\&gt;</span> 0.8 --<span class="sc">\&gt;</span> efecto grande</span>
<span id="cb36-414"><a href="#cb36-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-415"><a href="#cb36-415" aria-hidden="true" tabindex="-1"></a>Por lo tanto, para todos nuestros indices, las diferencias observadas podemos clasificarlas como 'Grandes'</span>
<span id="cb36-416"><a href="#cb36-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-417"><a href="#cb36-417" aria-hidden="true" tabindex="-1"></a><span class="fu">### 6.1.3 Representación gráfica</span></span>
<span id="cb36-418"><a href="#cb36-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-419"><a href="#cb36-419" aria-hidden="true" tabindex="-1"></a>Los valores de los índices en tablas son muy útiles pero, una imagen vale más que mil palabras. Se pueden hacer distintos tipos de gráficos, pero haremos boxplots ya que nos dan una idea de la dispersión de cada uno de los índices.</span>
<span id="cb36-420"><a href="#cb36-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-423"><a href="#cb36-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-424"><a href="#cb36-424" aria-hidden="true" tabindex="-1"></a>alpha_plot_table<span class="ot">=</span>tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">data =</span> indices, <span class="at">names_to =</span> <span class="st">"Measure"</span>, <span class="at">values_to =</span> <span class="st">"Value"</span>, <span class="at">cols=</span><span class="fu">c</span>(Observed, Shannon, InvSimpson, Pielou))<span class="co">#esta funcion sirve para que tranforme la tabla y todos los valores de todos los índices estén en una sola columna, apilados.</span></span>
<span id="cb36-425"><a href="#cb36-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-426"><a href="#cb36-426" aria-hidden="true" tabindex="-1"></a>alpha_graphic<span class="ot">=</span><span class="fu">ggplot</span>(<span class="at">data =</span> alpha_plot_table, <span class="fu">aes</span>(<span class="at">x =</span> status, <span class="at">y =</span> Value)) <span class="sc">+</span></span>
<span id="cb36-427"><a href="#cb36-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">factor</span>(Measure, <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"Observed"</span>, <span class="st">"InvSimpson"</span>,<span class="st">"Shannon"</span>, <span class="st">"Pielou"</span>)), <span class="at">scale =</span> <span class="st">"free"</span>) <span class="sc">+</span> <span class="co">#generamos una grafica por índice</span></span>
<span id="cb36-428"><a href="#cb36-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb36-429"><a href="#cb36-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="st">"healthy"</span>,<span class="st">"diseased"</span>), </span>
<span id="cb36-430"><a href="#cb36-430" aria-hidden="true" tabindex="-1"></a>                   <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>,<span class="st">"Symptomatic"</span>)) <span class="sc">+</span></span>
<span id="cb36-431"><a href="#cb36-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">fill=</span>status)<span class="sc">+</span> </span>
<span id="cb36-432"><a href="#cb36-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"healthy"</span><span class="ot">=</span><span class="st">"green"</span>,<span class="st">"diseased"</span><span class="ot">=</span><span class="st">"black"</span>),</span>
<span id="cb36-433"><a href="#cb36-433" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks=</span><span class="fu">c</span>(<span class="st">"healthy"</span>,<span class="st">"diseased"</span>), </span>
<span id="cb36-434"><a href="#cb36-434" aria-hidden="true" tabindex="-1"></a>                   <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>,<span class="st">"Symptomatic"</span>),<span class="at">na.translate=</span><span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb36-435"><a href="#cb36-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">'cm'</span>)) <span class="sc">+</span></span>
<span id="cb36-436"><a href="#cb36-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(<span class="st">"Endosphere ("</span> <span class="sc">*</span><span class="fu">italic</span>(<span class="st">"P. sylvestris"</span>)<span class="sc">*</span> <span class="st">")"</span>))<span class="sc">+</span></span>
<span id="cb36-437"><a href="#cb36-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">13</span>),</span>
<span id="cb36-438"><a href="#cb36-438" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb36-439"><a href="#cb36-439" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>), </span>
<span id="cb36-440"><a href="#cb36-440" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb36-441"><a href="#cb36-441" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb36-442"><a href="#cb36-442" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb36-443"><a href="#cb36-443" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position=</span><span class="st">"bottom"</span>,</span>
<span id="cb36-444"><a href="#cb36-444" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb36-445"><a href="#cb36-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-446"><a href="#cb36-446" aria-hidden="true" tabindex="-1"></a><span class="co">#x11() #comentando x11() logramos que el grafico se vea en el visualizador de graficos, en el panel derecho --&gt;</span></span>
<span id="cb36-447"><a href="#cb36-447" aria-hidden="true" tabindex="-1"></a>alpha_graphic</span>
<span id="cb36-448"><a href="#cb36-448" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-449"><a href="#cb36-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-450"><a href="#cb36-450" aria-hidden="true" tabindex="-1"></a><span class="fu"># 7. Diversidad beta</span></span>
<span id="cb36-451"><a href="#cb36-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-452"><a href="#cb36-452" aria-hidden="true" tabindex="-1"></a>Para conocer la diversidad de cada grupo de muestras y de forma relativa al resto de grupo de muestras, calcularemos la **diversidad beta**. Es un tipo de diversidad *regional*.</span>
<span id="cb36-453"><a href="#cb36-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-454"><a href="#cb36-454" aria-hidden="true" tabindex="-1"></a>En este apartado, calcularemos la diversidad, la representaremos gráficamente y la compararemos mediante métodos de estadística multivariante.</span>
<span id="cb36-455"><a href="#cb36-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-456"><a href="#cb36-456" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7.1 Normalización de los datos</span></span>
<span id="cb36-457"><a href="#cb36-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-458"><a href="#cb36-458" aria-hidden="true" tabindex="-1"></a>Nuestra tabla de ASVs original está constituida por el número de ocurrencias de cada ASV en cada muestra (número de secuencias de cada ASV). Podemos tener ASVs para los que se han detectado 5 secuencias, y otros representados por 5000 secuencias. Es necesario **escalar** los valores y transformarlos todos al mismo rango. Existen diferentes tipos de normalizaciones para evitar estos posibles sesgos, como la transformación logarítmica, o la normalización que aplica EdgeR. Emplearemos esta por su popularidad:</span>
<span id="cb36-459"><a href="#cb36-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-462"><a href="#cb36-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-463"><a href="#cb36-463" aria-hidden="true" tabindex="-1"></a><span class="co">#Lo primero es obtener nuevos objetos phyloseq normalizados</span></span>
<span id="cb36-464"><a href="#cb36-464" aria-hidden="true" tabindex="-1"></a>ASV_pruned<span class="ot">=</span><span class="fu">data.frame</span>(<span class="fu">otu_table</span>(phy_pruned,<span class="at">taxa_are_rows =</span> T))</span>
<span id="cb36-465"><a href="#cb36-465" aria-hidden="true" tabindex="-1"></a>mt_pruned<span class="ot">=</span><span class="fu">data.frame</span>(<span class="fu">sample_data</span>(phy_pruned))</span>
<span id="cb36-466"><a href="#cb36-466" aria-hidden="true" tabindex="-1"></a>tax_pruned<span class="ot">=</span><span class="fu">data.frame</span>(<span class="fu">tax_table</span>(phy_pruned))</span>
<span id="cb36-467"><a href="#cb36-467" aria-hidden="true" tabindex="-1"></a>tree_pruned<span class="ot">=</span><span class="fu">phy_tree</span>(phy_pruned)</span>
<span id="cb36-468"><a href="#cb36-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-469"><a href="#cb36-469" aria-hidden="true" tabindex="-1"></a><span class="co">#Creamos un objeto DGE necesario para hacer la normalizacion</span></span>
<span id="cb36-470"><a href="#cb36-470" aria-hidden="true" tabindex="-1"></a>edgeR <span class="ot">=</span> <span class="fu">DGEList</span>(<span class="at">counts =</span> ASV_pruned, <span class="at">samples =</span> mt_pruned, <span class="at">genes =</span> tax_pruned)</span>
<span id="cb36-471"><a href="#cb36-471" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculamos los factores de normalizacion para corregir la diferencia de profundidad de muestreo y los datos relativos</span></span>
<span id="cb36-472"><a href="#cb36-472" aria-hidden="true" tabindex="-1"></a>edgeR <span class="ot">=</span> <span class="fu">calcNormFactors</span>(edgeR)</span>
<span id="cb36-473"><a href="#cb36-473" aria-hidden="true" tabindex="-1"></a><span class="co">#Extraemos la abundancia normalizada</span></span>
<span id="cb36-474"><a href="#cb36-474" aria-hidden="true" tabindex="-1"></a>ASV_pruned_norm <span class="ot">=</span> <span class="fu">cpm</span>(edgeR, <span class="at">normalized.lib.sizes=</span>T, <span class="at">log=</span>F)</span>
<span id="cb36-475"><a href="#cb36-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-476"><a href="#cb36-476" aria-hidden="true" tabindex="-1"></a><span class="co">#Volvemos a crear un objeto phyloseq con los datos normalizados</span></span>
<span id="cb36-477"><a href="#cb36-477" aria-hidden="true" tabindex="-1"></a>phy_ASV_norm<span class="ot">=</span><span class="fu">otu_table</span>(<span class="fu">as.data.frame</span>(ASV_pruned_norm,<span class="at">row.names=</span>F), <span class="at">taxa_are_rows =</span> T)</span>
<span id="cb36-478"><a href="#cb36-478" aria-hidden="true" tabindex="-1"></a>phy_taxonomy_norm<span class="ot">=</span><span class="fu">tax_table</span>(<span class="fu">as.matrix</span>(tax_pruned))</span>
<span id="cb36-479"><a href="#cb36-479" aria-hidden="true" tabindex="-1"></a>phy_metadata_norm<span class="ot">=</span><span class="fu">sample_data</span>(mt_pruned)</span>
<span id="cb36-480"><a href="#cb36-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-481"><a href="#cb36-481" aria-hidden="true" tabindex="-1"></a><span class="co">#Añadimos el nombre de los taxones</span></span>
<span id="cb36-482"><a href="#cb36-482" aria-hidden="true" tabindex="-1"></a><span class="fu">taxa_names</span>(phy_ASV_norm)<span class="ot">=</span> <span class="fu">taxa_names</span>(phy_taxonomy_norm)</span>
<span id="cb36-483"><a href="#cb36-483" aria-hidden="true" tabindex="-1"></a><span class="co">#Comprobamos que sean identicos</span></span>
<span id="cb36-484"><a href="#cb36-484" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">rownames</span>(phy_ASV_norm), <span class="fu">rownames</span>(phy_taxonomy_norm))</span>
<span id="cb36-485"><a href="#cb36-485" aria-hidden="true" tabindex="-1"></a><span class="co">#Fusionamos todos los componentes del phyloseq</span></span>
<span id="cb36-486"><a href="#cb36-486" aria-hidden="true" tabindex="-1"></a>normalized_phyloseq <span class="ot">=</span> <span class="fu">phyloseq</span>(phy_ASV_norm,</span>
<span id="cb36-487"><a href="#cb36-487" aria-hidden="true" tabindex="-1"></a>                               phy_taxonomy_norm,</span>
<span id="cb36-488"><a href="#cb36-488" aria-hidden="true" tabindex="-1"></a>                               phy_metadata_norm,</span>
<span id="cb36-489"><a href="#cb36-489" aria-hidden="true" tabindex="-1"></a>                               tree_pruned)</span>
<span id="cb36-490"><a href="#cb36-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-491"><a href="#cb36-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-492"><a href="#cb36-492" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7.2 Comparación de diversidad beta entre grupos de muestras</span></span>
<span id="cb36-493"><a href="#cb36-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-494"><a href="#cb36-494" aria-hidden="true" tabindex="-1"></a>Aplicaremos técnicas de estadística multivariante tanto para comparar los grupos de muestras entre sí como para visualizar las diferencias entre ellos.</span>
<span id="cb36-495"><a href="#cb36-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-496"><a href="#cb36-496" aria-hidden="true" tabindex="-1"></a>La versión multivariante del test de Levene (homocedasticidad) es el **test PERMDISP2**. El concepto es el mismo: probar la dispersión de todos los grupos de muestras (llamada *betadispersión*) es la misma. En este caso, tendremos muchas variables (la abundancia de cada ASV en cada una de las muestras).</span>
<span id="cb36-497"><a href="#cb36-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-498"><a href="#cb36-498" aria-hidden="true" tabindex="-1"></a>Por otro lado, para comparar si el centroide (concepto similar al de *media* en el espacio multivariante) de ambos grupos de muestras es el mismo, se emplea el **test PERMANOVA**, el cual no asume ningún tipo de distribución de los datos y es el equivalente multivariante al test univariante de ANOVA.</span>
<span id="cb36-499"><a href="#cb36-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-500"><a href="#cb36-500" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb36-501"><a href="#cb36-501" aria-hidden="true" tabindex="-1"></a>En el caso multivariante, el test PERMANOVA **NO** es sensible a la heterocedasticidad si tenemos un diseño **balanceado**, por lo que en casos balanceados no se suele aplicar. Sin embargo, si tenemos un número diferente de réplicas en cada grupo de muestras (como en este ejercicio), y estas son heterocedásticas, el test PERMANOVA no es capaz de distinguir si las diferencias detectadas son debidas a diferencias reales en el centroide o en la dispersión de las muestras. Por consiguiente, en casos de diseño desbalanceado es **esencial** aplicar el test PERMDISP2</span>
<span id="cb36-502"><a href="#cb36-502" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-503"><a href="#cb36-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-504"><a href="#cb36-504" aria-hidden="true" tabindex="-1"></a>Para poder comparar entre sí los grupos de muestras, ha de hacerse en base a una medida de distancia o disimilitud. Existen diferentes tipos de **medidas de distancia o disimilitud** (1-similitud), entre las cuales queremos destacar estas tres:</span>
<span id="cb36-505"><a href="#cb36-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-506"><a href="#cb36-506" aria-hidden="true" tabindex="-1"></a>-**Disimilitud Bray-Curstis**: tiene en cuenta la abundancia de las especies</span>
<span id="cb36-507"><a href="#cb36-507" aria-hidden="true" tabindex="-1"></a>-**Distancia Unweighted UniFrac**: tiene en cuenta la distancia filogenética de las especies, pero **NO** su abundancia. -**Distancia Weighted-UniFrac**: tiene en cuenta tanto la distancia filogenética de las especies que componen los pares de muestas, como la abundancia de cada una de ellas.</span>
<span id="cb36-508"><a href="#cb36-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-509"><a href="#cb36-509" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb36-510"><a href="#cb36-510" aria-hidden="true" tabindex="-1"></a>Podemos seleccionar cualquiera de las tres, pero solo en el caso de bacterias. En el caso de los hongos **NO** podremos seleccionar las distancias UniFrac puesto que al ser ITS2 variable en longitud, no disponemos de un árbol filogenético.</span>
<span id="cb36-511"><a href="#cb36-511" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-512"><a href="#cb36-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-515"><a href="#cb36-515" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-516"><a href="#cb36-516" aria-hidden="true" tabindex="-1"></a><span class="co">#Aplicaremos varias funciones del paquete micro4all para poder implementar el test PERMDISP2 y PERMANOVA basándonos en las tres distancias</span></span>
<span id="cb36-517"><a href="#cb36-517" aria-hidden="true" tabindex="-1"></a><span class="co"># BETADISPERSION</span></span>
<span id="cb36-518"><a href="#cb36-518" aria-hidden="true" tabindex="-1"></a><span class="co">#¡¡OJO!! Debemos trabajar con los datos normalizados</span></span>
<span id="cb36-519"><a href="#cb36-519" aria-hidden="true" tabindex="-1"></a>betadisper <span class="ot">=</span> <span class="fu">Betadispersion</span>(normalized_phyloseq,<span class="at">distances =</span> <span class="fu">c</span>(<span class="st">"bray"</span>, <span class="st">"unifrac"</span>, <span class="st">"wunifrac"</span>), <span class="at">formula =</span> <span class="st">"status"</span>) </span>
<span id="cb36-520"><a href="#cb36-520" aria-hidden="true" tabindex="-1"></a><span class="co">#argumentos:</span></span>
<span id="cb36-521"><a href="#cb36-521" aria-hidden="true" tabindex="-1"></a>  <span class="co">#-objeto phyloseq normalizado</span></span>
<span id="cb36-522"><a href="#cb36-522" aria-hidden="true" tabindex="-1"></a>  <span class="co">#-distancias a calcular</span></span>
<span id="cb36-523"><a href="#cb36-523" aria-hidden="true" tabindex="-1"></a>  <span class="co">#formula: introducir el nombre de la variable de agrupación</span></span>
<span id="cb36-524"><a href="#cb36-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-525"><a href="#cb36-525" aria-hidden="true" tabindex="-1"></a>betadisper[<span class="dv">1</span>]<span class="co"># en el elemento 1 de la lista, podemos ver los resultados del test para las tres medidas de disimilitud</span></span>
<span id="cb36-526"><a href="#cb36-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-527"><a href="#cb36-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-528"><a href="#cb36-528" aria-hidden="true" tabindex="-1"></a>No podemos rechazar la H0 para ninguna de las medidas de disimilitud seleccionadas (p &gt; 0.05), por lo que estamos ante datos homocedásticos. Es genial, puesto que podremos confiar en los resultados del PERMANOVA aunque nuestros datos estén ligeramente desbalanceados.</span>
<span id="cb36-529"><a href="#cb36-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-532"><a href="#cb36-532" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-533"><a href="#cb36-533" aria-hidden="true" tabindex="-1"></a>permanova <span class="ot">=</span> <span class="fu">Permanova</span>(normalized_phyloseq,<span class="at">distances =</span> <span class="fu">c</span>(<span class="st">"bray"</span>, <span class="st">"unifrac"</span>, <span class="st">"wunifrac"</span>), <span class="at">formula =</span> <span class="st">"status"</span>) <span class="co">#misma lógica que para la funcion anterior.</span></span>
<span id="cb36-534"><a href="#cb36-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-535"><a href="#cb36-535" aria-hidden="true" tabindex="-1"></a>permanova[<span class="dv">1</span>]</span>
<span id="cb36-536"><a href="#cb36-536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-537"><a href="#cb36-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-538"><a href="#cb36-538" aria-hidden="true" tabindex="-1"></a>**Interpretación**: en este caso, tendremos en cuenta varios parámetros del test PERMANOVA, para cada medida de disimilitud:</span>
<span id="cb36-539"><a href="#cb36-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-540"><a href="#cb36-540" aria-hidden="true" tabindex="-1"></a>-**Valor de R2**: nos indica el porcentaje de la varianza total que explica nuestra variable de agrupación (estado de los árboles). El resto (residuales) es explicado por factores no medidos en el experimento. En nuestro caso, gracias a la medida Weighted-UniFrac, la condición de los árboles llega a explicar hasta un 64.6% de todas las diferencias reales existentes entre los dos grupos de muestras.</span>
<span id="cb36-541"><a href="#cb36-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-542"><a href="#cb36-542" aria-hidden="true" tabindex="-1"></a>-**p-valor**: rechazmos la H0 de igualdad de centroides: vemos que las muestras son significativamente diferentes entre sí en base a cualquiera de las distancias seleccionadas.</span>
<span id="cb36-543"><a href="#cb36-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-544"><a href="#cb36-544" aria-hidden="true" tabindex="-1"></a>Ya hemos detectado diferencias, pero ¿de qué magnitud son estas?</span>
<span id="cb36-545"><a href="#cb36-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-546"><a href="#cb36-546" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb36-547"><a href="#cb36-547" aria-hidden="true" tabindex="-1"></a>Es **importante** tener en cuenta que el hecho de que tengamos un pvalor muy bajo y/o un R2 muy alto **NO** tiene porqué indicar que las diferencias observadas son grandes. El valor de R2 simplemente nos indica cuán responsable es nuestro factor de agrupación de las diferencias que observamos, sean estas pequeñas o grandes. Para obtener información sobre la magnitud de las diferencias, calculamos el **tamaño del efecto**.</span>
<span id="cb36-548"><a href="#cb36-548" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-549"><a href="#cb36-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-550"><a href="#cb36-550" aria-hidden="true" tabindex="-1"></a>Para calcular el tamaño del efecto (en estadística multivariante conocido también como *partial omega square*), debemos seleccionar primero con qué medida de disimilitud vamos a trabajar (no es operativo trabajar con tres medidas si ya tenemos una que explica gran porcentaje de la varianza).</span>
<span id="cb36-551"><a href="#cb36-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-554"><a href="#cb36-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-555"><a href="#cb36-555" aria-hidden="true" tabindex="-1"></a><span class="co">#tenemos que guardar el resultado de nuestro test en una variable.</span></span>
<span id="cb36-556"><a href="#cb36-556" aria-hidden="true" tabindex="-1"></a><span class="co">#Para ello, guardaremos también el valor de las distancias en una variable:</span></span>
<span id="cb36-557"><a href="#cb36-557" aria-hidden="true" tabindex="-1"></a>wuni<span class="ot">=</span><span class="fu">UniFrac</span>(normalized_phyloseq, <span class="at">weighted=</span>T) <span class="co">#calculo de distancias</span></span>
<span id="cb36-558"><a href="#cb36-558" aria-hidden="true" tabindex="-1"></a>adonis_wuni<span class="ot">=</span><span class="fu">adonis2</span>(wuni<span class="sc">~</span>status, <span class="at">data=</span>mt_pruned, <span class="at">permutations =</span> <span class="dv">9999</span>)<span class="co">#test PERMANOVA con distancia Weighted UniFrac. Permutaciones = iteraciones, cuantas más pongamos, más afinaremos el pvalor real. Por tradición: 9999</span></span>
<span id="cb36-559"><a href="#cb36-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-560"><a href="#cb36-560" aria-hidden="true" tabindex="-1"></a>adonis_OmegaSq <span class="ot">=</span> <span class="cf">function</span>(adonisOutput, <span class="at">partial =</span> <span class="cn">TRUE</span>){</span>
<span id="cb36-561"><a href="#cb36-561" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">is</span>(adonisOutput, <span class="st">"adonis"</span>) <span class="sc">||</span> <span class="fu">is</span>(adonisOutput, <span class="st">"anova.cca"</span>)))</span>
<span id="cb36-562"><a href="#cb36-562" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Input should be an adonis object"</span>)</span>
<span id="cb36-563"><a href="#cb36-563" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is</span>(adonisOutput, <span class="st">"anova.cca"</span>)) {</span>
<span id="cb36-564"><a href="#cb36-564" aria-hidden="true" tabindex="-1"></a>    aov_tab <span class="ot">&lt;-</span> adonisOutput</span>
<span id="cb36-565"><a href="#cb36-565" aria-hidden="true" tabindex="-1"></a>    aov_tab<span class="sc">$</span>MeanSqs <span class="ot">&lt;-</span> aov_tab<span class="sc">$</span>SumOfSqs <span class="sc">/</span> aov_tab<span class="sc">$</span>Df</span>
<span id="cb36-566"><a href="#cb36-566" aria-hidden="true" tabindex="-1"></a>    aov_tab<span class="sc">$</span>MeanSqs[<span class="fu">length</span>(aov_tab<span class="sc">$</span>Df)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb36-567"><a href="#cb36-567" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb36-568"><a href="#cb36-568" aria-hidden="true" tabindex="-1"></a>    aov_tab <span class="ot">&lt;-</span> adonisOutput<span class="sc">$</span>aov.tab</span>
<span id="cb36-569"><a href="#cb36-569" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-570"><a href="#cb36-570" aria-hidden="true" tabindex="-1"></a>  heading <span class="ot">&lt;-</span> <span class="fu">attr</span>(aov_tab, <span class="st">"heading"</span>)</span>
<span id="cb36-571"><a href="#cb36-571" aria-hidden="true" tabindex="-1"></a>  MS_res <span class="ot">&lt;-</span> aov_tab[<span class="fu">pmatch</span>(<span class="st">"Residual"</span>, <span class="fu">rownames</span>(aov_tab)), <span class="st">"MeanSqs"</span>]</span>
<span id="cb36-572"><a href="#cb36-572" aria-hidden="true" tabindex="-1"></a>  SS_tot <span class="ot">&lt;-</span> aov_tab[<span class="fu">rownames</span>(aov_tab) <span class="sc">==</span> <span class="st">"Total"</span>, <span class="st">"SumsOfSqs"</span>]</span>
<span id="cb36-573"><a href="#cb36-573" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> aov_tab[<span class="fu">rownames</span>(aov_tab) <span class="sc">==</span> <span class="st">"Total"</span>, <span class="st">"Df"</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb36-574"><a href="#cb36-574" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(partial){</span>
<span id="cb36-575"><a href="#cb36-575" aria-hidden="true" tabindex="-1"></a>    omega <span class="ot">&lt;-</span> <span class="fu">apply</span>(aov_tab, <span class="dv">1</span>, <span class="cf">function</span>(x) (x[<span class="st">"Df"</span>]<span class="sc">*</span>(x[<span class="st">"MeanSqs"</span>]<span class="sc">-</span>MS_res))<span class="sc">/</span>(x[<span class="st">"Df"</span>]<span class="sc">*</span>x[<span class="st">"MeanSqs"</span>]<span class="sc">+</span>(N<span class="sc">-</span>x[<span class="st">"Df"</span>])<span class="sc">*</span>MS_res))</span>
<span id="cb36-576"><a href="#cb36-576" aria-hidden="true" tabindex="-1"></a>    aov_tab<span class="sc">$</span>parOmegaSq <span class="ot">&lt;-</span> <span class="fu">c</span>(omega[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(omega)<span class="sc">-</span><span class="dv">2</span>)], <span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="cb36-577"><a href="#cb36-577" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb36-578"><a href="#cb36-578" aria-hidden="true" tabindex="-1"></a>    omega <span class="ot">&lt;-</span> <span class="fu">apply</span>(aov_tab, <span class="dv">1</span>, <span class="cf">function</span>(x) (x[<span class="st">"SumsOfSqs"</span>]<span class="sc">-</span>x[<span class="st">"Df"</span>]<span class="sc">*</span>MS_res)<span class="sc">/</span>(SS_tot<span class="sc">+</span>MS_res))</span>
<span id="cb36-579"><a href="#cb36-579" aria-hidden="true" tabindex="-1"></a>    aov_tab<span class="sc">$</span>OmegaSq <span class="ot">&lt;-</span> <span class="fu">c</span>(omega[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(omega)<span class="sc">-</span><span class="dv">2</span>)], <span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="cb36-580"><a href="#cb36-580" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-581"><a href="#cb36-581" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is</span>(adonisOutput, <span class="st">"adonis"</span>))</span>
<span id="cb36-582"><a href="#cb36-582" aria-hidden="true" tabindex="-1"></a>    cn_order <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Df"</span>, <span class="st">"SumsOfSqs"</span>, <span class="st">"MeanSqs"</span>, <span class="st">"F.Model"</span>, <span class="st">"R2"</span>,</span>
<span id="cb36-583"><a href="#cb36-583" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> (partial) <span class="st">"parOmegaSq"</span> <span class="cf">else</span> <span class="st">"OmegaSq"</span>, <span class="st">"Pr(&gt;F)"</span>)</span>
<span id="cb36-584"><a href="#cb36-584" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb36-585"><a href="#cb36-585" aria-hidden="true" tabindex="-1"></a>    cn_order <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Df"</span>, <span class="st">"SumOfSqs"</span>, <span class="st">"F"</span>, <span class="cf">if</span> (partial) <span class="st">"parOmegaSq"</span> <span class="cf">else</span> <span class="st">"OmegaSq"</span>,</span>
<span id="cb36-586"><a href="#cb36-586" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Pr(&gt;F)"</span>)</span>
<span id="cb36-587"><a href="#cb36-587" aria-hidden="true" tabindex="-1"></a>  aov_tab <span class="ot">&lt;-</span> aov_tab[, cn_order]</span>
<span id="cb36-588"><a href="#cb36-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(aov_tab, <span class="st">"names"</span>) <span class="ot">&lt;-</span> cn_order</span>
<span id="cb36-589"><a href="#cb36-589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(aov_tab, <span class="st">"heading"</span>) <span class="ot">&lt;-</span> heading</span>
<span id="cb36-590"><a href="#cb36-590" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is</span>(adonisOutput, <span class="st">"adonis"</span>))</span>
<span id="cb36-591"><a href="#cb36-591" aria-hidden="true" tabindex="-1"></a>    adonisOutput<span class="sc">$</span>aov.tab <span class="ot">&lt;-</span> aov_tab</span>
<span id="cb36-592"><a href="#cb36-592" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb36-593"><a href="#cb36-593" aria-hidden="true" tabindex="-1"></a>    adonisOutput <span class="ot">&lt;-</span> aov_tab</span>
<span id="cb36-594"><a href="#cb36-594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(adonisOutput)</span>
<span id="cb36-595"><a href="#cb36-595" aria-hidden="true" tabindex="-1"></a>}<span class="co">#cargamos esta función, desarrollada por otros usuarios de R</span></span>
<span id="cb36-596"><a href="#cb36-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-597"><a href="#cb36-597" aria-hidden="true" tabindex="-1"></a>adonis_wuni_eff<span class="ot">=</span><span class="fu">adonis_OmegaSq</span>(adonis_wuni)<span class="co">#apliquemos la funcion sobre el PERMANOVA basado exclusivamente en Weighted UniFrac</span></span>
<span id="cb36-598"><a href="#cb36-598" aria-hidden="true" tabindex="-1"></a>adonis_wuni_eff<span class="co">#vemos que es exactamente igual que el objeto 'adonis_wuni', pero incluyendo una columna 'parOmegaSq', que es el término Partial Omega Square, es decir, el tamaño del efecto.</span></span>
<span id="cb36-599"><a href="#cb36-599" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-600"><a href="#cb36-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-601"><a href="#cb36-601" aria-hidden="true" tabindex="-1"></a>El valor de omega es &gt; 0.6, por lo podríamos considerar moderado-grande.</span>
<span id="cb36-602"><a href="#cb36-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-603"><a href="#cb36-603" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7.3 Graficos</span></span>
<span id="cb36-604"><a href="#cb36-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-605"><a href="#cb36-605" aria-hidden="true" tabindex="-1"></a>Podemos representar las diferencias detectadas en el PERMANOVA, en el espacio multivariante. Para ello, necesitamos calcular gráficos de ordenación, entre ellos:</span>
<span id="cb36-606"><a href="#cb36-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-607"><a href="#cb36-607" aria-hidden="true" tabindex="-1"></a>-**PCoA**: *Principal Coordinates Analysis* o *Análisis de coordenadas principales*. Similar al PCA pero no está basado en distancias euclídeas. En síntesis, es una forma de distribuir las muestras en N dimensiones, y casi siempre N &gt; 2. La posición de las muestras en el especio estará determinada por vectores y escalares (pesos que tiene cada variable). Obtendremos, entre otros factores, el porcentaje de la varianza que representa cada eje.</span>
<span id="cb36-608"><a href="#cb36-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-609"><a href="#cb36-609" aria-hidden="true" tabindex="-1"></a>-**NMDS**: *Non-Metric MultiDiomensional Scale* o *Escalamiento multidimensional no-métrico*: en este caso forzamos a que la distribución de las muestras en el espacio sea solamente en dos dimensiones. Puesto que trabajamos con datos multidimensionales, al forzar la distribución solo en dos coordenadas, el algoritmo estará generando un estrés. Se considera que cuando el estrés es &gt; 0.2, el gráfico ya no es representativo de la realidad.</span>
<span id="cb36-610"><a href="#cb36-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-611"><a href="#cb36-611" aria-hidden="true" tabindex="-1"></a>Para decidir cuál es más adecuado, una buena estrategia es analizar el valor de la varianza explicada por la suma de las dos dimensiones que nos interese considerar, y el valor del estrés del NMDS. Además, es interesante visualizar ambos gráficos, y quedarnos con aquel que resulte en mejores parámetros, y que mejor represente las diferencias observadas.</span>
<span id="cb36-612"><a href="#cb36-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-613"><a href="#cb36-613" aria-hidden="true" tabindex="-1"></a>Calculemos los parámetros mencionados:</span>
<span id="cb36-614"><a href="#cb36-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-617"><a href="#cb36-617" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-618"><a href="#cb36-618" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculo del estrés del NMDS:</span></span>
<span id="cb36-619"><a href="#cb36-619" aria-hidden="true" tabindex="-1"></a>NMDS <span class="ot">=</span> <span class="fu">ordinate</span>(normalized_phyloseq, <span class="st">"NMDS"</span>, <span class="st">"wuni"</span>)<span class="co">#calcula la ordenacion. Argumentos: objeto phyloseq normalizado, tipo de ordenacion (PCoA o NMDS, distancia)</span></span>
<span id="cb36-620"><a href="#cb36-620" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"The stress of the NMDS based on Weighted UniFrac is:"</span>, NMDS<span class="sc">$</span>stress))</span>
<span id="cb36-621"><a href="#cb36-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-622"><a href="#cb36-622" aria-hidden="true" tabindex="-1"></a><span class="co">#Varianza y multidimensionalidad del PCoA:</span></span>
<span id="cb36-623"><a href="#cb36-623" aria-hidden="true" tabindex="-1"></a>PCOA <span class="ot">=</span> <span class="fu">ordinate</span>(normalized_phyloseq, <span class="st">"PCoA"</span>, <span class="st">"wuni"</span>)</span>
<span id="cb36-624"><a href="#cb36-624" aria-hidden="true" tabindex="-1"></a>pesos<span class="ot">=</span>PCOA<span class="sc">$</span>values<span class="sc">$</span>Relative_eig[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="co">#varianza explicada por los dos primeros ejes. Podemos indicarle todos los ejes que queramos, teniendo en cuenta que el peso de los ejes estará ordenado de forma descendiente</span></span>
<span id="cb36-625"><a href="#cb36-625" aria-hidden="true" tabindex="-1"></a>pesos </span>
<span id="cb36-626"><a href="#cb36-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-627"><a href="#cb36-627" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(PCOA<span class="sc">$</span>values<span class="sc">$</span>Relative_eig[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])<span class="co">#Con esto vemos lo que explican los 10 primeros ejes</span></span>
<span id="cb36-628"><a href="#cb36-628" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(PCOA<span class="sc">$</span>values<span class="sc">$</span>Relative_eig) <span class="co">#nos dice el número total de dimensiones que necesitaríamos para explicar el 100% de la varianza.</span></span>
<span id="cb36-629"><a href="#cb36-629" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-630"><a href="#cb36-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-631"><a href="#cb36-631" aria-hidden="true" tabindex="-1"></a>Ahora haremos los dos gráficos. Se representa solo uno de ellos, por ejemplo, el PCoA:</span>
<span id="cb36-632"><a href="#cb36-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-635"><a href="#cb36-635" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-636"><a href="#cb36-636" aria-hidden="true" tabindex="-1"></a>pcoa <span class="ot">=</span> <span class="fu">plot_ordination</span>(normalized_phyloseq, PCOA,<span class="at">type=</span> <span class="st">"samples"</span>, <span class="at">color=</span> <span class="st">"status"</span>)<span class="sc">+</span><span class="co">#podriamos incluso representar cada grupo de muestras con una forma</span></span>
<span id="cb36-637"><a href="#cb36-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">4</span>, <span class="at">size =</span> <span class="fl">4.5</span>)<span class="sc">+</span></span>
<span id="cb36-638"><a href="#cb36-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="fu">paste0</span>(<span class="st">"Axis 1 ("</span>,<span class="fu">round</span>(pesos[<span class="dv">1</span>]<span class="sc">*</span><span class="dv">100</span>,<span class="at">digits =</span> <span class="dv">2</span>),<span class="st">"%)"</span>), </span>
<span id="cb36-639"><a href="#cb36-639" aria-hidden="true" tabindex="-1"></a>       <span class="at">y=</span><span class="fu">paste0</span>(<span class="st">"Axis 2 ("</span>,<span class="fu">round</span>(pesos[<span class="dv">2</span>]<span class="sc">*</span><span class="dv">100</span>,<span class="at">digits =</span> <span class="dv">2</span>),<span class="st">"%)"</span>),</span>
<span id="cb36-640"><a href="#cb36-640" aria-hidden="true" tabindex="-1"></a>       <span class="at">color=</span><span class="st">"status"</span>)<span class="sc">+</span></span>
<span id="cb36-641"><a href="#cb36-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"healthy"</span><span class="ot">=</span><span class="st">"green"</span>,<span class="st">"diseased"</span><span class="ot">=</span><span class="st">"black"</span>),</span>
<span id="cb36-642"><a href="#cb36-642" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks=</span><span class="fu">c</span>(<span class="st">"healthy"</span>, <span class="st">"diseased"</span>),</span>
<span id="cb36-643"><a href="#cb36-643" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>, <span class="st">"Symptomatic"</span>))<span class="sc">+</span></span>
<span id="cb36-644"><a href="#cb36-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb36-645"><a href="#cb36-645" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key=</span><span class="fu">element_blank</span>(),</span>
<span id="cb36-646"><a href="#cb36-646" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title.align =</span> <span class="dv">0</span>,</span>
<span id="cb36-647"><a href="#cb36-647" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>,<span class="at">size=</span><span class="dv">18</span>),</span>
<span id="cb36-648"><a href="#cb36-648" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text.align =</span> <span class="dv">0</span>,</span>
<span id="cb36-649"><a href="#cb36-649" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">18</span>),</span>
<span id="cb36-650"><a href="#cb36-650" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb36-651"><a href="#cb36-651" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>,<span class="at">size=</span><span class="dv">18</span>),</span>
<span id="cb36-652"><a href="#cb36-652" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>))<span class="sc">+</span></span>
<span id="cb36-653"><a href="#cb36-653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="fl">0.00</span>)), <span class="at">lty=</span><span class="dv">2</span>, <span class="at">colour=</span><span class="st">"grey"</span>)<span class="sc">+</span></span>
<span id="cb36-654"><a href="#cb36-654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="fl">0.00</span>)), <span class="at">lty=</span><span class="dv">2</span>, <span class="at">colour=</span><span class="st">"grey"</span>)<span class="sc">+</span></span>
<span id="cb36-655"><a href="#cb36-655" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Endosphere</span><span class="sc">\n</span><span class="st">PCoA on Weighted-UniFrac distance"</span>)</span>
<span id="cb36-656"><a href="#cb36-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-657"><a href="#cb36-657" aria-hidden="true" tabindex="-1"></a><span class="fu">x11</span>()  </span>
<span id="cb36-658"><a href="#cb36-658" aria-hidden="true" tabindex="-1"></a>pcoa</span>
<span id="cb36-659"><a href="#cb36-659" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-660"><a href="#cb36-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-661"><a href="#cb36-661" aria-hidden="true" tabindex="-1"></a>En la Figura 6 podemos observar el resultado. Vemos que, tal y como nos demostró el PERMANOVA, la comunidad bacteriana de árboles sanos y enfermos difiere entre sí</span>
<span id="cb36-662"><a href="#cb36-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-663"><a href="#cb36-663" aria-hidden="true" tabindex="-1"></a><span class="al">![Figura 6. PCoA basado en distancias Wighted-UniFrac.](images/pcoa.jpeg)</span></span>
<span id="cb36-664"><a href="#cb36-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-665"><a href="#cb36-665" aria-hidden="true" tabindex="-1"></a>Ejercicio: obtener el gráfico NMDS. Debe tenerse en cuenta que se debe indicar el estrés del mismo.</span>
<span id="cb36-666"><a href="#cb36-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-667"><a href="#cb36-667" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb36-668"><a href="#cb36-668" aria-hidden="true" tabindex="-1"></a>Si se desean obtener todos los gráficos (PCoA, NMDS) basados en todas las distancias, se puede usar el código de micro4all descrito aquí: https://nuriamw.github.io/micro4all/tutorial/package_workflow.html#beta-diversity-analysis</span>
<span id="cb36-669"><a href="#cb36-669" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb36-670"><a href="#cb36-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-671"><a href="#cb36-671" aria-hidden="true" tabindex="-1"></a><span class="fu"># 8. Perfiles taxonómicos</span></span>
<span id="cb36-672"><a href="#cb36-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-673"><a href="#cb36-673" aria-hidden="true" tabindex="-1"></a>Además de la diversidad, es necesario conocer qué microorganismos componen las muestras y cuál es su abundancia relativa. Para ello, utilizaremos los **datos NO normalizados**. Se pueden emplear los normalizados, pero entonces, deben interpretarse los datos normalizados.</span>
<span id="cb36-674"><a href="#cb36-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-675"><a href="#cb36-675" aria-hidden="true" tabindex="-1"></a><span class="fu">## 8.1 Obtención de abundancia relativa</span></span>
<span id="cb36-676"><a href="#cb36-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-677"><a href="#cb36-677" aria-hidden="true" tabindex="-1"></a>Calculemos la abundancia relativa de todos los ASVs de todas las muestras:</span>
<span id="cb36-678"><a href="#cb36-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-681"><a href="#cb36-681" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-682"><a href="#cb36-682" aria-hidden="true" tabindex="-1"></a>phy_relabun<span class="ot">=</span><span class="fu">transform_sample_counts</span>(phy_pruned, <span class="cf">function</span>(x){x<span class="sc">/</span><span class="fu">sum</span>(x)}<span class="sc">*</span><span class="dv">100</span>)</span>
<span id="cb36-683"><a href="#cb36-683" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-684"><a href="#cb36-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-685"><a href="#cb36-685" aria-hidden="true" tabindex="-1"></a><span class="fu">## 8.2 Aglomeración al rango taxonómico de estudio</span></span>
<span id="cb36-686"><a href="#cb36-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-687"><a href="#cb36-687" aria-hidden="true" tabindex="-1"></a>Pero, ¿con qué nivel taxonómico queremos trabajar? La respuesta a esta pregunta depende del diseño experimental y la pregunta científica. Si queremos simplemente hacer un análisis exploratorio, podríamos obtener una visión una visión general analizando los *phyla*, y una visión detallada analizando los géneros. Por tanto, debemos primero aglomerar los datos al rango taxonómico deseado.</span>
<span id="cb36-688"><a href="#cb36-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-691"><a href="#cb36-691" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-692"><a href="#cb36-692" aria-hidden="true" tabindex="-1"></a><span class="co">#Phylum</span></span>
<span id="cb36-693"><a href="#cb36-693" aria-hidden="true" tabindex="-1"></a>phylum_relabun<span class="ot">=</span><span class="fu">tax_glom</span>(phy_relabun, <span class="at">taxrank =</span> <span class="st">"Phylum"</span>)<span class="co">#colapsamos el objeto phyloseq al rango indicago</span></span>
<span id="cb36-694"><a href="#cb36-694" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">otu_table</span>(phylum_relabun)) <span class="co">#comprobamos que la suma de la abundancia relativa de cada phylum equivale a 100%</span></span>
<span id="cb36-695"><a href="#cb36-695" aria-hidden="true" tabindex="-1"></a><span class="co">#Género</span></span>
<span id="cb36-696"><a href="#cb36-696" aria-hidden="true" tabindex="-1"></a>genus_relabun<span class="ot">=</span><span class="fu">tax_glom</span>(phy_relabun, <span class="at">taxrank =</span> <span class="st">"Genus"</span>); <span class="fu">colSums</span>(<span class="fu">otu_table</span>(genus_relabun)) </span>
<span id="cb36-697"><a href="#cb36-697" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-698"><a href="#cb36-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-699"><a href="#cb36-699" aria-hidden="true" tabindex="-1"></a><span class="fu">## 8.3 Obtención de tablas exploratorias</span></span>
<span id="cb36-700"><a href="#cb36-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-701"><a href="#cb36-701" aria-hidden="true" tabindex="-1"></a>Obtengamos una tabla de abundancias relativas, donde tengamos la abundancia de cada taxón en cada grupo de muestras.</span>
<span id="cb36-702"><a href="#cb36-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-703"><a href="#cb36-703" aria-hidden="true" tabindex="-1"></a>Para los *phyla*</span>
<span id="cb36-704"><a href="#cb36-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-707"><a href="#cb36-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-708"><a href="#cb36-708" aria-hidden="true" tabindex="-1"></a><span class="co">#Phylum:</span></span>
<span id="cb36-709"><a href="#cb36-709" aria-hidden="true" tabindex="-1"></a>phylum_rel_df<span class="ot">=</span><span class="fu">as.data.frame</span>(<span class="fu">otu_table</span>(phylum_relabun))<span class="co">#extraemos la tabla de ocurrencias</span></span>
<span id="cb36-710"><a href="#cb36-710" aria-hidden="true" tabindex="-1"></a>phylum_rel_complete<span class="ot">=</span><span class="fu">cbind</span>(<span class="fu">tax_table</span>(phylum_relabun),phylum_rel_df)<span class="co">#unimos la tabla de taxonomia y la de ocurrencias</span></span>
<span id="cb36-711"><a href="#cb36-711" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">rownames</span>(phylum_rel_complete),<span class="fu">rownames</span>(phylum_rel_df))<span class="co">#comprobamos que sean identicos (tiene uqe salir por consola "TRUE")</span></span>
<span id="cb36-712"><a href="#cb36-712" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">"TAXA"</span><span class="ot">=</span><span class="fu">rownames</span>(phylum_rel_complete),phylum_rel_complete),<span class="at">file=</span><span class="st">"abundrel_phylum_porReplicas.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span>
<span id="cb36-713"><a href="#cb36-713" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-714"><a href="#cb36-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-717"><a href="#cb36-717" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-718"><a href="#cb36-718" aria-hidden="true" tabindex="-1"></a>table_phylum <span class="ot">=</span> <span class="fu">t</span>(phylum_rel_df)</span>
<span id="cb36-719"><a href="#cb36-719" aria-hidden="true" tabindex="-1"></a>tax_phylum<span class="ot">=</span><span class="fu">tax_table</span>(phylum_relabun)</span>
<span id="cb36-720"><a href="#cb36-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-721"><a href="#cb36-721" aria-hidden="true" tabindex="-1"></a>phylum_media<span class="ot">=</span><span class="fu">aggregate</span>(table_phylum, </span>
<span id="cb36-722"><a href="#cb36-722" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by=</span><span class="fu">list</span>(<span class="fu">as.data.frame</span>(<span class="fu">sample_data</span>(phylum_relabun))<span class="sc">$</span>status), <span class="at">FUN=</span>mean)<span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="st">"Group.1"</span>) <span class="sc">%&gt;%</span> <span class="fu">t</span>()</span>
<span id="cb36-723"><a href="#cb36-723" aria-hidden="true" tabindex="-1"></a><span class="co">#la funcion 'aggregate' dividide el conjunto de datos tal y como se le indique (aqui, en base al factor de agrupacion 'status'), y computa el estadistico que le indiquemos (aqui, la media primero y luego la desviacion estandar)</span></span>
<span id="cb36-724"><a href="#cb36-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-725"><a href="#cb36-725" aria-hidden="true" tabindex="-1"></a>phylum_sd <span class="ot">=</span> <span class="fu">aggregate</span>(table_phylum, </span>
<span id="cb36-726"><a href="#cb36-726" aria-hidden="true" tabindex="-1"></a>                           <span class="at">by=</span><span class="fu">list</span>(<span class="fu">as.data.frame</span>(<span class="fu">sample_data</span>(phylum_relabun))<span class="sc">$</span>status), <span class="at">FUN=</span>sd)<span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="st">"Group.1"</span>)  <span class="sc">%&gt;%</span> <span class="fu">t</span>()  <span class="sc">%&gt;%</span></span>
<span id="cb36-727"><a href="#cb36-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="at">.fn=</span> <span class="sc">~</span><span class="fu">paste0</span>(<span class="fu">colnames</span>(phylum_media), <span class="st">"_SD"</span>))</span>
<span id="cb36-728"><a href="#cb36-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-729"><a href="#cb36-729" aria-hidden="true" tabindex="-1"></a>phylum_media_sd<span class="ot">=</span><span class="fu">merge</span>(tax_phylum, phylum_media, <span class="at">by=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span><span class="fu">column_to_rownames</span>(<span class="st">"Row.names"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-730"><a href="#cb36-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(phylum_sd, <span class="at">by=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="st">"Row.names"</span>)</span>
<span id="cb36-731"><a href="#cb36-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-732"><a href="#cb36-732" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">"TAXA"</span><span class="ot">=</span><span class="fu">rownames</span>(phylum_media_sd),phylum_media_sd), <span class="at">file=</span><span class="st">"abundrel_media_sd_phylum.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span>
<span id="cb36-733"><a href="#cb36-733" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-734"><a href="#cb36-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-735"><a href="#cb36-735" aria-hidden="true" tabindex="-1"></a>Ejercicio: calcular las mismas tablas a nivel de género.</span>
<span id="cb36-736"><a href="#cb36-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-737"><a href="#cb36-737" aria-hidden="true" tabindex="-1"></a><span class="fu">## 8.4 Preparacion de datos para realizar los gráficos</span></span>
<span id="cb36-738"><a href="#cb36-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-739"><a href="#cb36-739" aria-hidden="true" tabindex="-1"></a>Se pueden hacer muchos tipos de gráficos, pero nosotros haremos gráficos de barras apiladas. Como en el caso de los géneros podemos tener un número muy grande de categorías, representaremos los mayoritarios (aquellos cuya abundancia se encuentre por encima de un umbral). Este umbral será definido por el usuario. Probemos con un 1%</span>
<span id="cb36-740"><a href="#cb36-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-743"><a href="#cb36-743" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-744"><a href="#cb36-744" aria-hidden="true" tabindex="-1"></a><span class="co">#para poder utilizar ggplo2, necesitamos que los datos estén 'melted', es decir, organizados en varias columnas: una que incluya el nombre de los phyla, otra que indique el grupo de muestras, y otra que incluya los valores de abundancia</span></span>
<span id="cb36-745"><a href="#cb36-745" aria-hidden="true" tabindex="-1"></a>phylum_data <span class="ot">=</span> phylum_media_sd</span>
<span id="cb36-746"><a href="#cb36-746" aria-hidden="true" tabindex="-1"></a>phylum_data<span class="ot">=</span> phylum_data[,<span class="dv">2</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb36-747"><a href="#cb36-747" aria-hidden="true" tabindex="-1"></a>phylum_data<span class="ot">=</span>phylum_data[,<span class="sc">-</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>)]</span>
<span id="cb36-748"><a href="#cb36-748" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="ot">=</span> phylum_data  <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="sc">!</span>Phylum, <span class="at">names_to=</span><span class="st">"status"</span>, <span class="at">values_to=</span><span class="st">"Abundance"</span>)                         </span>
<span id="cb36-749"><a href="#cb36-749" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb36-750"><a href="#cb36-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-751"><a href="#cb36-751" aria-hidden="true" tabindex="-1"></a>unclassified_phylum<span class="ot">=</span>phylum_media_melt[phylum_media_melt[,<span class="st">"Phylum"</span>] <span class="sc">==</span> <span class="st">"unclassified"</span>,] <span class="co">#retengo los unclassified para no eliminarlos aunque sean &lt;1%</span></span>
<span id="cb36-752"><a href="#cb36-752" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="ot">=</span>phylum_media_melt[phylum_media_melt[,<span class="st">"Phylum"</span>] <span class="sc">!=</span> <span class="st">"unclassified"</span>,] <span class="co">#eliminamos los unclass de la tabla madre para poder meter en el grupo &lt;1% a los minoritarios clasificados</span></span>
<span id="cb36-753"><a href="#cb36-753" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="sc">$</span>Phylum[phylum_media_melt<span class="sc">$</span>Abundance <span class="sc">&lt;=</span> <span class="fl">1.0</span>] <span class="ot">=</span> <span class="st">"Other phyla (&lt;1%)"</span> <span class="co">#agrupar como "Other phyla" todos aquellos que tengan menos de un 1% de abund rel</span></span>
<span id="cb36-754"><a href="#cb36-754" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="sc">$</span>Phylum<span class="ot">=</span><span class="fu">as.factor</span>(phylum_media_melt<span class="sc">$</span>Phylum)<span class="co">#necesitamos que la variable 'Phylum' sea un factor, no de tipo caracter</span></span>
<span id="cb36-755"><a href="#cb36-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-756"><a href="#cb36-756" aria-hidden="true" tabindex="-1"></a><span class="co">#en este dataset y para el nivel de Phylum, no tenemos unclassified, por lo que a partir de ahora, no los incluiremos para evitar distorsiones. Se deja el código a disposición, puesto que será útil para el caso de los géneros</span></span>
<span id="cb36-757"><a href="#cb36-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-758"><a href="#cb36-758" aria-hidden="true" tabindex="-1"></a><span class="co">#guardamos los "Other phyla" en una nueva variable, para poder quitarlos de la tabla original.</span></span>
<span id="cb36-759"><a href="#cb36-759" aria-hidden="true" tabindex="-1"></a>others_phylum<span class="ot">=</span>phylum_media_melt[phylum_media_melt[,<span class="st">"Phylum"</span>] <span class="sc">==</span> <span class="st">"Other phyla (&lt;1%)"</span>,]</span>
<span id="cb36-760"><a href="#cb36-760" aria-hidden="true" tabindex="-1"></a>phylum_media_melt<span class="ot">=</span>phylum_media_melt[phylum_media_melt[,<span class="st">"Phylum"</span>] <span class="sc">!=</span> <span class="st">"Other phyla (&lt;1%)"</span>,]<span class="co">#los quitamos de la tabla original</span></span>
<span id="cb36-761"><a href="#cb36-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-762"><a href="#cb36-762" aria-hidden="true" tabindex="-1"></a>ordenado_phylum<span class="ot">=</span><span class="fu">as.data.frame</span>(phylum_media_melt[<span class="fu">order</span>(phylum_media_melt<span class="sc">$</span>Abundance, <span class="at">decreasing=</span>T),]) <span class="co">#ordenamos por abundancia relativa</span></span>
<span id="cb36-763"><a href="#cb36-763" aria-hidden="true" tabindex="-1"></a>plot_phylum_input<span class="ot">=</span><span class="fu">rbind</span>(ordenado_phylum,others_phylum)<span class="co">#a la tabla ordenada le metemos los "Other phyla" (y los "unclassified" cuando proceda)</span></span>
<span id="cb36-764"><a href="#cb36-764" aria-hidden="true" tabindex="-1"></a><span class="co">#es recomendable visualizar cómo ha quedado la tabla, y comporbar la posición de los unclassified (si es que tenemos alguno) y del grupo artificial 'Other phyla'</span></span>
<span id="cb36-765"><a href="#cb36-765" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-766"><a href="#cb36-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-767"><a href="#cb36-767" aria-hidden="true" tabindex="-1"></a>Preparemos ahora las cuestiones estéticas del gráfico</span>
<span id="cb36-768"><a href="#cb36-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-771"><a href="#cb36-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-772"><a href="#cb36-772" aria-hidden="true" tabindex="-1"></a>group_label<span class="ot">=</span><span class="fu">c</span>(<span class="st">"Asymptomatic"</span>,<span class="st">"Symptomatic"</span>)</span>
<span id="cb36-773"><a href="#cb36-773" aria-hidden="true" tabindex="-1"></a>breaks<span class="ot">=</span><span class="fu">c</span>(<span class="st">"healthy"</span>,<span class="st">"diseased"</span>)</span>
<span id="cb36-774"><a href="#cb36-774" aria-hidden="true" tabindex="-1"></a>phyl_name_ordered<span class="ot">=</span><span class="fu">as.vector</span>(plot_phylum_input<span class="sc">$</span>Phylum)</span>
<span id="cb36-775"><a href="#cb36-775" aria-hidden="true" tabindex="-1"></a>nombres_unicos_phylum<span class="ot">=</span><span class="fu">unique</span>(phyl_name_ordered)<span class="co">#nos quedamos con los nombres UNICOS, porque hay algunos phyla repetidos ("Other phyla")</span></span>
<span id="cb36-776"><a href="#cb36-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-777"><a href="#cb36-777" aria-hidden="true" tabindex="-1"></a>plot_phylum_input<span class="sc">$</span>Phylum<span class="ot">=</span><span class="fu">reorder.factor</span>(plot_phylum_input<span class="sc">$</span>Phylum,<span class="at">new.order=</span><span class="fu">rev</span>(nombres_unicos_phylum))<span class="co">#ordenamos los phyla como nosotros queremos.</span></span>
<span id="cb36-778"><a href="#cb36-778" aria-hidden="true" tabindex="-1"></a>lab_unicos_phylum<span class="ot">=</span>nombres_unicos_phylum <span class="co">#esto es para hacer la leyenda del grafico</span></span>
<span id="cb36-779"><a href="#cb36-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-780"><a href="#cb36-780" aria-hidden="true" tabindex="-1"></a>sorted_labels_ggplot <span class="ot">=</span><span class="fu">sapply</span>(lab_unicos_phylum,</span>
<span id="cb36-781"><a href="#cb36-781" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">function</span>(x) <span class="cf">if</span> (x <span class="sc">==</span> <span class="st">"Other phyla (&lt;1%)"</span><span class="sc">|</span>x <span class="sc">==</span> <span class="st">"unclassified"</span><span class="sc">|</span>x <span class="sc">==</span> <span class="st">"Other genera (&lt;1%)"</span>)</span>
<span id="cb36-782"><a href="#cb36-782" aria-hidden="true" tabindex="-1"></a>                                    {<span class="fu">parse</span>(<span class="at">text=</span><span class="fu">paste0</span>(<span class="st">"'"</span>, <span class="fu">as.character</span>(x), <span class="st">"'"</span>))} <span class="cf">else</span> {<span class="fu">parse</span>(<span class="at">text =</span> <span class="fu">paste0</span>(<span class="st">"italic('"</span>,<span class="fu">as.character</span>(x),<span class="st">"')"</span>))}) <span class="co">#esta funcion es para que me ponga en cursiva los nombre de los Phyla pero me deje en redonda los "Unclassified" y los "Other phyla"</span></span>
<span id="cb36-783"><a href="#cb36-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-784"><a href="#cb36-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-785"><a href="#cb36-785" aria-hidden="true" tabindex="-1"></a><span class="co">#Poner los colores en orden, segun el orden de nombres_unicos. Ej: Proteobacteria (la mas abun) = #0099FF</span></span>
<span id="cb36-786"><a href="#cb36-786" aria-hidden="true" tabindex="-1"></a><span class="co">#OJO! Tener cuidado  de que hay tantos colores como phyla:</span></span>
<span id="cb36-787"><a href="#cb36-787" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(lab_unicos_phylum)</span>
<span id="cb36-788"><a href="#cb36-788" aria-hidden="true" tabindex="-1"></a>colores_phylum <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"#0099FF"</span>,<span class="st">"#00CC00"</span>,<span class="st">"magenta"</span>,<span class="st">"yellow"</span>,<span class="st">"purple"</span>,<span class="st">"grey"</span>, <span class="st">"black"</span>)</span>
<span id="cb36-789"><a href="#cb36-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-790"><a href="#cb36-790" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(lab_unicos_phylum)<span class="sc">==</span><span class="fu">length</span>(colores_phylum) <span class="co">#si FALSE, añadir/quitar colores</span></span>
<span id="cb36-791"><a href="#cb36-791" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(lab_unicos_phylum)</span>
<span id="cb36-792"><a href="#cb36-792" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(colores_phylum)</span>
<span id="cb36-793"><a href="#cb36-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-794"><a href="#cb36-794" aria-hidden="true" tabindex="-1"></a>titulo_plot_phylum<span class="ot">=</span><span class="st">"Endosphere, main phyla"</span></span>
<span id="cb36-795"><a href="#cb36-795" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-796"><a href="#cb36-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-797"><a href="#cb36-797" aria-hidden="true" tabindex="-1"></a><span class="fu">## 8.5. Elaboración del gráfico</span></span>
<span id="cb36-798"><a href="#cb36-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-801"><a href="#cb36-801" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-802"><a href="#cb36-802" aria-hidden="true" tabindex="-1"></a>phylum_bar<span class="ot">=</span><span class="fu">ggplot</span>(plot_phylum_input, <span class="fu">aes</span>(<span class="at">x=</span>status, <span class="at">y=</span>Abundance, <span class="at">fill=</span>Phylum, <span class="at">order=</span>Phylum)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">position=</span><span class="st">"stack"</span>)<span class="sc">+</span></span>
<span id="cb36-803"><a href="#cb36-803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span>colores_phylum,</span>
<span id="cb36-804"><a href="#cb36-804" aria-hidden="true" tabindex="-1"></a>                    <span class="at">labels=</span>sorted_labels_ggplot,</span>
<span id="cb36-805"><a href="#cb36-805" aria-hidden="true" tabindex="-1"></a>                    <span class="at">breaks=</span>nombres_unicos_phylum)<span class="sc">+</span></span>
<span id="cb36-806"><a href="#cb36-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Mean relative abundance (%)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">fill=</span><span class="st">"Phylum"</span>,<span class="at">title=</span>titulo_plot_phylum)<span class="sc">+</span></span>
<span id="cb36-807"><a href="#cb36-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>))<span class="sc">+</span><span class="co">#sirve para cambiar el orden de la leyenda</span></span>
<span id="cb36-808"><a href="#cb36-808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">limits=</span>breaks,<span class="at">labels=</span>group_label,</span>
<span id="cb36-809"><a href="#cb36-809" aria-hidden="true" tabindex="-1"></a>                   <span class="at">breaks=</span>breaks)<span class="sc">+</span></span>
<span id="cb36-810"><a href="#cb36-810" aria-hidden="true" tabindex="-1"></a>  <span class="co">#scale_y_continuous(expand=c(0.01,0.01),</span></span>
<span id="cb36-811"><a href="#cb36-811" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                   breaks=c(0,10,20,30,40,50,60,70,80,90,100),</span></span>
<span id="cb36-812"><a href="#cb36-812" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                   labels=c("0","10", "20","30","40","50","60","70","80","90","100"),#podemos modificar la escala </span></span>
<span id="cb36-813"><a href="#cb36-813" aria-hidden="true" tabindex="-1"></a>   <span class="co">#                  limits = c(NA, 100))+</span></span>
<span id="cb36-814"><a href="#cb36-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb36-815"><a href="#cb36-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour=</span><span class="st">"black"</span>))<span class="sc">+</span></span>
<span id="cb36-816"><a href="#cb36-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x=</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb36-817"><a href="#cb36-817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">7</span>))<span class="sc">+</span></span>
<span id="cb36-818"><a href="#cb36-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))<span class="sc">+</span></span>
<span id="cb36-819"><a href="#cb36-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>, <span class="at">size=</span><span class="dv">5</span>))<span class="sc">+</span></span>
<span id="cb36-820"><a href="#cb36-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>))<span class="sc">+</span></span>
<span id="cb36-821"><a href="#cb36-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>))<span class="sc">+</span></span>
<span id="cb36-822"><a href="#cb36-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))<span class="sc">+</span></span>
<span id="cb36-823"><a href="#cb36-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>, <span class="at">face=</span><span class="st">"bold"</span>))<span class="sc">+</span></span>
<span id="cb36-824"><a href="#cb36-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title.align=</span><span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb36-825"><a href="#cb36-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.text.align =</span> <span class="dv">0</span>)<span class="sc">+</span><span class="co">#al poner "expresion" para poner la cursiva parcial en leyenda, te cambia la alineacion, esto es para que quede alineada a la izda</span></span>
<span id="cb36-826"><a href="#cb36-826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb36-827"><a href="#cb36-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-828"><a href="#cb36-828" aria-hidden="true" tabindex="-1"></a><span class="fu">x11</span>()</span>
<span id="cb36-829"><a href="#cb36-829" aria-hidden="true" tabindex="-1"></a>phylum_bar</span>
<span id="cb36-830"><a href="#cb36-830" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Phylum_barrasapiladas.jpg"</span>, phylum_bar,<span class="at">width =</span> <span class="dv">80</span>, <span class="at">height =</span> <span class="dv">60</span>, <span class="at">units =</span> <span class="st">"mm"</span>, <span class="at">dpi =</span> <span class="dv">800</span> )</span>
<span id="cb36-831"><a href="#cb36-831" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-832"><a href="#cb36-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-833"><a href="#cb36-833" aria-hidden="true" tabindex="-1"></a>La Figura 7 nos revela la altísima abundancia relativa del Phylum Mycoplasmatota en el grupo de muestras relativas a los árboles enfermos</span>
<span id="cb36-834"><a href="#cb36-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-835"><a href="#cb36-835" aria-hidden="true" tabindex="-1"></a><span class="al">![Figura 7. Distribución de los principales *phyla*. El grupo artificial 'Other phyla (\&lt;1 %)' comprende aquellos *phyla* cuya abundancia promedio es inferior al 1% del total de secuencias](images/Phylum_barrasapiladas.jpg)</span></span>
<span id="cb36-836"><a href="#cb36-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-837"><a href="#cb36-837" aria-hidden="true" tabindex="-1"></a>¿Os atreveríais a hacer el mismo tipo de gráfico, pero a nivel de género? Nota: tened en cuenta que hay muchos más géneros que *phyla*, y que cada uno de ellos podría suponer un menor porcentaje de secuencias al ser un rango taxonómico más fino, más detallado. Así pues, es posible que el corte de abundancia de los géneros mayoritarios haya que subirlo, de lo contrario, tendremos muchas categorías (géneros) a colorear y puede ser difícil encontrar muchos colores diferentes y distinguiblees.</span>
<span id="cb36-838"><a href="#cb36-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-839"><a href="#cb36-839" aria-hidden="true" tabindex="-1"></a><span class="fu"># 9. Análisis de abundancia diferencial</span></span>
<span id="cb36-840"><a href="#cb36-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-841"><a href="#cb36-841" aria-hidden="true" tabindex="-1"></a>La beta diversidad ha demostrado que las comunidades bacterianas de ambos tipos de árboles son diferentes, pero, ¿qué taxones bacterianos son diferenteS?</span>
<span id="cb36-842"><a href="#cb36-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-843"><a href="#cb36-843" aria-hidden="true" tabindex="-1"></a>Para estimar aquellos microorganismos que presentan diferencias en su abundancia cuando se quieren comparar dos grupos de muestras, necesitamos aplicar un test estadístico.</span>
<span id="cb36-844"><a href="#cb36-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-845"><a href="#cb36-845" aria-hidden="true" tabindex="-1"></a>Puesto que se trata de **datos composicionales** (aquellos que representan la composición relativa de un conjunto; en total suman el 100%), no es apropiado aplicar test estadísticos univariantes a la abundancia de todos los taxones. En este curso, emplearemos la herramienta **ANCOM-BC** o *ANalysis of Compositions of Microbiomes with Bias Correction*. Podéis encontrar toda la información y matemática subyactente de este test <span class="co">[</span><span class="ot">aquí</span><span class="co">](https://doi.org/10.1038/s41467-020-17041-7 "Link al artículo")</span>.</span>
<span id="cb36-846"><a href="#cb36-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-847"><a href="#cb36-847" aria-hidden="true" tabindex="-1"></a>En síntesis, ANCOM-BC emplea los datos de abundancia **absoluta** y realiza una transformación logarítmica. Posteriormente realiza una corrección de los posibles sesgos cometidos a la hora de realizar el muestreo. Así pues, debemos emplear nuestros objetos phylose **sin normalizar**, y que las ocurrencias se encuentren expresadas en **número total de secuencias** (abundancia absoluta, sin relativizar).</span>
<span id="cb36-848"><a href="#cb36-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-851"><a href="#cb36-851" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-852"><a href="#cb36-852" aria-hidden="true" tabindex="-1"></a><span class="co">#A nivel de PHYLUM</span></span>
<span id="cb36-853"><a href="#cb36-853" aria-hidden="true" tabindex="-1"></a>ancom_phylum<span class="ot">=</span><span class="fu">ancombc2</span>(phy_pruned, <span class="at">tax_level=</span> <span class="st">"Phylum"</span>, <span class="at">p_adj_method=</span><span class="st">"holm"</span>,<span class="at">struc_zero=</span>T, <span class="at">fix_formula=</span><span class="st">"status"</span>, <span class="at">group=</span><span class="st">"status"</span>)</span>
<span id="cb36-854"><a href="#cb36-854" aria-hidden="true" tabindex="-1"></a>ancom_phylum_filt<span class="ot">=</span> ancom_phylum<span class="sc">$</span>res <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">"Intercept"</span>))</span>
<span id="cb36-855"><a href="#cb36-855" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">" "</span><span class="ot">=</span><span class="fu">rownames</span>(ancom_phylum_filt),ancom_phylum_filt),<span class="at">file=</span><span class="st">"ANCOMBC_Phylum.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span>
<span id="cb36-856"><a href="#cb36-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-857"><a href="#cb36-857" aria-hidden="true" tabindex="-1"></a><span class="co">#A nivel de GÉNERO</span></span>
<span id="cb36-858"><a href="#cb36-858" aria-hidden="true" tabindex="-1"></a>ancom_genero<span class="ot">=</span><span class="fu">ancombc2</span>(phy_pruned, <span class="at">tax_level=</span> <span class="st">"Genus"</span>, <span class="at">p_adj_method=</span><span class="st">"holm"</span>,<span class="at">struc_zero=</span>T, <span class="at">fix_formula=</span><span class="st">"status"</span>, <span class="at">group=</span><span class="st">"status"</span>)</span>
<span id="cb36-859"><a href="#cb36-859" aria-hidden="true" tabindex="-1"></a>ancom_genero_filt<span class="ot">=</span> ancom_genero<span class="sc">$</span>res <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">"Intercept"</span>))</span>
<span id="cb36-860"><a href="#cb36-860" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(<span class="fu">data.frame</span>(<span class="st">" "</span><span class="ot">=</span><span class="fu">rownames</span>(ancom_genero_filt),ancom_genero_filt),<span class="at">file=</span><span class="st">"ANCOMBC_Genero.txt"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,<span class="at">row.names =</span>F)</span>
<span id="cb36-861"><a href="#cb36-861" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-862"><a href="#cb36-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-863"><a href="#cb36-863" aria-hidden="true" tabindex="-1"></a>ANCOM-BC devuelve una lista de resultados muy completa, si bien todos ellos no nos será útiles/interesantes. Analicemos sucintamente el output:</span>
<span id="cb36-864"><a href="#cb36-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-865"><a href="#cb36-865" aria-hidden="true" tabindex="-1"></a>-**bias_correct_log_table**: dataframe con la abundancia transformada y corregida de los taxones.</span>
<span id="cb36-866"><a href="#cb36-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-867"><a href="#cb36-867" aria-hidden="true" tabindex="-1"></a>-**res**: es la tabla que contiene los resultados del test estadístico. A su vez, dentro de esta, se incluyen algunos parámetros tanto para nuestra comparación de interés (healthy vs. diseased) como para el valor de referencia (*Intercept*, valor estimado cuando todas las variables explicativas están en su valor de referencia). Nos centraremos solamente en los parámetros de nuestra comparación de interés:</span>
<span id="cb36-868"><a href="#cb36-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-869"><a href="#cb36-869" aria-hidden="true" tabindex="-1"></a>-**taxon**</span>
<span id="cb36-870"><a href="#cb36-870" aria-hidden="true" tabindex="-1"></a>-**lfc**: valor de log fold change (debemos primero tener en cuenta la dirección de la comparación: healthy vs. diseased o diseased vs. healthy, puesto que de ello dependerá el signo).</span>
<span id="cb36-871"><a href="#cb36-871" aria-hidden="true" tabindex="-1"></a>-**se**: error estándar de la comparación.</span>
<span id="cb36-872"><a href="#cb36-872" aria-hidden="true" tabindex="-1"></a>-**W**: (*omega*) tamaño del efecto.</span>
<span id="cb36-873"><a href="#cb36-873" aria-hidden="true" tabindex="-1"></a>-**p**: pvalor sin corrección de comparaciones múltiples.</span>
<span id="cb36-874"><a href="#cb36-874" aria-hidden="true" tabindex="-1"></a>-**q**: pvalor corregido con el método de corrección que hemos indicado.</span>
<span id="cb36-875"><a href="#cb36-875" aria-hidden="true" tabindex="-1"></a>-**diff**: si el taxón en estudio es estadísticamente significativo o no. Valor booleriano.</span>
<span id="cb36-876"><a href="#cb36-876" aria-hidden="true" tabindex="-1"></a>-**passed_ss**: si el taxón en estudio pasa o no el test de sensibilidad. ¡¡OJO!! Podemos tener taxones que resultan diferencialmente abundantes pero que **no** pasen este test. Debemos tratatarlos con cautela porque podría tratarse de falsos positivos.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>